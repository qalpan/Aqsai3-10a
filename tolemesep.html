<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –∂”ô–Ω–µ “ö–∞—Ä–∂—ã –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ (–®–æ—Ç—Ç–∞—Ä –¢“Ø–∑–µ—Ç—ñ–ª–¥—ñ)</title>
    <style>
        /* –ë–ê–°“ö–ê–†–£ –ü–ê–ù–ï–õ–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü */
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; color: #424242; }
        .admin-panel { max-width: 1500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; } 
        .btn { padding: 5px 10px; cursor: pointer; color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        .btn-orange { background: #fd7e14; }
        /* ”®—Ä—ñ—Å—Ç–µ—Ä */
        input[type="text"], input[type="date"], select, input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        
        /* –õ–ï–î–ñ–ï–† –ö–ï–°–¢–ï–°–Ü–ù–Ü“¢ –ñ–ê–õ–ü–´ –°–¢–ò–õ–Ü */
        #ledgerEditor table, #reportContainer table, #financeLedgerTable table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; min-width: 1000px; }
        #ledgerEditor th, #ledgerEditor td, #reportContainer th, #reportContainer td, #financeLedgerTable th, #financeLedgerTable td { border: 1px solid #ddd; padding: 4px; text-align: center; }
        #ledgerEditor th, #reportContainer th, #financeLedgerTable th { background: #f8f9fa; }
        
        /* –ñ–µ–∫–µ –ü”ô—Ç–µ—Ä –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ –°—Ç–∏–ª—ñ */
        .month-group-header { text-align: left; font-weight: bold;}
        .payment-row { background: #f0f0f0; } 
        .total-acc-row td { background: #ffe680; font-weight: normal; font-size: 9px; } 
        .total-col { background: #e9e9ff; } 
        .sub-col-header { background: #e9ecef; }
        .payment-input { width: 60px; }
        .payment-details-inline { display: flex; gap: 5px; justify-content: space-between; align-items: center; font-size: 9px; }
        .payment-details-input { width: 60px; }
        .payment-total-amount { font-size: 11px; font-weight: bold; }
        .action-buttons-inline { display: flex; flex-direction: column; gap: 3px; justify-content: center; align-items: center; height: 100%; padding: 2px 0; }
        .action-buttons-inline button { width: 100%; padding: 3px 5px; font-size: 10px; }
        .left-align { text-align: ; }
        
        /* “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ –°—Ç–∏–ª—ñ */
        .finance-header { background: #cce5ff; font-weight: bold; }
        .income-row { background: #d4edda; } 
        .expense-row { background: #f8d7da; } 
        .balance-row { background: #ffe080; font-weight: bold; } 
        .balance-row input { font-weight: bold; }
        .balance-row td:not(:first-child) { color: black; }
        .balance-row td:nth-child(2) input { font-size: 11px; }

        .finance-input { width: 80px; text-align: right; }
        .description-input { width: 95%; }
        .account-balance-cell { background: #e3f2fd; font-weight: bold; }
        .account-total-balance { background: #ffc107; color: #a3a3a3; font-size: 14px; }
        
        /* Custom Settings UI */
        .custom-settings-container { margin-top: 20px; padding: 10px; border: 1px dashed #007bff; border-radius: 5px; background: #f8faff; }
        .setting-group { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dotted #ccc; }
        .setting-group h4 { margin-top: 0; margin-bottom: 10px; color: #007bff; }
        .setting-entry { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .setting-entry label { font-weight: normal; }
        .setting-entry input, .setting-entry select { padding: 3px; border: 1px solid #ccc; width: 100px; }
        .setting-entry button { padding: 3px 5px; font-size: 10px; }

    </style>
</head>
<body onload="init()">

<div class="admin-panel">
    <h2>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –∂”ô–Ω–µ “ö–∞—Ä–∂—ã –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ</h2>

    <div class="controls" style="background: #e9ecef; padding: 10px; border-radius: 5px;">
        <label>–ü”ô—Ç–µ—Ä ‚Ññ:</label>
        <input type="text" id="aptInput" value="11" style="width: 60px;">
        <button class="btn btn-blue" onclick="loadApartment()">üîç –ö–µ—Å—Ç–µ–Ω—ñ –∫”©—Ä—Å–µ—Ç—É</button>
        
        <span style="border-left: 1px solid #999; margin: 0 15px; height: 30px;"></span>

        <button class="btn btn-green" onclick="downloadDataJSON()" style="font-size: 14px;">üíæ –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –°–∞“õ—Ç–∞—É (.json)</button> 
        
        <label for="uploadJson" class="btn btn-blue" style="cursor: pointer; font-size: 14px;">‚¨ÜÔ∏è –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –ñ“Ø–∫—Ç–µ—É (.json)</label>
        <input type="file" id="uploadJson" accept=".json" onchange="uploadDataJSON(event)" style="display:none;">

        <span style="border-left: 1px solid #999; margin: 0 15px; height: 30px;"></span>
        
        <button class="btn btn-orange" onclick="resetAllData()">‚ö†Ô∏è Reset (–¢–∞–∑–∞–ª–∞—É)</button>

        <span id="msg" style="color:green; margin-left:10px; font-weight: bold;"></span>
    </div>
    
    <hr style="margin-top: 30px;">
    
    <div id="financeLedger">
        <h3>üí∞ “ö–∞—Ä–∂—ã–ª—ã“õ –õ–µ–¥–∂–µ—Ä (–®–æ—Ç –ë–∞—Å“õ–∞—Ä—É)</h3>
        <div class="controls">
            <select id="transactionTypeSelect" style="padding: 5px;">
                <option value="income">–ö—ñ—Ä—ñ—Å (–¢“Ø—Å—Ç—ñ)</option>
                <option value="expense">–®—ã“ì—ã—Å (–¢”©–ª–µ–Ω–¥—ñ)</option>
            </select>
            <button class="btn btn-blue" onclick="addFinanceTransaction()">‚ûï –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “ö–æ—Å—É</button>
            <button class="btn btn-green" onclick="updateFinanceLedger(true)">‚úÖ “ö–∞—Ä–∂—ã–Ω—ã –¢—ñ—Ä–∫–µ—É</button>
            <button class="btn btn-red" onclick="downloadFinanceLedger()">üì• “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω –ñ“Ø–∫—Ç–µ—É</button> 
        </div>
        <div id="financeLedgerTable" style="overflow-x: auto;">
            <p>“ö–∞—Ä–∂—ã–ª—ã“õ –æ–ø–µ—Ä–∞—Ü–∏—è–ª–∞—Ä–¥—ã –∫”©—Ä—É “Ø—à—ñ–Ω "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “ö–æ—Å—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑.</p>
        </div>
    </div>
    <hr style="margin-top: 30px;">

    <div id="generalReport">
        <h3>üè† –ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø</h3>
        <div class="controls">
            <button class="btn btn-red" onclick="generateReport()">üìã –ï—Å–µ–ø—Ç—ñ “ö“±—Ä—É</button>
            <button class="btn btn-red" onclick="downloadGeneralReport()">üì• –ï—Å–µ–ø—Ç—ñ –ñ“Ø–∫—Ç–µ—É</button>
        </div>
        <div id="reportContainer" style="margin-top: 15px; overflow-x: auto;">
            <p>–ñ–∞–ª–ø—ã –µ—Å–µ–ø—Ç—ñ –∫”©—Ä—É “Ø—à—ñ–Ω "–ï—Å–µ–ø—Ç—ñ “ö“±—Ä—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑.</p>
        </div>
    </div>
    
    <hr>

    <div id="editor" style="display:none;">
        <h3 id="aptTitle"></h3>
        
        <div class="custom-settings-container" id="customSettingsEditor">
        </div>
        
        <div id="ledgerEditor" style="overflow-x: auto;">
        </div>
        
        <br>
        <button class="btn btn-green" onclick="updateLedger()">‚úÖ –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ —Ç—ñ—Ä–∫–µ—É (–°–∞“õ—Ç–∞—É)</button>
        <button class="btn btn-blue" onclick="downloadReceipt()">üì• –¢“Ø–±—ñ—Ä—Ç–µ–∫—Ç—ñ –∂“Ø–∫—Ç–µ—É</button>
    </div>
</div>

<script>
    // --- 1. –¢–ê–†–ò–§–¢–ï–† –ñ”ò–ù–ï –ö–û–ù–°–¢–ê–ù–¢–¢–ê–† ---
    const TARIFFS = { maint: 40, clean: 850, sec: 300, heat: 5, cap: 40 };
    const SERVICE_KEYS = ['maint', 'clean', 'sec', 'heat', 'cap'];
    const SERVICE_NAMES = { maint: '“Æ–π –∫“Ø—Ç—ñ–º—ñ', clean: '–¢–∞–∑–∞–ª—ã“õ', sec: '–ë–µ–π–Ω–µ–±–∞“õ—ã–ª–∞—É', heat: '–ñ—ã–ª—É –µ—Å–µ–ø.', cap: '–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥.' };
    const MONTHS_KK = ["“ö–∞“£—Ç–∞—Ä.–Ø–Ω–≤–∞—Ä—å", "–ê“õ–ø–∞–Ω", "–ù–∞—É—Ä—ã–∑", "–°”ô—É—ñ—Ä", "–ú–∞–º—ã—Ä", "–ú–∞—É—Å—ã–º", "–®—ñ–ª–¥–µ", "–¢–∞–º—ã–∑", "“ö—ã—Ä–∫“Ø–π–µ–∫", "“ö–∞–∑–∞–Ω", "“ö–∞—Ä–∞—à–∞", "–ñ–µ–ª—Ç–æ“õ—Å–∞–Ω"];
    const MONTHS_RU = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
    
    const COMMERCIAL_APTS = ['1', '15', '16']; 
    const COMMERCIAL_MAINT_RATE = 60; 
    
    // const ACCOUNTS = ['Kaspi', 'Halyk', 'Cash']; // –ê–ª—ã–Ω–¥—ã

    let apartments = [];
    let currentAptIndex = null;
    
    // “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ “õ“±—Ä—ã–ª—ã–º—ã ”©–∑–≥–µ—Ä—Ç—ñ–ª–¥—ñ: –µ–Ω–¥—ñ —Ç–µ–∫ –∂–∞–ª–ø—ã “õ–∞–ª–¥—ã“õ –±–∞“õ—ã–ª–∞–Ω–∞–¥—ã
    let FINANCE_LEDGER = [
        { 
            type: 'balance', 
            date: '2025-01-01', 
            description: '–ñ—ã–ª –±–∞—Å—ã–Ω–¥–∞“ì—ã –±–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–¥—ã“õ', 
            totalBalance: 450000.00, // –ë–∞—Å—Ç–∞–ø“õ—ã –∂–∞–ª–ø—ã —Å–æ–º–∞ (300k + 100k + 50k)
            source: '–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞–ª–¥—ã“õ', // –ë–∞–ª–∞–Ω—Å—Ç—ã“£ –∫”©–∑—ñ
            commission: 0, 
        }
    ];

    // =========================================================================
    // –ü”ò–¢–ï–† –î–ï–†–ï–ö–¢–ï–†–Ü
    const APARTMENT_DATA = [
        { id: '1', account: "0005622", area: 49.9, debt: { maint: 94909.8, clean: 22600, sec: 11100, heat: 9231.5, cap: 109836.92, overall: 247678.22 } },
        { id: '2', account: '3552225', area: 44.6, debt: { maint: 3332, clean: 1700, sec: 600, heat: 446, cap: 3568, overall: 9646 } },
        { id: '3', account: '3552233', area: 45.4, debt: { maint: 5221.4, clean: 2550, sec: 900, heat: 681, cap: 5448, overall: 14800.4 } },
        { id: '4', account: '3552241', area: 22.1, debt: { maint: 29814.4, clean: 6400, sec: 2400, heat: 1804, cap: 40864.94, overall: 81283.34 } },
        { id: '5', account: '355', area: 23, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '6', account: '3552268', area: 20.5, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '7', account: '3552276', area: 21.2, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '8', account: '3552284', area: 41.5, debt: { maint: 50630, clean: 21600, sec: 9600, heat: 6640, cap: 66801.72, overall: 155271.72 } },
        { id: '9', account: '3552292', area: 20.7, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '9a', account: '3559599', area: 25.7, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '11', account: '3552314', area: 17.2, debt: { maint: 20430, clean: 12400, sec: 4800, heat: 2752, cap: 46341.5, overall: 86723.5 } },
        { id: '11a', account: '355', area: 17.2, debt: { maint: 20430, clean: 12400, sec: 4800, heat: 2752, cap: 46341.5, overall: 86723.5  } },
        { id: '12', account: '3552322', area: 27.6, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '13', account: '3552330', area: 34.8, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '14', account: '3552349', area: 38, debt: { maint: 6940, clean: 3400, sec: 1200, heat: 760, cap: 66000, overall: 18900 } },
        { id: '15', account: '3552357', area: 69.2, debt: { maint: 102416, clean: 22600, sec: 11100, heat: 8996, cap: 71968, overall: 217080 } },
        { id: '16', account: '3552365', area: 40.7, debt: { maint: 60236, clean: 18600, sec: 7800, heat: 4884, cap: 42328, overall: 133848 } },
        { id: '17', account: '3552373', area: 49.1, debt: { maint: 23806.6, clean: 750, sec: 1500, heat: 1718.5, cap: 15712, overall: 43487.1 } },
        { id: '18', account: '3552381', area: 18.6, debt: { maint: 25854, clean: 22600, sec: 11100, heat: 3441, cap: 60868.6, overall: 123863.6 } },
        { id: '19', account: '0005800', area: 13.5, debt: { maint: 2160, clean: 3400, sec: 1200, heat: 270, cap: 2160, overall: 9190 } },
        { id: '20', account: '3552403', area: 26.4, debt: { maint: 6582.4, clean: 1600, sec: 1800, heat: 792, cap: 6336, overall: 17110.4 } },
    ];
    // =========================================================================

    function roundToTenge(num) {
        if (typeof num !== 'number' || isNaN(num)) return 0;
        return Math.round(num * 100) / 100;
    }
    
    function getAreaForMonth(initialArea, aptId, monthIndex) {
        const apt = apartments.find(a => a.id === aptId);
        let area = initialArea;

        if (aptId === '4' || aptId === '5') {
            let changedArea = aptId === '4' ? 22.1 : 23; 
            if (monthIndex >= 5 && monthIndex <= 10) { area = changedArea; } 
            else if (monthIndex >= 0 && monthIndex < 5) { area = 45.1; }
        }
        
        if (apt && apt.customSettings && apt.customSettings.area) {
            const change = apt.customSettings.area
                .filter(c => c.startMonth <= monthIndex)
                .sort((a, b) => b.startMonth - a.startMonth)[0]; 
            if (change) { area = change.area; }
        }
        return roundToTenge(area);
    }

    function getTariffRateForMonth(aptId, serviceKey, monthIndex) {
        const apt = apartments.find(a => a.id === aptId);
        let defaultRate = TARIFFS[serviceKey];
        if (serviceKey === 'maint' && COMMERCIAL_APTS.includes(aptId)) {
            defaultRate = COMMERCIAL_MAINT_RATE;
        }
        let rate = defaultRate;

        if (apt && apt.customSettings && apt.customSettings.tariffs && apt.customSettings.tariffs[serviceKey]) {
            const change = apt.customSettings.tariffs[serviceKey]
                .filter(c => c.startMonth <= monthIndex)
                .sort((a, b) => b.startMonth - a.startMonth)[0];
            if (change) { rate = change.rate; }
        }
        return rate;
    }

    function calculateAccruals(initialArea, aptId, monthIndex) { 
        const area = getAreaForMonth(initialArea, aptId, monthIndex); 
        let maintRate = getTariffRateForMonth(aptId, 'maint', monthIndex);
        let cleanRate = getTariffRateForMonth(aptId, 'clean', monthIndex);
        let secRate = getTariffRateForMonth(aptId, 'sec', monthIndex);
        let heatRate = getTariffRateForMonth(aptId, 'heat', monthIndex);
        let capRate = getTariffRateForMonth(aptId, 'cap', monthIndex);
        
        let cleanCharge = (cleanRate === 0 || area === 0) ? 0 : cleanRate;
        let secCharge = (secRate === 0 || area === 0) ? 0 : secRate;
        
        return {
            maint: roundToTenge(area * maintRate), 
            clean: cleanCharge, 
            sec: secCharge,     
            heat: roundToTenge(area * heatRate), 
            cap: roundToTenge(area * capRate) 
        };
    }

    function initializeApartmentData() {
        apartments = [];
        APARTMENT_DATA.forEach(data => {
            const overallSum = SERVICE_KEYS.reduce((sum, key) => sum + (data.debt[key] || 0), 0);
            
            let settings = { area: [], tariffs: { maint: [], clean: [], sec: [], heat: [], cap: [] } };
            
            if (data.id === '11') {
                settings.area = [
                    { startMonth: 0, area: 34.4, name: "–ñ–∞“£—Ç–∞—Ä 2025 (34.4–º2)" },
                    { startMonth: 5, area: 17.2, name: "–ú–∞—É—Å—ã–º 2025 (17.2–º2)" }
                ];
            } else if (data.id === '11a') {
                settings.area = [
                    { startMonth: 0, area: 0, name: "–ñ–∞“£—Ç–∞—Ä 2025 (0–º2)" },
                    { startMonth: 5, area: 17.2, name: "–ú–∞—É—Å—ã–º 2025 (17.2–º2)" }
                ];
            } else {
                 settings.area = [{ startMonth: 0, area: data.area, name: "–ë–∞—Å—Ç–∞–ø“õ—ã –ê—É–¥–∞–Ω" }];
            }
            
            SERVICE_KEYS.forEach(key => {
                let defaultRate = TARIFFS[key];
                if (key === 'maint' && COMMERCIAL_APTS.includes(data.id)) { defaultRate = COMMERCIAL_MAINT_RATE; }
                settings.tariffs[key].push({ startMonth: 0, rate: defaultRate });
            });
            
            const newApt = {
                id: data.id, 
                account: data.account, 
                area: data.area,
                initialDebt: { ...data.debt, 
                    maint: roundToTenge(data.debt.maint), clean: roundToTenge(data.debt.clean), 
                    sec: roundToTenge(data.debt.sec), heat: roundToTenge(data.debt.heat), 
                    cap: roundToTenge(data.debt.cap), overall: roundToTenge(overallSum) 
                }, 
                ledger: [], 
                lastPay: "",
                customSettings: settings
            };
            
            newApt.ledger = getInitialLedger(newApt.area, newApt.id);
            apartments.push(newApt);
        });
        apartments.forEach(apt => calculateAccumulated(apt));
    }

    function recalculateChargesOnly(apt) {
        apt.ledger.forEach((entry, index) => {
            entry.charges = calculateAccruals(apt.area, apt.id, index);
        });
    }
    
    function loadApartment() {
        const id = document.getElementById('aptInput').value.trim(); 
        currentAptIndex = apartments.findIndex(apt => apt.id === id); 
        
        if (currentAptIndex === -1) {
            alert(`–ü”ô—Ç–µ—Ä ‚Ññ${id} –¥–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã–Ω–¥–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã.`); 
            document.getElementById('editor').style.display = 'none';
            return;
        }

        const apt = apartments[currentAptIndex];
        document.getElementById('editor').style.display = 'block';
        document.getElementById('aptTitle').innerHTML = `<h3>–ü”ô—Ç–µ—Ä ${apt.id} (–®–æ—Ç: ${apt.account})</h3>`;
        
        renderCustomSettingsUI(apt);
        recalculateChargesOnly(apt); 
        calculateAccumulated(apt); 
        renderLedgerTable(apt);
    }
    
    function getMonthSelect(id, selectedMonth = 0) {
        return `<select id="${id}">${MONTHS_KK.map((name, index) => `<option value="${index}" ${index === selectedMonth ? 'selected' : ''}>${name}</option>`).join('')}</select>`;
    }

    function renderCustomSettingsUI(apt) {
        const container = document.getElementById('customSettingsEditor');
        const s = apt.customSettings;
        let html = `
            <h3 style="margin-top:0;">–ï—Å–µ–ø—Ç–µ—É –ü–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ–Ω –ë–∞—Å“õ–∞—Ä—É (–ê—É–¥–∞–Ω / –¢–∞—Ä–∏—Ñ)</h3>
            <div class="setting-group">
                <h4>1. –ê—É–¥–∞–Ω–¥—ã ”®–∑–≥–µ—Ä—Ç—É (–º¬≤)</h4>
                <div style="margin-bottom: 10px;">
                    ${s.area.map((a, index) => `
                        <div class="setting-entry" style="font-size: 11px; background: #e9ecef; padding: 5px; border-radius: 3px;">
                            <label style="width: 130px; font-weight: bold;">${MONTHS_KK[a.startMonth]} –∞–π—ã–Ω–∞–Ω –±–∞—Å—Ç–∞–ø:</label>
                            <input type="number" id="area-val-${index}" value="${a.area}" min="0" step="0.1" style="width: 80px;">
                            ${index === 0 ? `<span style="width: 100px;">(–ë–∞—Å—Ç–∞–ø“õ—ã)</span>` : getMonthSelect(`area-month-${index}`, a.startMonth)}
                            <button class="btn btn-blue" onclick="saveAreaChange(${index})">üíæ –°–∞“õ—Ç–∞—É</button>
                            ${index > 0 ? `<button class="btn btn-red" onclick="removeChange('area', ${index})">‚ùå ”®—à—ñ—Ä—É</button>` : ''}
                        </div>
                    `).join('')}
                </div>
                <div class="setting-entry" style="padding-top: 10px; border-top: 1px dashed #ccc;">
                    <label style="font-weight: bold;">‚ûï –ñ–∞“£–∞ –∞—É–¥–∞–Ω:</label>
                    <input type="number" id="newAreaValue" value="" min="0" step="0.1" style="width: 80px;">
                    <label>“ö–∞–π –∞–π–¥–∞–Ω:</label> ${getMonthSelect('newAreaMonth', new Date().getMonth())}
                    <button class="btn btn-green" onclick="addAreaChange()">‚úÖ “ö–æ—Å—É</button>
                </div>
            </div>
            <div class="setting-group">
                <h4>2. “ö—ã–∑–º–µ—Ç –¢–∞—Ä–∏—Ñ—ñ–Ω ”®–∑–≥–µ—Ä—Ç—É (–¢–≥ –Ω–µ–º–µ—Å–µ –¢–≥/–º¬≤)</h4>
                ${SERVICE_KEYS.map(key => `
                    <div style="border: 1px solid #ddd; padding: 5px; margin-bottom: 10px; border-radius: 3px;">
                        <h5 style="margin: 0; padding-bottom: 5px; color: green;">${SERVICE_NAMES[key]} (${key === 'clean' || key === 'sec' ? '–¢–≥/–ø”ô—Ç–µ—Ä' : '–¢–≥/–º¬≤'})</h5>
                        <div style="margin-bottom: 5px;">
                            ${s.tariffs[key].map((t, index) => `
                                <div class="setting-entry" style="font-size: 11px;">
                                    <label style="width: 130px;">${MONTHS_KK[t.startMonth]} –∞–π—ã–Ω–∞–Ω –±–∞—Å—Ç–∞–ø:</label>
                                    <input type="number" id="tariff-${key}-val-${index}" value="${t.rate}" min="0" step="0.01" style="width: 80px;">
                                    ${index === 0 ? `<span style="width: 100px;">(–ë–∞—Å—Ç–∞–ø“õ—ã)</span>` : getMonthSelect(`tariff-${key}-month-${index}`, t.startMonth)}
                                    <button class="btn btn-blue" onclick="saveTariffChange('${key}', ${index})">üíæ –°–∞“õ—Ç–∞—É</button>
                                    ${index > 0 ? `<button class="btn btn-red" onclick="removeChange('tariff', ${index}, '${key}')">‚ùå ”®—à—ñ—Ä—É</button>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        <div class="setting-entry" style="padding-top: 5px; border-top: 1px dotted #ccc;">
                            <label style="font-weight: bold;">‚ûï –ñ–∞“£–∞ —Ç–∞—Ä–∏—Ñ:</label>
                            <input type="number" id="newTariffValue-${key}" value="" min="0" step="0.01" style="width: 80px;">
                            <label>“ö–∞–π –∞–π–¥–∞–Ω:</label> ${getMonthSelect('newTariffMonth-' + key, new Date().getMonth())}
                            <button class="btn btn-green" onclick="addTariffChange('${key}')">‚úÖ “ö–æ—Å—É</button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        container.innerHTML = html;
    }
    
    // --- Settings handlers ---
    function addAreaChange() {
        const apt = apartments[currentAptIndex];
        const newArea = parseFloat(document.getElementById('newAreaValue').value);
        const startMonth = parseInt(document.getElementById('newAreaMonth').value);
        if (isNaN(newArea) || newArea < 0) return alert("–î“±—Ä—ã—Å –∞—É–¥–∞–Ω –º”ô–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
        apt.customSettings.area.push({ startMonth: startMonth, area: roundToTenge(newArea) });
        apt.customSettings.area.sort((a, b) => a.startMonth - b.startMonth);
        alert(`–ê—É–¥–∞–Ω ${newArea} –º¬≤ “õ–æ—Å—ã–ª–¥—ã.`);
        loadApartment(); 
    }
    function saveAreaChange(index) {
        const apt = apartments[currentAptIndex];
        const newArea = parseFloat(document.getElementById(`area-val-${index}`).value);
        const newMonth = index === 0 ? 0 : parseInt(document.getElementById(`area-month-${index}`).value);
        if (isNaN(newArea) || newArea < 0) return alert("–î“±—Ä—ã—Å –∞—É–¥–∞–Ω –º”ô–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
        apt.customSettings.area[index].area = roundToTenge(newArea);
        if (index > 0) apt.customSettings.area[index].startMonth = newMonth;
        apt.customSettings.area.sort((a, b) => a.startMonth - b.startMonth);
        alert(`–ê—É–¥–∞–Ω ”©–∑–≥–µ—Ä—ñ—Å—ñ —Å–∞“õ—Ç–∞–ª–¥—ã.`);
        loadApartment();
    }
    function addTariffChange(serviceKey) {
        const apt = apartments[currentAptIndex];
        const newRate = parseFloat(document.getElementById(`newTariffValue-${serviceKey}`).value);
        const startMonth = parseInt(document.getElementById(`newTariffMonth-${serviceKey}`).value);
        if (isNaN(newRate) || newRate < 0) return alert("–î“±—Ä—ã—Å —Ç–∞—Ä–∏—Ñ –º”ô–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
        apt.customSettings.tariffs[serviceKey].push({ startMonth: startMonth, rate: roundToTenge(newRate) });
        apt.customSettings.tariffs[serviceKey].sort((a, b) => a.startMonth - b.startMonth);
        alert(`${SERVICE_NAMES[serviceKey]} —Ç–∞—Ä–∏—Ñ—ñ “õ–æ—Å—ã–ª–¥—ã.`);
        loadApartment(); 
    }
    function saveTariffChange(serviceKey, index) {
        const apt = apartments[currentAptIndex];
        const newRate = parseFloat(document.getElementById(`tariff-${serviceKey}-val-${index}`).value);
        const newMonth = index === 0 ? 0 : parseInt(document.getElementById(`tariff-${serviceKey}-month-${index}`).value);
        if (isNaN(newRate) || newRate < 0) return alert("–î“±—Ä—ã—Å —Ç–∞—Ä–∏—Ñ –º”ô–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
        apt.customSettings.tariffs[serviceKey][index].rate = roundToTenge(newRate);
        if (index > 0) apt.customSettings.tariffs[serviceKey][index].startMonth = newMonth;
        apt.customSettings.tariffs[serviceKey].sort((a, b) => a.startMonth - b.startMonth);
        alert(`${SERVICE_NAMES[serviceKey]} —Ç–∞—Ä–∏—Ñ—ñ —Å–∞“õ—Ç–∞–ª–¥—ã.`);
        loadApartment();
    }
    function removeChange(type, index, serviceKey = null) {
        if (!confirm("–ë“±–ª ”©–∑–≥–µ—Ä—ñ—Å—Ç—ñ ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) return;
        const apt = apartments[currentAptIndex];
        if (type === 'area') apt.customSettings.area.splice(index, 1);
        else if (type === 'tariff' && serviceKey) apt.customSettings.tariffs[serviceKey].splice(index, 1);
        alert("”®–∑–≥–µ—Ä—ñ—Å ”©—à—ñ—Ä—ñ–ª–¥—ñ.");
        loadApartment();
    }

    function getInitialLedger(area, aptId) {
        const ledger = [];
        const currentDate = new Date();
        const currentMonthIndex = currentDate.getMonth(); 
        for (let i = 0; i < 12; i++) {
            let currentCharges = (i <= currentMonthIndex) ? calculateAccruals(area, aptId, i) : { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
            ledger.push({
                month: MONTHS_KK[i] + '. ' + MONTHS_RU[i] + ' 2025',
                charges: currentCharges,
                paymentTransactions: [], 
            });
        }
        return ledger;
    }

    function autoCheckMonthlyCharges() {
        const currentMonthIndex = new Date().getMonth();
        apartments.forEach(apt => {
            for (let i = 0; i <= currentMonthIndex; i++) {
                const ch = apt.ledger[i].charges;
                if ((ch.maint + ch.clean + ch.sec + ch.heat + ch.cap) === 0) {
                    apt.ledger[i].charges = calculateAccruals(apt.area, apt.id, i);
                }
            }
        });
    }

    function init() {
        initializeApartmentData();
        autoCheckMonthlyCharges();
        updateFinanceLedger(false); 
        document.getElementById('msg').innerText = "–ë–∞“ì–¥–∞—Ä–ª–∞–º–∞ —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã.";
    }

    function resetAllData() {
        if(confirm("–ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ ”©—à—ñ—Ä—ñ–ø, –±–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) {
            location.reload();
        }
    }

    function downloadDataJSON() {
        if (currentAptIndex !== null) { 
            updateLedger(false); 
        }
        updateFinanceLedger(false);

        const fullData = {
            apartments: apartments,
            financeLedger: FINANCE_LEDGER
        };

        const dataStr = JSON.stringify(fullData, null, 4);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'kz_tulem_database_' + new Date().toISOString().slice(0, 10) + '.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        document.getElementById('msg').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä (.json) —Å”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!";
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    }

    function uploadDataJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const uploadedData = JSON.parse(e.target.result);
                apartments = uploadedData.apartments || APARTMENT_DATA;
                FINANCE_LEDGER = uploadedData.financeLedger || [];

                // –ï—Å–∫—ñ “õ–∞—Ä–∂—ã–ª—ã“õ –ª–µ–¥–∂–µ—Ä —Ñ–æ—Ä–º–∞—Ç—ã–Ω–∞–Ω –∂–∞“£–∞—Å—ã–Ω–∞ ”©—Ç–∫—ñ–∑—É –ª–æ–≥–∏–∫–∞—Å—ã–Ω “õ–æ—Å—É (“õ–∞–∂–µ—Ç –±–æ–ª—Å–∞)
                if (FINANCE_LEDGER.length > 0 && FINANCE_LEDGER[0].accounts) {
                    const oldAccounts = FINANCE_LEDGER[0].accounts;
                    FINANCE_LEDGER[0] = {
                        type: 'balance',
                        date: FINANCE_LEDGER[0].date,
                        description: FINANCE_LEDGER[0].description,
                        totalBalance: roundToTenge(Object.values(oldAccounts).reduce((sum, val) => sum + val, 0)),
                        source: '–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞–ª–¥—ã“õ (–ê—É—ã—Å—Ç—ã—Ä—ã–ª“ì–∞–Ω)',
                        commission: 0,
                    };
                    FINANCE_LEDGER = [FINANCE_LEDGER[0]].concat(FINANCE_LEDGER.slice(1).map(tx => {
                        delete tx.account; // –ï—Å–∫—ñ —à–æ—Ç ”©—Ä—ñ—Å—ñ–Ω –∂–æ—é
                        delete tx.balancesAfter;
                        tx.sourceAccount = tx.sourceAccount || ''; 
                        return tx;
                    }));
                }


                autoCheckMonthlyCharges();
                apartments.forEach(apt => calculateAccumulated(apt));
                updateFinanceLedger(false);

                document.getElementById('msg').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ!";
                
                if (currentAptIndex !== null) {
                    const currentId = apartments[currentAptIndex] ? apartments[currentAptIndex].id : null;
                    if(currentId) loadApartment();
                }
                
            } catch (error) {
                console.error("JSON “õ–∞—Ç–µ—Å—ñ:", error);
                document.getElementById('msg').innerText = "‚ùå JSON —Ñ–∞–π–ª—ã “õ–∞—Ç–µ!";
            }
        };
        reader.readAsText(file);
    }

    function calculateAccumulated(apt) {
        let currentBal = { ...apt.initialDebt }; 
        apt.ledger.forEach((entry) => {
            let monthTotalCharge = 0;
            SERVICE_KEYS.forEach(key => {
                const totalPaymentForService = entry.paymentTransactions.reduce((sum, tx) => sum + (tx.amounts[key] || 0), 0);
                currentBal[key] = roundToTenge(currentBal[key] + entry.charges[key] - totalPaymentForService);
                monthTotalCharge += entry.charges[key];
            });
            currentBal.overall = roundToTenge(currentBal.maint + currentBal.clean + currentBal.sec + currentBal.heat + currentBal.cap);
            entry.accumulated = { ...currentBal };
            entry.totalMonthlyCharge = roundToTenge(monthTotalCharge); 
        });
        return currentBal; 
    }

    function renderLedgerTable(apt) {
        const editorDiv = document.getElementById('ledgerEditor');
        const displayValue = (val) => roundToTenge(val); 
        let html = `
            <table>
                <tr><th rowspan="2" style="width:120px;">–ê–π</th></tr>
                <tr>${SERVICE_KEYS.map(key => `<th colspan="2">${SERVICE_NAMES[key]}</th>`).join('')}<th class="total-col sub-col-header" colspan="2">–ñ–∞–ª–ø—ã –ñ—ã–π—ã–Ω—ã</th></tr>
                <tr class="initial-debt-row">
                    <td class="month-group-header left-align">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>
                    ${SERVICE_KEYS.map(key => `<td class="charge-cell">${displayValue(apt.initialDebt[key])}</td><td class="payment-cell"></td>`).join('')}
                    <td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td><td class="total-col payment-cell"></td><td></td>
                </tr>
                ${apt.ledger.map((entry, index) => {
                    let monthHtml = ''; 
                    const transactionsExist = entry.paymentTransactions.length > 0;
                    if (transactionsExist) {
                        entry.paymentTransactions.forEach((tx, txIndex) => {
                            const totalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (tx.amounts[key] || 0), 0);
                            monthHtml += `
                                <tr class="payment-row" data-month-index="${index}" data-tx-index="${txIndex}" style="background:#f0f0f0;">
                                    <td class="month-group-header left-align" ${txIndex === 0 ? `rowspan="${entry.paymentTransactions.length}"` : 'style="display:none;"'}>${entry.month}</td>
                                    ${SERVICE_KEYS.map(key => `
                                        <td class="charge-cell">${txIndex === 0 ? displayValue(entry.charges[key]) : ''}</td>
                                        <td class="payment-cell">
                                            <input type="number" class="payment-input pay-input" data-month-index="${index}" data-tx-index="${txIndex}" data-key="${key}" value="${tx.amounts[key] === 0 ? '' : displayValue(tx.amounts[key])}" min="0" step="0.01">
                                        </td>
                                    `).join('')}
                                    <td class="total-col charge-cell">${txIndex === 0 ? displayValue(entry.totalMonthlyCharge) : ''}</td>
                                    <td class="total-col payment-cell payment-details-cell">
                                        <div class="payment-details-inline">
                                            <span class="payment-total-amount">${displayValue(totalTxAmount)}</span>
                                            <input type="date" class="payment-details-input date-input" data-month-index="${index}" data-tx-index="${txIndex}" data-field="date" value="${tx.date || ''}">
                                            <input type="text" class="payment-details-input source-input" data-month-index="${index}" data-tx-index="${txIndex}" data-field="paymentSource" value="${tx.paymentSource || ''}" placeholder="–®–æ—Ç/–ö”©–∑">
                                        </div>
                                    </td>
                                    <td ${txIndex === 0 ? `rowspan="${entry.paymentTransactions.length}"` : 'style="display:none;"'} style="text-align: center;">
                                        <div class="action-buttons-inline">
                                            <button class="btn btn-red" onclick="removeTransaction(${index}, ${txIndex})">‚ùå</button>
                                            <button class="btn btn-blue" onclick="addTransaction(${index})">üí∞</button>
                                        </div>
                                    </td>
                                </tr>`;
                        });
                    } else {
                        monthHtml += `
                            <tr class="charge-row" data-month-index="${index}" style="background:${entry.totalMonthlyCharge > 0 ? '#f8d7da' : '#f0f0f0'};">
                                <td class="month-group-header left-align">${entry.month}</td>
                                ${SERVICE_KEYS.map(key => `<td class="charge-cell">${displayValue(entry.charges[key])}</td><td class="charge-cell"></td>`).join('')}
                                <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td><td class="total-col charge-cell"></td>
                                <td><button class="btn btn-blue" onclick="addTransaction(${index})">üí∞ –¢”©–ª–µ–º “õ–æ—Å—É</button></td>
                            </tr>`;
                    }
                    const accRow = `
                        <tr class="total-acc-row">
                            <td class="month-group-header left-align">–ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã (–ê–π —Å–æ“£—ã)</td>
                            ${SERVICE_KEYS.map(key => `<td colspan="2" style="color: ${entry.accumulated[key] > 0 ? 'red' : 'green'};">${displayValue(entry.accumulated[key])}</td>`).join('')}
                            <td colspan="2" class="total-col" style="color: ${entry.accumulated.overall > 0 ? 'red' : 'green'};">${displayValue(entry.accumulated.overall)}</td><td></td>
                        </tr>`;
                    return monthHtml + accRow;
                }).join('')}
            </table>`;
        editorDiv.innerHTML = html;
        // –ñ–∞“£–∞ –º”ô—Ç—ñ–Ω –µ–Ω–≥—ñ–∑—É “±—è—à—ã“ì—ã–Ω–∞ —Ç—ã“£–¥–∞—É—à—ã “õ–æ—Å—É
        document.querySelectorAll('.pay-input, .date-input, .source-input').forEach(input => {
            input.addEventListener('change', () => updateLedger(false)); 
        });
    }

    function addTransaction(monthIndex) {
        const apt = apartments[currentAptIndex];
        apt.ledger[monthIndex].paymentTransactions.push({
            amounts: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 },
            date: new Date().toISOString().slice(0, 10), 
            paymentSource: '–ö–∞—Å—Å–∞/–ë–∞–Ω–∫/–ö–∞—Ä—Ç–∞' // –ñ–∞“£–∞ ”ô–¥–µ–ø–∫—ñ –º”ô–Ω
        });
        calculateAccumulated(apt); 
        renderLedgerTable(apt);
    }

    function removeTransaction(monthIndex, txIndex) {
        if(!confirm("–¢”©–ª–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Å—ã–Ω ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) return;
        apartments[currentAptIndex].ledger[monthIndex].paymentTransactions.splice(txIndex, 1);
        loadApartment();
    }

    function updateLedger(render = true) {
        const apt = apartments[currentAptIndex];
        document.querySelectorAll('.pay-input').forEach(input => {
            const mIdx = parseInt(input.getAttribute('data-month-index'));
            const tIdx = parseInt(input.getAttribute('data-tx-index'));
            const key = input.getAttribute('data-key');
            apt.ledger[mIdx].paymentTransactions[tIdx].amounts[key] = roundToTenge(input.value === '' ? 0 : parseFloat(input.value)) || 0;
        });
        
        // date-input –∂”ô–Ω–µ source-input (–±“±—Ä—ã–Ω“ì—ã bank-select) “Ø—à—ñ–Ω –∂–∞“£–∞—Ä—Ç—É
        document.querySelectorAll('.date-input, .source-input').forEach(input => {
            const mIdx = parseInt(input.getAttribute('data-month-index'));
            const tIdx = parseInt(input.getAttribute('data-tx-index'));
            const field = input.getAttribute('data-field'); // date –Ω–µ–º–µ—Å–µ paymentSource
            if (apt.ledger[mIdx].paymentTransactions[tIdx]) apt.ledger[mIdx].paymentTransactions[tIdx][field] = input.value;
        });

        calculateAccumulated(apt);
        if (render) {
            renderLedgerTable(apt); 
            document.getElementById('msg').innerText = "‚úÖ –¢”©–ª–µ–º–¥–µ—Ä —Ç—ñ—Ä–∫–µ–ª–¥—ñ!";
            setTimeout(() => document.getElementById('msg').innerText = "", 3000);
        }
    }

    // --- –¢“Æ–ë–Ü–†–¢–ï–ö –ñ“Æ–ö–¢–ï–£ ---
    function downloadReceipt() {
        const apt = apartments[currentAptIndex];
        if (!apt) return alert("–ê–ª–¥—ã–º–µ–Ω –ø”ô—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ“£—ñ–∑.");
        updateLedger(false); 
        calculateAccumulated(apt);
        const displayValue = (val) => roundToTenge(val); 
        
        const currentDate = new Date();
        const currentMonthIndex = currentDate.getMonth(); 
        const headerMonthName = `${MONTHS_KK[currentMonthIndex]} / ${MONTHS_RU[currentMonthIndex]} 2025`;
        
        const currentMonthData = apt.ledger[currentMonthIndex] ? apt.ledger[currentMonthIndex] : apt.ledger[apt.ledger.length-1];
        const currentCharges = currentMonthData.charges;
        const currentTotal = currentMonthData.totalMonthlyCharge;

        let historyRows = '';
        historyRows += `<tr class="charge-row receipt-style"><td class="left-align bold">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>${SERVICE_KEYS.map(key => `<td class="charge-cell">${displayValue(apt.initialDebt[key])}</td><td></td>`).join('')}<td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td><td></td></tr>`;
        
        apt.ledger.forEach(entry => {
            if (entry.paymentTransactions.length > 0) {
                const tx0 = entry.paymentTransactions[0];
                const totalTxAmount0 = SERVICE_KEYS.reduce((sum, key) => sum + (tx0.amounts[key] || 0), 0);
                // tx.paymentSource “õ–æ–ª–¥–∞–Ω—ã–ª–∞–¥—ã
                const paymentDetails0 = totalTxAmount0 > 0 ? `<div style="font-size: 8px;">${displayValue(totalTxAmount0)} ${tx0.date.replace(/-/g, '.')} (${tx0.paymentSource || '–®–æ—Ç—Å—ã–∑'})</div>` : '';
                historyRows += `<tr class="payment-row receipt-style"><td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>${SERVICE_KEYS.map(key => `<td class="charge-cell">${displayValue(entry.charges[key])}</td><td class="payment-cell">${displayValue(tx0.amounts[key])}</td>`).join('')}<td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td><td class="total-col payment-cell">${paymentDetails0}</td></tr>`;
                   for(let txIndex = 1; txIndex < entry.paymentTransactions.length; txIndex++) {
                    const nextTx = entry.paymentTransactions[txIndex];
                    const nextTotal = SERVICE_KEYS.reduce((sum, key) => sum + (nextTx.amounts[key] || 0), 0);
                    const details = nextTotal > 0 ? `<div style="font-size: 8px;">${displayValue(nextTotal)} K${nextTx.date.replace(/-/g, '.')} (${nextTx.paymentSource || '–®–æ—Ç—Å—ã–∑'})</div>` : '';
                    historyRows += `<tr class="payment-row receipt-style"><td class="left-align"></td>${SERVICE_KEYS.map(key => `<td></td><td class="payment-cell">${displayValue(nextTx.amounts[key])}</td>`).join('')}<td></td><td class="total-col payment-cell">${details}</td></tr>`;
                    }
            } else {
                 historyRows += `<tr class="charge-row receipt-style"><td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>${SERVICE_KEYS.map(key => `<td class="charge-cell">${displayValue(entry.charges[key])}</td><td></td>`).join('')}<td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td><td></td></tr>`;
            }
        });
        
        const finalAccumulated = apt.ledger[11] ? apt.ledger[11].accumulated : apt.initialDebt; 
        const currentAreaDisplay = getAreaForMonth(apt.area, apt.id, currentMonthIndex);

        const htmlContent = `<!DOCTYPE html><html lang="kk"><head><meta charset="UTF-8"><title>–¢”©–ª–µ–º –¢“Ø–±—ñ—Ä—Ç–µ–≥—ñ: ${apt.id}</title><style>body { font-family: Arial, serif; font-size: 11px; margin: 20px;color: #424242; } table { width: 100%; border-collapse: collapse; table-layout: fixed; } th, td { border: 1px solid #a3a3a3; padding: 4px 6px; text-align: right; vertical-align:bottom; } .header-cell { vertical-align:bottom; text-align: center; padding: 6px 4px; } .month-header { text-align: left; font-size: 14px; font-weight: bold; } .acc-info { text-align: ; font-size: 10px; border: none; } .charge-cell { background-color: #f8f8f8; } .payment-cell { background-color: } .total-acc-row td { background-color: #ffe082;} .total-col { background-color: } .left-align { text-align:; } .bold { font-weight: bold; }</style></head><body><table><tr><td class="acc-info" style="width: 25%"><span class="month-header">${headerMonthName}</span><br>–¥–µ—Ä–±–µ—Å —à–æ—Ç: ${apt.account}<br>Aqsai-3, 10a, <strong>${apt.id}</strong> - ${currentAreaDisplay} m2<br> </td><td colspan="2" class="header-cell">“Æ–∏–¥—ñ –∫“Ø—Ç—ñ–ø “±—Å—Ç–∞—É.
–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–æ–º–∞<br>${COMMERCIAL_APTS.includes(apt.id) ? '60' : '40'} —Ç“£–≥,–º2</td><td colspan="2" class="header-cell">“Æ–∏ —ñ—à—ñ —Ç–∞–∑–∞–ª—ã“ì—ã. –£–±–æ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ –¥–æ–º–∞<br>850 —Ç“£–≥,–ø—Ç.–∫–≤.</td><td colspan="2" class="header-cell">–ö—ñ—Ä–µ–±–µ—Ä—ñ—Å –µ—Å—ñ–∫–∫–µ “õ—ã–∑—ã–º–µ—Ç, –±–µ–∏–Ω–µ–±–∞“õ—ã–ª–∞—É. –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≥–ª. –í—Ö. –¥–≤–µ—Ä–∏, –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ<br>300 —Ç“£–≥,–ø—Ç.–∫–≤.</td><td colspan="2" class="header-cell">–ñ—ã–ª—ã—É –µ—Å–µ–ø—Ç–µ—É “õ“±—Ä–∞–ª–¥–∞—Ä—ã–Ω–∞ “õ—ã–∑—ã–º–µ—Ç. –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏–±–æ—Ä —É—á–µ—Ç–∞ —Ç–µ–ø–ª–∞<br>5 —Ç“£–≥,–º2</td><td colspan="2" class="header-cell">–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥–µ—É. –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç<br>40 —Ç“£–≥,–º2</td><td colspan="2" class="header-cell total-col">–ñ—ã–π—ã–Ω—ã. –ò—Ç–æ–≥–æ</td></tr><tr><td class="left-align">–ê–π—ã–Ω–∞ –µ—Å–µ–ø—Ç–µ—É. –†–∞—Å—á–µ—Ç –≤ –º–µ—Å—è—Ü</td><td class="charge-cell">${displayValue(currentCharges.maint)}</td><td></td><td class="charge-cell">${displayValue(currentCharges.clean)}</td><td></td><td class="charge-cell">${displayValue(currentCharges.sec)}</td><td></td><td class="charge-cell">${displayValue(currentCharges.heat)}</td><td></td><td class="charge-cell">${displayValue(currentCharges.cap)}</td><td></td><td class="total-col charge-cell">${displayValue(currentTotal)}</td><td></td></tr><tr class="total-acc-row"><td class="left-align">–∂—ã–π–Ω–∞–ª“ì–∞–Ω—ã, –Ω–∞–∫–æ–ø–∏–≤—à–µ–µ—Å—è</td><td colspan="2">${displayValue(finalAccumulated.maint)}</td><td colspan="2">${displayValue(finalAccumulated.clean)}</td><td colspan="2">${displayValue(finalAccumulated.sec)}</td><td colspan="2">${displayValue(finalAccumulated.heat)}</td><td colspan="2">${displayValue(finalAccumulated.cap)}</td><td class="total-col charge-cell">${displayValue(finalAccumulated.overall)}</td><td class="total-col payment-cell" style="text-align: center; background: #fff3cd; padding: 4px;">–¢”©–ª–µ–º–≥–µ - –ö –æ–ø–ª–∞—Ç–µ</td></tr>${historyRows}</table></body></html>`;
        
        const blob = new Blob([htmlContent], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${apt.id}.html`; 
        link.click();
    }

    function generateReport() {
        apartments.forEach(apt => calculateAccumulated(apt));
        const monthlyReport = {}; 
        const totalApts = apartments.length;
        const year = '2025'; 
        for (let i = 0; i < 12; i++) { 
            const monthName = MONTHS_KK[i];
            let totalArea = 0, monthlyTotalCharge = 0, monthlyTotalPayment = 0, apartmentsPaid = 0;
            let totalCharges = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
            let totalPayments = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
            apartments.forEach(apt => {
                const entry = apt.ledger[i];
                if (!entry) return;
                totalArea += getAreaForMonth(apt.area, apt.id, i); 
                SERVICE_KEYS.forEach(key => totalCharges[key] += entry.charges[key]);
                monthlyTotalCharge += entry.totalMonthlyCharge;
                const monthPayments = entry.paymentTransactions;
                if (monthPayments.length > 0) {
                     if (monthPayments.some(tx => SERVICE_KEYS.some(key => tx.amounts[key] > 0))) apartmentsPaid++;
                    monthPayments.forEach(tx => SERVICE_KEYS.forEach(key => totalPayments[key] += tx.amounts[key]));
                    monthlyTotalPayment += monthPayments.reduce((sum, tx) => sum + SERVICE_KEYS.reduce((ts, key) => ts + tx.amounts[key], 0), 0);
                }
            });
            monthlyReport[monthName] = { totalArea: roundToTenge(totalArea), totalCharges, totalPayments, apartmentsPaid, monthlyTotalCharge: roundToTenge(monthlyTotalCharge), monthlyTotalPayment: roundToTenge(monthlyTotalPayment) };
        }
        renderReportTables(monthlyReport, totalApts, year);
        document.getElementById('msg').innerText = "‚úÖ –ñ–∞–ª–ø—ã –µ—Å–µ–ø “õ“±—Ä—ã–ª–¥—ã!";
    }

    function renderReportTables(reportData, totalApts, year) {
        const container = document.getElementById('reportContainer');
        const displayValue = (val) => roundToTenge(val).toLocaleString('kk-KZ'); 
        
        let html = `<h4 style="margin-top: 20px; background: #cce5ff; padding: 5px;">–ñ—ã–ª: ${year} | –ë–∞—Ä–ª—ã“õ –ø”ô—Ç–µ—Ä–ª–µ—Ä: ${totalApts}</h4><table style="width: 100%; font-size: 10px; table-layout: fixed;"><thead>
            <tr>
                <th rowspan="3">–ê–π</th>
                <th rowspan="3">–¢”©–ª–µ–≥–µ–Ω —Å–∞–Ω—ã</th>
                <th rowspan="3">–ñ–∞–ª–ø—ã –∞—É–¥–∞–Ω</th>
                <th colspan="${SERVICE_KEYS.length * 2}">“ö—ã–∑–º–µ—Ç—Ç–µ—Ä</th>
                <th colspan="${SERVICE_KEYS.length + 3}">–ñ–∞–ª–ø—ã “ö–æ—Ä—ã—Ç—ã–Ω–¥—ã (–ï—Å–µ–ø—Ç–µ—É/–¢”©–ª–µ–º/“ö–∞—Ä—ã–∑)</th>
            </tr>
            <tr>
                ${SERVICE_KEYS.map(key => `<th colspan="2" style="background: #e0f7fa;">${SERVICE_NAMES[key]}</th>`).join('')}
                <th rowspan="2" style="background: #fff3cd;">–ñ–∞–ª–ø—ã –ï—Å–µ–ø. (–î)</th>
                <th rowspan="2" style="background: #d4edda;">–ñ–∞–ª–ø—ã –¢”©–ª–µ–º. (–ö)</th> 
                ${SERVICE_KEYS.map(key => `<th style="background: #f8d7da;">${SERVICE_NAMES[key]}</th>`).join('')}
                <th rowspan="2" style="background: #ffe680;">–ñ–∞–ª–ø—ã “ö–∞—Ä—ã–∑</th>
            </tr>
            <tr>
                ${SERVICE_KEYS.map(() => `<th style="background:#fff3cd;">–î</th><th style="background:#d4edda;">–ö</th>`).join('')}
            </tr>
            </thead>
            <tbody>`;
            
        MONTHS_KK.forEach((month, index) => {
            const data = reportData[month];
            if (!data) return;
            const totalOverallAccumulated = apartments.reduce((sum, apt) => roundToTenge(sum + (apt.ledger[index] ? apt.ledger[index].accumulated.overall : apt.initialDebt.overall)), 0);
            
            html += `<tr>
                <td style="text-align: left; font-weight: bold;">${month}</td>
                <td style="text-align: center;">${data.apartmentsPaid} / ${totalApts}</td>
                <td>${displayValue(data.totalArea)}</td>
                ${SERVICE_KEYS.map(key => `<td style="background:#fff3cd;">${displayValue(data.totalCharges[key])}</td><td style="background:#d4edda;">${displayValue(data.totalPayments[key])}</td>`).join('')}
                
                <td style="background: #fff3cd; font-weight: bold;">${displayValue(data.monthlyTotalCharge)}</td>
                <td style="background: #d4edda; font-weight: bold;">${displayValue(data.monthlyTotalPayment)}</td>
                
                ${SERVICE_KEYS.map(key => `<td style="background:#f8d7da;">${displayValue(apartments.reduce((sum, apt) => roundToTenge(sum + (apt.ledger[index]?.accumulated[key] || 0)), 0))}</td>`).join('')}
                <td style="background: #ffe680; font-weight: bold;">${displayValue(totalOverallAccumulated)}</td>
            </tr>`;
        });
        
        container.innerHTML = html + `</tbody></table>`;
    }

    function downloadGeneralReport() {
        generateReport(); 
        const reportContent = document.getElementById('reportContainer').innerHTML;
        const blob = new Blob([`<!DOCTYPE html><html lang="kk"><head><meta charset="UTF-8"><title>–ñ–∞–ª–ø—ã –ï—Å–µ–ø</title><style>body { font-family: Arial; font-size: 12px; } table { width: 100%; border-collapse: collapse; font-size: 10px; } th, td { border: 1px solid #a3a3a3; padding: 4px; text-align: right; } th { background: #f8f9fa; }</style></head><body>${reportContent}</body></html>`], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `kz_general_report_${new Date().toISOString().slice(0, 10)}.html`; 
        link.click();
    }

    // --- “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä—ã –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã ---
    function addFinanceTransaction() {
        const type = document.getElementById('transactionTypeSelect').value;
        FINANCE_LEDGER.push({ 
            type: type, 
            date: new Date().toISOString().slice(0, 10), 
            description: type === 'income' ? '–ö—ñ—Ä—ñ—Å' : '–®—ã“ì—ã—Å', 
            sourceAccount: '', // –ñ–∞“£–∞ –º”ô—Ç—ñ–Ω–¥—ñ–∫ “±—è—à—ã“õ
            amount: 0, 
            commission: 0, 
            source: 'Manual' 
        });
        updateFinanceLedger(true);
    }
    
    function updateFinanceLedger(render = true) {
        if (render) {
            document.querySelectorAll('.finance-tx-input').forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const field = input.getAttribute('data-field');
                const tx = FINANCE_LEDGER[index];
                if (!tx) return;
                
                if (tx.type === 'balance' && field === 'totalBalance') {
                     tx.totalBalance = roundToTenge(parseFloat(input.value) || 0);
                } else if (field === 'amount' || field === 'commission') {
                    const amtInput = document.querySelector(`[data-index="${index}"][data-field="amount"]:not([readonly])`);
                    if(amtInput) tx.amount = roundToTenge(parseFloat(amtInput.value) || 0);
                    if(field === 'commission') tx.commission = roundToTenge(parseFloat(input.value) || 0);
                } else tx[field] = input.value;
            });
        }
        
        // –ñ–∞–ª–ø—ã “õ–∞–ª–¥—ã“õ—Ç—ã –µ—Å–µ–ø—Ç–µ—É
        let currentTotalBalance = 0;
        FINANCE_LEDGER.forEach(tx => {
            if (tx.type === 'balance') {
                 currentTotalBalance = roundToTenge(tx.totalBalance || 0);
            } else {
                 currentTotalBalance = roundToTenge(currentTotalBalance + (tx.amount - tx.commission) * (tx.type === 'income' ? 1 : -1));
            }
            tx.balanceAfter = currentTotalBalance; 
        });
        
        if (render) renderFinanceLedgerTable();
    }
    
    function renderFinanceLedgerTable() {
        const container = document.getElementById('financeLedgerTable');
        const displayValue = (val) => roundToTenge(val).toLocaleString('kk-KZ'); 
        
        // –ö–µ—Å—Ç–µ–Ω—ñ“£ —Ç–∞“õ—ã—Ä—ã–±—ã–Ω –∂–∞“£–∞—Ä—Ç—É
        let html = `<table><thead><tr class="finance-header"><th rowspan="2">–ö“Ø–Ω—ñ</th><th rowspan="2">–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ</th><th rowspan="2" style="background:#d4edda;">–ö—ñ—Ä—ñ—Å</th><th rowspan="2" style="background:#f8d7da;">–®—ã“ì—ã—Å</th><th rowspan="2">–ö–æ–º–∏—Å—Å–∏—è</th><th rowspan="2" style="width: 150px;">–®–æ—Ç/–ú–∞“õ—Å–∞—Ç</th><th style="background: #ffc107; width: 100px;">–ñ–∞–ª–ø—ã “ö–∞–ª–¥—ã“õ</th><th rowspan="2">”ò—Ä–µ–∫–µ—Ç</th></tr></thead><tbody>`;
        
        FINANCE_LEDGER.forEach((tx, index) => {
            const isBal = tx.type === 'balance', isInc = tx.type === 'income';
            html += `<tr class="${isBal?'balance-row':(isInc?'income-row':'expense-row')}">
                <td class="left-align"><input type="date" class="finance-tx-input" data-index="${index}" data-field="date" value="${tx.date}" ${isBal?'readonly':''}></td>
                <td class="left-align"><input type="text" class="description-input finance-tx-input" data-index="${index}" data-field="description" value="${tx.description}" ${isBal?'readonly':''}></td>
                <td style="background:#d4edda;"><input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="amount" value="${isInc && !isBal ? (tx.amount||'') : ''}" ${(!isInc || isBal)?'readonly':''}></td>
                <td style="background:#f8d7da;"><input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="amount" value="${!isInc && !isBal ? (tx.amount||'') : ''}" ${(isInc || isBal)?'readonly':''}></td>
                <td><input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="commission" value="${tx.commission||''}" ${isBal?'readonly':''}></td>
                <td>
                    <input type="text" class="finance-input finance-tx-input" data-index="${index}" data-field="${isBal ? 'source' : 'sourceAccount'}" value="${isBal ? (tx.source||'') : (tx.sourceAccount||'')}" style="width: 120px;">
                </td>
                <td>
                    ${isBal ? `<input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="totalBalance" value="${tx.totalBalance||0}">` : displayValue(tx.balanceAfter)}
                </td>
                <td>${!isBal ? `<button class="btn btn-red" onclick="removeFinanceTransaction(${index})">‚ùå</button>` : ''}</td>
            </tr>`;
        });
        container.innerHTML = html + `</tbody></table>`;
        
        // –ñ–∞“£–∞ –∫—ñ—Ä—ñ—Å “±—è—à—ã“õ—Ç–∞—Ä—ã–Ω–∞ —Ç—ã“£–¥–∞—É—à—ã “õ–æ—Å—É
         document.querySelectorAll('.finance-tx-input').forEach(input => {
            input.addEventListener('change', () => updateFinanceLedger(false)); 
        });
    }
    
    function removeFinanceTransaction(i) { if(!confirm("”®—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?"))return; FINANCE_LEDGER.splice(i,1); updateFinanceLedger(true); }
    function downloadFinanceLedger() { updateFinanceLedger(true); const content=document.getElementById('financeLedgerTable').innerHTML; const blob=new Blob([`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:4px;}</style></head><body>${content}</body></html>`],{type:"text/html"}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download=`finance_ledger.html`; link.click(); }
</script>
</body>
</html>
