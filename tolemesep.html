<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –∂”ô–Ω–µ “ö–∞—Ä–∂—ã –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ</title>
    <style>
        /* –ë–ê–°“ö–ê–†–£ –ü–ê–ù–ï–õ–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü */
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .admin-panel { max-width: 1500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; } 
        .btn { padding: 10px 15px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        /* ”®—Ä—ñ—Å—Ç–µ—Ä */
        input[type="text"], input[type="date"], select, input[type="number"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        
        /* –õ–ï–î–ñ–ï–† –ö–ï–°–¢–ï–°–Ü–ù–Ü“¢ –ñ–ê–õ–ü–´ –°–¢–ò–õ–Ü */
        #ledgerEditor table, #reportContainer table, #financeLedgerTable table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; min-width: 1000px; }
        #ledgerEditor th, #ledgerEditor td, #reportContainer th, #reportContainer td, #financeLedgerTable th, #financeLedgerTable td { border: 1px solid #ddd; padding: 4px; text-align: right; vertical-align: top; }
        #ledgerEditor th, #reportContainer th, #financeLedgerTable th { background: #f8f9fa; }
        
        /* –ñ–µ–∫–µ –ü”ô—Ç–µ—Ä –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ –°—Ç–∏–ª—ñ */
        .month-group-header { text-align: left; font-weight: bold; background: #e0f7fa; }
        .payment-row { background: #f0f0f0; } 
        .total-acc-row td { background: #ffe680; font-weight: bold; font-size: 12px; } 
        .total-col { background: #e9e9ff; } 
        .sub-col-header { background: #e9ecef; }
        .payment-input { width: 60px; }
        .payment-details-inline { display: flex; gap: 5px; justify-content: space-between; align-items: center; font-size: 9px; }
        .payment-details-input { width: 60px; }
        .payment-total-amount { font-size: 11px; font-weight: bold; }
        .action-buttons-inline { display: flex; flex-direction: column; gap: 3px; justify-content: center; align-items: center; height: 100%; padding: 2px 0; }
        .action-buttons-inline button { width: 100%; padding: 3px 5px; font-size: 10px; }
        .left-align { text-align: left; }
        
        /* “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω—ñ“£ –°—Ç–∏–ª—ñ */
        .finance-header { background: #cce5ff; font-weight: bold; }
        .income-row { background: #d4edda; } /* –ö—ñ—Ä—ñ—Å */
        .expense-row { background: #f8d7da; } /* –®—ã“ì—ã—Å */
        .balance-row { background: #ffe080; font-weight: bold; } /* “ö–∞–ª–¥—ã“õ */
        .balance-row input { font-weight: bold; }
        .balance-row td:not(:first-child) { color: black; }
        .balance-row td:nth-child(2) input { font-size: 11px; }

        .finance-input { width: 80px; text-align: right; }
        .description-input { width: 95%; }
        .account-balance-cell { background: #e3f2fd; font-weight: bold; }
        .account-total-balance { background: #ffc107; color: black; font-size: 14px; }
    </style>
</head>
<body onload="init()">

<div class="admin-panel">
    <h2>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –∂”ô–Ω–µ “ö–∞—Ä–∂—ã –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ</h2>
    
    <div class="controls">
        <label for="uploadJson" class="btn btn-blue" style="width: 200px; text-align: center;">‚¨ÜÔ∏è –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –ñ“Ø–∫—Ç–µ—É (.json)</label>
        <input type="file" id="uploadJson" accept=".json" onchange="uploadDataJSON(event)" style="display:none;">
        
        <label>–ü”ô—Ç–µ—Ä ‚Ññ:</label>
        <input type="text" id="aptInput" value="1" style="width: 60px;">
        
        <button class="btn btn-blue" onclick="loadApartment()">–ö–µ—Å—Ç–µ–Ω—ñ –∫”©—Ä—Å–µ—Ç—É</button>
        
        <button class="btn btn-green" onclick="downloadDataJSON()">üíæ –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –°–∞“õ—Ç–∞—É (.json)</button> 
        
        <span id="msg" style="color:green; margin-left:10px;"></span>
    </div>
    
    <hr style="margin-top: 30px;">
    
    <div id="financeLedger">
        <h3>üí∞ “ö–∞—Ä–∂—ã–ª—ã“õ –õ–µ–¥–∂–µ—Ä (–®–æ—Ç –ë–∞—Å“õ–∞—Ä—É)</h3>
        <div class="controls">
            <select id="transactionTypeSelect" style="padding: 10px;">
                <option value="income">–ö—ñ—Ä—ñ—Å (–¢“Ø—Å—Ç—ñ)</option>
                <option value="expense">–®—ã“ì—ã—Å (–¢”©–ª–µ–Ω–¥—ñ)</option>
            </select>
            <button class="btn btn-blue" onclick="addFinanceTransaction()">‚ûï –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “ö–æ—Å—É</button>
            <button class="btn btn-green" onclick="updateFinanceLedger(true)">‚úÖ “ö–∞—Ä–∂—ã–Ω—ã –¢—ñ—Ä–∫–µ—É –∂”ô–Ω–µ –ï—Å–µ–ø—Ç–µ—É</button>
            <button class="btn btn-red" onclick="downloadFinanceLedger()">üì• “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω –ñ“Ø–∫—Ç–µ—É</button> 
        </div>
        <div id="financeLedgerTable" style="overflow-x: auto;">
            <p>“ö–∞—Ä–∂—ã–ª—ã“õ –æ–ø–µ—Ä–∞—Ü–∏—è–ª–∞—Ä–¥—ã –∫”©—Ä—É “Ø—à—ñ–Ω "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “ö–æ—Å—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑.</p>
        </div>
    </div>
    <hr style="margin-top: 30px;">

    <div id="generalReport">
        <h3>üè† –ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø (–ë–∞—Ä–ª—ã“õ “ö—ã–∑–º–µ—Ç—Ç–µ—Ä –ë—ñ—Ä –ö–µ—Å—Ç–µ–¥–µ)</h3>
        <div class="controls">
            <button class="btn btn-red" onclick="generateReport()">üìã –ï—Å–µ–ø—Ç—ñ –ñ–∞“£–∞—Ä—Ç—É/“ö“±—Ä—É</button>
            <button class="btn btn-red" onclick="downloadGeneralReport()">üì• –ñ–∞–ª–ø—ã –ï—Å–µ–ø—Ç—ñ –ñ“Ø–∫—Ç–µ—É</button>
        </div>
        <div id="reportContainer" style="margin-top: 15px; overflow-x: auto;">
            <p>–ñ–∞–ª–ø—ã –µ—Å–µ–ø—Ç—ñ –∫”©—Ä—É “Ø—à—ñ–Ω "–ï—Å–µ–ø—Ç—ñ –ñ–∞“£–∞—Ä—Ç—É/“ö“±—Ä—É" –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑.</p>
        </div>
    </div>
    
    <hr>

    <div id="editor" style="display:none;">
        <h3 id="aptTitle"></h3>
        
        <div id="ledgerEditor" style="overflow-x: auto;">
            </div>
        
        <br>
        <button class="btn btn-green" onclick="updateLedger()">‚úÖ –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ —Ç—ñ—Ä–∫–µ—É –∂”ô–Ω–µ –µ—Å–µ–ø—Ç–µ—É (–ö–µ—Å—Ç–µ–¥–µ —Å–∞“õ—Ç–∞—É)</button>
        <button class="btn btn-blue" onclick="downloadReceipt()">üì• –¢“Ø–±—ñ—Ä—Ç–µ–∫—Ç—ñ –∂“Ø–∫—Ç–µ—É</button>
    </div>
</div>

<script>
    // --- 1. –¢–ê–†–ò–§–¢–ï–† –ñ”ò–ù–ï –ö–û–ù–°–¢–ê–ù–¢–¢–ê–† ---
    const TARIFFS = { maint: 40, clean: 850, sec: 300, heat: 5, cap: 40 };
    const SERVICE_KEYS = ['maint', 'clean', 'sec', 'heat', 'cap'];
    const SERVICE_NAMES = { maint: '“Æ–π –∫“Ø—Ç—ñ–º—ñ', clean: '–¢–∞–∑–∞–ª—ã“õ', sec: '–ë–µ–π–Ω–µ–±–∞“õ—ã–ª–∞—É', heat: '–ñ—ã–ª—É –µ—Å–µ–ø.', cap: '–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥.' };
    const MONTHS_KK = ["“ö–∞“£—Ç–∞—Ä", "–ê“õ–ø–∞–Ω", "–ù–∞—É—Ä—ã–∑", "–°”ô—É—ñ—Ä", "–ú–∞–º—ã—Ä", "–ú–∞—É—Å—ã–º", "–®—ñ–ª–¥–µ", "–¢–∞–º—ã–∑", "“ö—ã—Ä–∫“Ø–π–µ–∫", "“ö–∞–∑–∞–Ω", "“ö–∞—Ä–∞—à–∞", "–ñ–µ–ª—Ç–æ“õ—Å–∞–Ω"];
    const MONTHS_RU = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

    const COMMERCIAL_APTS = ['1', '15', '16']; 
    const COMMERCIAL_MAINT_RATE = 60; 
    
    // ‚ùó –ö”®–ü –®–û–¢–¢–ê–† –¢–Ü–ó–Ü–ú–Ü
    const ACCOUNTS = ['Kaspi', 'Halyk', 'Cash']; 

    let apartments = [];
    let currentAptIndex = null;
    
    // ‚ùó “ö–ê–†–ñ–´–õ–´“ö –û–ü–ï–†–ê–¶–ò–Ø–õ–ê–†–î–´“¢ –ë–ê–°–´–ù“í–´ –î–ï–†–ï–ö–¢–ï–†–Ü
    let FINANCE_LEDGER = [
        // –ë–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–¥—ã“õ—Ç–∞—Ä–¥—ã ”ô—Ä —à–æ—Ç“õ–∞ –±”©–ª—É
        { 
            type: 'balance', 
            date: '2025-01-01', 
            description: '–ñ—ã–ª –±–∞—Å—ã–Ω–¥–∞“ì—ã –±–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–¥—ã“õ', 
            accounts: { 
                'Kaspi': 300000.00, 
                'Halyk': 100000.00, 
                'Cash': 50000.00
            }, 
            commission: 0, 
            source: 'Initial Balance' 
        }
    ];
    // =========================================================================
    
    // –ü”ò–¢–ï–† –î–ï–†–ï–ö–¢–ï–†–Ü
    const APARTMENT_DATA = [
        { id: '1', account: "0005622", area: 49.9, debt: { maint: 94909.8, clean: 22600, sec: 11100, heat: 9231.5, cap: 109836.92, overall: 247678.22 } },
        { id: '2', account: '3552225', area: 44.6, debt: { maint: 3332, clean: 1700, sec: 600, heat: 446, cap: 3568, overall: 9646 } },
        { id: '3', account: '3552233', area: 45.4, debt: { maint: 5221.4, clean: 2550, sec: 900, heat: 681, cap: 5448, overall: 14800.4 } },
        { id: '4', account: '3552241', area: 22.1, debt: { maint: 29814.4, clean: 6400, sec: 2400, heat: 1804, cap: 40864.94, overall: 81283.34 } },
        { id: '5', account: '355', area: 23, debt: { maint: 29814.4, clean: 6400, sec: 2400, heat: 1804, cap: 40864.94, overall: 81283.34 } },
        { id: '6', account: '3552268', area: 20.5, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '7', account: '3552276', area: 21.2, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '8', account: '3552284', area: 41.5, debt: { maint: 50630, clean: 21600, sec: 9600, heat: 6640, cap: 66801.72, overall: 155271.72 } },
        { id: '9', account: '3552292', area: 20.7, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '9a', account: '3559599', area: 25.7, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '10', account: '3552306', area: 36.9, debt: { maint: 37490.4, clean: 18600, sec: 7800, heat: 4428, cap: 38376, overall: 106694.4 } },
        { id: '11', account: '3552314', area: 17.2, debt: { maint: 20430, clean: 12400, sec: 4800, heat: 2752, cap: 46341.5, overall: 86723.5 } },
        { id: '11a', account: '355', area: 17.2, debt: { maint: 20430, clean: 12400, sec: 4800, heat: 2752, cap: 46341.5, overall: 86723.5  } },
        { id: '12', account: '3552322', area: 27.6, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '13', account: '3552330', area: 34.8, debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } },
        { id: '14', account: '3552349', area: 38, debt: { maint: 6940, clean: 3400, sec: 1200, heat: 760, cap: 66000, overall: 18900 } },

        { id: '15', account: '3552357', area: 69.2, debt: { maint: 102416, clean: 22600, sec: 11100, heat: 8996, cap: 71968, overall: 217080 } },
        { id: '16', account: '3552365', area: 40.7, debt: { maint: 60236, clean: 18600, sec: 7800, heat: 4884, cap: 42328, overall: 133848 } },
        { id: '17', account: '3552373', area: 49.1, debt: { maint: 23806.6, clean: 750, sec: 1500, heat: 1718.5, cap: 15712, overall: 43487.1 } },
        { id: '18', account: '3552381', area: 18.6, debt: { maint: 25854, clean: 22600, sec: 11100, heat: 3441, cap: 60868.6, overall: 123863.6 } },
        { id: '19', account: '0005800', area: 13.5, debt: { maint: 2160, clean: 3400, sec: 1200, heat: 270, cap: 2160, overall: 9190 } },
        { id: '20', account: '3552403', area: 26.4, debt: { maint: 6582.4, clean: 1600, sec: 1800, heat: 792, cap: 6336, overall: 17110.4 } },
    ];
    // =========================================================================

    // --- –ö”®–ú–ï–ö–®–Ü –§–£–ù–ö–¶–ò–Ø: –î”®“¢–ì–ï–õ–ï–ö–¢–ï–£ ---
    function roundToTenge(num) {
        if (typeof num !== 'number' || isNaN(num)) return 0;
        return Math.round(num * 100) / 100;
    }
    
    // 3. –ê–ô–õ–´“ö –ï–°–ï–ü–¢–ï–£ (–î–ï–ë–ï–¢)
    function calculateAccruals(initialArea, aptId, monthIndex) { 
        let area = initialArea; 
        
        if (aptId === '4' || aptId === '5') {
            let changedArea = aptId === '4' ? 22.1 : 23; 
            if (monthIndex >= 5 && monthIndex <= 10) { 
                area = changedArea; 
            } else if (monthIndex >= 0 && monthIndex < 5) { 
                area = 45.1; 
            }
        }
        
        let maintRate = COMMERCIAL_APTS.includes(aptId) ? COMMERCIAL_MAINT_RATE : TARIFFS.maint; 

        return {
            maint: roundToTenge(area * maintRate), 
            clean: TARIFFS.clean, 
            sec: TARIFFS.sec,     
            heat: roundToTenge(area * TARIFFS.heat), 
            cap: roundToTenge(area * TARIFFS.cap) 
        };
    }
    
    function getInitialLedger(area, aptId) {
        const zeroCalc = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 }; 
        const ledger = [];
        
        for (let i = 0; i < 12; i++) {
            let currentCharges = calculateAccruals(area, aptId, i); 
            if (i === 11) { // –ñ–µ–ª—Ç–æ“õ—Å–∞–Ω
                currentCharges = zeroCalc;
            }
            ledger.push({
                month: MONTHS_KK[i] + '. ' + MONTHS_RU[i] + ' 2025',
                charges: currentCharges,
                paymentTransactions: [], 
            });
        }
        return ledger;
    }

    // --- 5. –ñ“Æ–ô–ï–ù–Ü –ë–ê–°–¢–ê–£ –ñ”ò–ù–ï JSON –ê–†“ö–´–õ–´ –ë–ê–°“ö–ê–†–£ ---
    
    function initializeApartmentData() {
        apartments = [];
        APARTMENT_DATA.forEach(data => {
            const calculatedLedger = getInitialLedger(data.area, data.id);
            const overallSum = SERVICE_KEYS.reduce((sum, key) => sum + (data.debt[key] || 0), 0);
            
            const newApt = {
                id: data.id, 
                account: data.account, 
                area: data.area,
                initialDebt: { ...data.debt, 
                    maint: roundToTenge(data.debt.maint), 
                    clean: roundToTenge(data.debt.clean), 
                    sec: roundToTenge(data.debt.sec), 
                    heat: roundToTenge(data.debt.heat), 
                    cap: roundToTenge(data.debt.cap), 
                    overall: roundToTenge(overallSum) 
                }, 
                ledger: calculatedLedger,
                lastPay: "" 
            };
            apartments.push(newApt);
        });
        apartments.forEach(apt => calculateAccumulated(apt));
    }

    function init() {
        initializeApartmentData(); 
        updateFinanceLedger(false); 
        document.getElementById('msg').innerText = "–ë–∞—Å—Ç–∞–ø“õ—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂“Ø–∫—Ç–µ–ª–¥—ñ. –ñ“±–º—ã—Å—Ç—ã –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω JSON –∂“Ø–∫—Ç–µ“£—ñ–∑ –Ω–µ–º–µ—Å–µ —Ç”©–ª–µ–º–¥–µ—Ä –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.";
    }
    
    function downloadDataJSON() {
        if (currentAptIndex !== null) { updateLedger(false); }
        updateFinanceLedger(false);

        const fullData = {
            apartments: apartments,
            financeLedger: FINANCE_LEDGER
        };

        const dataStr = JSON.stringify(fullData, null, 4);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'kz_tulem_database_' + new Date().toISOString().slice(0, 10) + '.json';
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        
        document.getElementById('msg').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã (JSON) —Å”ô—Ç—Ç—ñ —Å–∞“õ—Ç–∞–ª–¥—ã!";
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    }

    function uploadDataJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const uploadedData = JSON.parse(e.target.result);
                
                apartments = uploadedData.apartments || APARTMENT_DATA;
                FINANCE_LEDGER = uploadedData.financeLedger || [];

                apartments.forEach(apt => calculateAccumulated(apt));
                updateFinanceLedger(false);

                document.getElementById('msg').innerText = "‚úÖ –î–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ!";
                
                if (currentAptIndex !== null) {
                    loadApartment();
                }
                
            } catch (error) {
                console.error("JSON —Ñ–∞–π–ª—ã–Ω ”©“£–¥–µ—É–¥–µ “õ–∞—Ç–µ:", error);
                document.getElementById('msg').innerText = "‚ùå JSON —Ñ–∞–π–ª—ã –¥“±—Ä—ã—Å —Ñ–æ—Ä–º–∞—Ç—Ç–∞ –µ–º–µ—Å –Ω–µ–º–µ—Å–µ –±“Ø–ª—ñ–Ω–≥–µ–Ω!";
            }
        };
        reader.readAsText(file);
    }
    
    // --- 6. –ö–£–ú–£–õ–Ø–¢–ò–í–¢–Ü –ï–°–ï–ü–¢–ï–£ –õ–û–ì–ò–ö–ê–°–´ ---
    function calculateAccumulated(apt) {
        let currentBal = { ...apt.initialDebt }; 
        
        apt.ledger.forEach((entry) => {
            let monthTotalCharge = 0;
            
            SERVICE_KEYS.forEach(key => {
                const totalPaymentForService = entry.paymentTransactions.reduce((sum, tx) => sum + (tx.amounts[key] || 0), 0);
                
                currentBal[key] = roundToTenge(currentBal[key] + entry.charges[key] - totalPaymentForService);
                monthTotalCharge += entry.charges[key];
            });

            currentBal.overall = roundToTenge(currentBal.maint + currentBal.clean + currentBal.sec + currentBal.heat + currentBal.cap);
            
            entry.accumulated = { ...currentBal };
            entry.totalMonthlyCharge = roundToTenge(monthTotalCharge); 
        });
        
        return currentBal; 
    }

    // --- 7. –õ–ï–î–ñ–ï–† –†–ï–î–ê–ö–¢–û–†–´–ù –°–´–ó–£ –ñ”ò–ù–ï –ñ“Æ–ö–¢–ï–£ (–ü”ò–¢–ï–† –ë–û–ô–´–ù–®–ê) ---
    function loadApartment() {
        const id = document.getElementById('aptInput').value.trim(); 
        
        currentAptIndex = apartments.findIndex(apt => apt.id === id); 
        
        if (currentAptIndex === -1) {
             alert(`–ü”ô—Ç–µ—Ä ‚Ññ${id} –¥–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã–Ω–¥–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã. ID-–Ω—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.`); 
            document.getElementById('editor').style.display = 'none';
            return;
        }

        const apt = apartments[currentAptIndex];
        
        document.getElementById('editor').style.display = 'block';
        document.getElementById('aptTitle').innerText = `–ü”ô—Ç–µ—Ä ${apt.id} (–®–æ—Ç: ${apt.account}) ${apt.area} –º2`;
        
        calculateAccumulated(apt); 
        renderLedgerTable(apt);
    }
    
    function renderLedgerTable(apt) {
        const editorDiv = document.getElementById('ledgerEditor');
        const displayValue = (val) => roundToTenge(val); 

        let html = `
            <table>
                <tr>
                    <th rowspan="3" style="width:120px;">–ê–π / –ú–µ—Å—è—Ü</th>
                    <th colspan="10">“ö—ã–∑–º–µ—Ç—Ç–µ—Ä (–¢–µ–Ω–≥–µ)</th>
                    <th colspan="2" class="total-col">–ñ–∞–ª–ø—ã <br> –ñ—ã–π—ã–Ω—ã</th>
                    <th rowspan="3">”ò—Ä–µ–∫–µ—Ç</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(key => `<th colspan="2">${SERVICE_NAMES[key]}</th>`).join('')}
                    <th class="total-col sub-col-header" colspan="2">–î–µ—Ä–µ–∫—Ç–µ—Ä</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(() => `<th class="sub-col-header charge-cell">–î</th><th class="sub-col-header payment-cell">–ö</th>`).join('')}
                    <th class="total-col sub-col-header charge-cell">–î</th>
                    <th class="total-col sub-col-header payment-cell">–ö (–¢”©–ª–µ–º –¥–µ—Ä–µ–≥—ñ)</th>
                </tr>
                
                <tr class="initial-debt-row">
                    <td class="month-group-header left-align">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>
                    
                    ${SERVICE_KEYS.map(key => `
                        <td class="charge-cell">${displayValue(apt.initialDebt[key])}</td><td class="payment-cell"></td>
                    `).join('')}
                    
                    <td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td>
                    <td class="total-col payment-cell"></td>
                    
                    <td></td>
                </tr>

                ${apt.ledger.map((entry, index) => {
                    
                    let monthHtml = ''; 
                    const transactionsExist = entry.paymentTransactions.length > 0;
                    
                    if (transactionsExist) {
                        
                        entry.paymentTransactions.forEach((tx, txIndex) => {
                            const totalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (tx.amounts[key] || 0), 0);
                            
                            monthHtml += `
                                <tr class="payment-row" data-month-index="${index}" data-tx-index="${txIndex}" style="background:#f0f0f0;">
                                    
                                    <td class="month-group-header left-align" ${txIndex === 0 ? `rowspan="${entry.paymentTransactions.length}"` : 'style="display:none;"'}>
                                        ${entry.month}
                                    </td>
                                    
                                    ${SERVICE_KEYS.map(key => `
                                        <td class="charge-cell">${txIndex === 0 ? displayValue(entry.charges[key]) : ''}</td>
                                        
                                        <td class="payment-cell">
                                            <input type="number" class="payment-input pay-input" 
                                                data-month-index="${index}" data-tx-index="${txIndex}" data-key="${key}"
                                                value="${tx.amounts[key] === 0 ? '' : displayValue(tx.amounts[key])}" min="0" step="0.01">
                                        </td>
                                    `).join('')}
                                    
                                    <td class="total-col charge-cell">${txIndex === 0 ? displayValue(entry.totalMonthlyCharge) : ''}</td>
                                    
                                    <td class="total-col payment-cell payment-details-cell">
                                        <div class="payment-details-inline">
                                            <span class="payment-total-amount">
                                                ${displayValue(totalTxAmount)}
                                            </span>
                                            <input type="date" class="payment-details-input date-input" data-month-index="${index}" data-tx-index="${txIndex}" data-field="date" value="${tx.date || ''}">
                                            <select class="payment-details-input bank-select" data-month-index="${index}" data-tx-index="${txIndex}" data-field="bank">
                                                ${ACCOUNTS.map(acc => `<option value="${acc}" ${tx.bank === acc ? 'selected' : ''}>${acc}</option>`).join('')}
                                            </select>
                                        </div>
                                    </td>
                                    
                                    <td ${txIndex === 0 ? `rowspan="${entry.paymentTransactions.length}"` : 'style="display:none;"'} style="text-align: center;">
                                        <div class="action-buttons-inline">
                                            <button class="btn btn-red" onclick="removeTransaction(${index}, ${txIndex})">‚ùå ”®—à—ñ—Ä—É</button>
                                            <button class="btn btn-blue" onclick="addTransaction(${index})">üí∞ –¢”©–ª–µ–º “õ–æ—Å—É</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        });

                    } else {
                         monthHtml += `
                            <tr class="charge-row" data-month-index="${index}" style="background:${entry.totalMonthlyCharge > 0 ? '#f8d7da' : '#f0f0f0'};">
                                <td class="month-group-header left-align">${entry.month}</td>
                                ${SERVICE_KEYS.map(key => `
                                    <td class="charge-cell">${displayValue(entry.charges[key])}</td>
                                    <td class="charge-cell"></td>
                                `).join('')}
                                <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td>
                                <td class="total-col charge-cell"></td>
                                <td><button class="btn btn-blue" onclick="addTransaction(${index})">üí∞ –¢”©–ª–µ–º “õ–æ—Å—É</button></td>
                            </tr>
                        `;
                    }
                    
                    const accRow = `
                        <tr class="total-acc-row">
                            <td class="month-group-header left-align">–ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã (–ê–π —Å–æ“£—ã)</td>
                            
                            ${SERVICE_KEYS.map(key => `
                                <td colspan="2" style="color: ${entry.accumulated[key] > 0 ? 'red' : 'green'};">${displayValue(entry.accumulated[key])}</td>
                            `).join('')}
                            
                            <td colspan="2" class="total-col" style="color: ${entry.accumulated.overall > 0 ? 'red' : 'green'};">${displayValue(entry.accumulated.overall)}</td>
                            <td></td>
                        </tr>
                    `;
                    return monthHtml + accRow;
                }).join('')}

            </table>
        `;
        editorDiv.innerHTML = html;
        
        document.querySelectorAll('.pay-input, .date-input, .bank-select').forEach(input => {
            input.addEventListener('change', () => updateLedger(false)); 
        });
    }
    
    // --- 8. –ü”ò–¢–ï–† –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–õ–ê–†–´–ù –ë–ê–°“ö–ê–†–£ ---
    function addTransaction(monthIndex) {
        const apt = apartments[currentAptIndex];
        const newTx = {
            amounts: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 },
            date: new Date().toISOString().slice(0, 10), 
            bank: ACCOUNTS[0] || 'Cash' 
        };
        apt.ledger[monthIndex].paymentTransactions.push(newTx);
        
        loadApartment();
    }
    
    function removeTransaction(monthIndex, txIndex) {
        if(!confirm("–¢”©–ª–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Å—ã–Ω ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) return;
        const apt = apartments[currentAptIndex];
        apt.ledger[monthIndex].paymentTransactions.splice(txIndex, 1);
        
        loadApartment();
    }

    function updateLedger(render = true) {
        const apt = apartments[currentAptIndex];
        
        document.querySelectorAll('.pay-input').forEach(input => {
            const monthIndex = parseInt(input.getAttribute('data-month-index'));
            const txIndex = parseInt(input.getAttribute('data-tx-index'));
            const key = input.getAttribute('data-key');
            
            // –ï–Ω–≥—ñ–∑—É –∫–µ–∑—ñ–Ω–¥–µ–≥—ñ –ª–æ–≥–∏–∫–∞: –±–æ—Å –±–æ–ª—Å–∞ 0 —Ä–µ—Ç—ñ–Ω–¥–µ “õ–∞–±—ã–ª–¥–∞—É
            const value = input.value === '' ? 0 : parseFloat(input.value); 

            apt.ledger[monthIndex].paymentTransactions[txIndex].amounts[key] = roundToTenge(value) || 0;
        });

        document.querySelectorAll('.date-input, .bank-select').forEach(input => {
            const monthIndex = parseInt(input.getAttribute('data-month-index'));
            const txIndex = parseInt(input.getAttribute('data-tx-index'));
            const field = input.getAttribute('data-field');
            
            if (apt.ledger[monthIndex] && apt.ledger[monthIndex].paymentTransactions[txIndex]) {
                if (field === 'bank') {
                    apt.ledger[monthIndex].paymentTransactions[txIndex].bank = input.value;
                } else if (field === 'date') {
                    apt.ledger[monthIndex].paymentTransactions[txIndex].date = input.value;
                }
            }
        });

        calculateAccumulated(apt);
        
        if (render) {
            renderLedgerTable(apt); 
            document.getElementById('msg').innerText = "‚úÖ –¢”©–ª–µ–º–¥–µ—Ä —Ç—ñ—Ä–∫–µ–ª–¥—ñ –∂”ô–Ω–µ –µ—Å–µ–ø—Ç–µ—É –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã. –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É “Ø—à—ñ–Ω üíæ –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã“£—ã–∑!";
            setTimeout(() => document.getElementById('msg').innerText = "", 5000);
        }
    }
    
    // --- 9. –¢“Æ–ë–Ü–†–¢–ï–ö –ì–ï–ù–ï–†–ê–¢–û–†–´ (”®–∑–≥–µ—Ä—ñ—Å—Å—ñ–∑ “õ–∞–ª–¥—ã—Ä—ã–ª–¥—ã) ---
    function downloadReceipt() {
        const apt = apartments[currentAptIndex];
        if (!apt) return alert("–ê–ª–¥—ã–º–µ–Ω –ø”ô—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ“£—ñ–∑.");
        calculateAccumulated(apt);

        const displayValue = (val) => roundToTenge(val); 

        let historyRows = '';
        
        historyRows += `
            <tr class="charge-row receipt-style">
                <td class="left-align bold">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>
                <td class="charge-cell">${displayValue(apt.initialDebt.maint)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.clean)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.sec)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.heat)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.cap)}</td><td></td>
                <td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td><td></td>
            </tr>`;

        apt.ledger.forEach(entry => {
            
            if (entry.paymentTransactions.length > 0) {
                const tx0 = entry.paymentTransactions[0];
                const totalTxAmount0 = SERVICE_KEYS.reduce((sum, key) => sum + (tx0.amounts[key] || 0), 0);
                const paymentDetails0 = totalTxAmount0 > 0 ? `<div style="font-size: 8px;">${displayValue(totalTxAmount0)} K${tx0.date.replace(/-/g, '.')} (${tx0.bank})</div>` : '';
                
                historyRows += `
                    <tr class="payment-row receipt-style">
                        <td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>
                        ${SERVICE_KEYS.map(key => `
                            <td class="charge-cell">${displayValue(entry.charges[key])}</td>
                            <td class="payment-cell">${displayValue(tx0.amounts[key])}</td>
                        `).join('')}
                        <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td>
                        <td class="total-col payment-cell">
                            ${paymentDetails0} 
                        </td>
                    </tr>
                `;

                   for(let txIndex = 1; txIndex < entry.paymentTransactions.length; txIndex++) {
                    const nextTx = entry.paymentTransactions[txIndex];
                    const nextTotalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (nextTx.amounts[key] || 0), 0);
                    const nextPaymentDetails = nextTotalTxAmount > 0 ? `<div style="font-size: 8px;">${displayValue(nextTotalTxAmount)} K${nextTx.date.replace(/-/g, '.')} (${nextTx.bank})</div>` : '';
                    
                    historyRows += `
                        <tr class="payment-row receipt-style">
                            <td class="left-align"></td> 
                            ${SERVICE_KEYS.map(key => `
                                <td></td><td class="payment-cell">${displayValue(nextTx.amounts[key])}</td>
                            `).join('')}
                            <td></td>
                            <td class="total-col payment-cell">
                                ${nextPaymentDetails}
                            </td>
                        </tr>
                    `;
                    }

            } else {
                 historyRows += `
                    <tr class="charge-row receipt-style">
                        <td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>
                        <td class="charge-cell">${displayValue(entry.charges.maint)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.clean)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.sec)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.heat)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.cap)}</td><td></td>
                        <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td><td></td>
                    </tr>
                `;
            }
        });
        
        const finalAccumulated = apt.ledger[11] ? apt.ledger[11].accumulated : apt.initialDebt; 
        
        const htmlContent = `
        <!DOCTYPE html>
        <html lang="kk">
        <head>
            <meta charset="UTF-8">
            <title>–¢”©–ª–µ–º –¢“Ø–±—ñ—Ä—Ç–µ–≥—ñ: –ü”ô—Ç–µ—Ä ${apt.id}</title>
            <style>
                body { font-family: Arial, serif; font-size: 11px; margin: 20px; }
                table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                th, td { border: 1px solid black; padding: 4px 6px; text-align: right; vertical-align: top; }
                .header-cell { vertical-align: top; text-align: center; font-weight: bold; padding: 6px 4px; }
                .month-header { text-align: left; font-size: 14px; font-weight: bold; }
                .acc-info { text-align: left; font-size: 10px; }
                .charge-cell { background-color: #f8f8f8; } 
                .payment-cell { background-color: #e8f5e9; }
                .total-acc-row td { background-color: #ffe082; font-weight: bold; font-size: 12px; }
                .total-col { background-color: #e3f2fd; }
                .left-align { text-align: left; }
                .center-align { text-align: center; }
                .bold { font-weight: bold; }
            </style>
        </head>
        <body>

        <table>
            <tr>
                <td class="acc-info" style="width: 25%">
                    <span class="month-header">“ö–∞—Ä–∞—à–∞ / –ù–æ—è–±—Ä—å 2025</span><br>
                    –¥–µ—Ä–±–µ—Å —à–æ—Ç. –ª–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç ${apt.account}<br>
                    Aqsai-3, 10a, <strong>${apt.id}</strong> - ${apt.area} m2<br> </td>
                
                <td colspan="2" class="header-cell">“Æ–π–¥—ñ –∫“Ø—Ç—ñ–ø “±—Å—Ç–∞—É.<br>${COMMERCIAL_APTS.includes(apt.id) ? '60' : '40'} —Ç“£–≥,–º2</td>
                <td colspan="2" class="header-cell">“Æ–π —ñ—à—ñ —Ç–∞–∑–∞–ª—ã“ì—ã.<br>850 —Ç“£–≥,–ø—Ç.–∫–≤.</td>
                <td colspan="2" class="header-cell">–ö—ñ—Ä–µ–±–µ—Ä—ñ—Å –µ—Å—ñ–∫–∫–µ...<br>300 —Ç“£–≥,–ø—Ç.–∫–≤.</td>
                <td colspan="2" class="header-cell">–ñ—ã–ª—ã—É –µ—Å–µ–ø—Ç–µ—É...<br>5 —Ç“£–≥,–º2</td>
                <td colspan="2" class="header-cell">–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥–µ—É.<br>40 —Ç“£–≥,–º2</td>
                
                <td colspan="2" class="header-cell total-col">–ñ—ã–π—ã–Ω—ã.<br>–ò—Ç–æ–≥–æ</td>
            </tr>

            <tr>
                <td class="left-align">–ê–π—ã–Ω–∞ –µ—Å–µ–ø—Ç–µ—É. –†–∞—Å—á–µ—Ç –≤ –º–µ—Å—è—Ü</td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.maint)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.clean)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.sec)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.heat)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.cap)}</td><td></td>
                <td class="total-col charge-cell">${displayValue(apt.ledger[0].totalMonthlyCharge)}</td><td></td>
            </tr>

            <tr class="total-acc-row">
                <td class="left-align">–∂—ã–π–Ω–∞–ª“ì–∞–Ω—ã, –Ω–∞–∫–æ–ø–∏–≤—à–µ–µ—Å—è</td>
                
                <td colspan="2">${displayValue(finalAccumulated.maint)}</td>
                <td colspan="2">${displayValue(finalAccumulated.clean)}</td>
                <td colspan="2">${displayValue(finalAccumulated.sec)}</td>
                <td colspan="2">${displayValue(finalAccumulated.heat)}</td>
                <td colspan="2">${displayValue(finalAccumulated.cap)}</td>
                
                <td class="total-col charge-cell">${displayValue(finalAccumulated.overall)}</td>
                
                <td class="total-col payment-cell" style="text-align: center; background: #fff3cd; padding: 4px;">
                    –¢”©–ª–µ–º–≥–µ - –ö –æ–ø–ª–∞—Ç–µ
                </td>
            </tr>

            ${historyRows}

        </table>
        
        <p style="margin-top: 30px; font-size: 10px;">–ë“±–ª —Ç“Ø–±—ñ—Ä—Ç–µ–∫ –∞–≤—Ç–æ–º–∞—Ç—Ç–∞–Ω–¥—ã—Ä—ã–ª“ì–∞–Ω –∂“Ø–π–µ –∞—Ä“õ—ã–ª—ã “õ“±—Ä—ã–ª“ì–∞–Ω.</p>
        </body>
        </html>
        `;

        const blob = new Blob([htmlContent], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `${apt.id}.html`; 
        link.click();
        
        document.getElementById('msg').innerText = `–ü”ô—Ç–µ—Ä ‚Ññ${apt.id} “Ø—à—ñ–Ω —Ç“Ø–±—ñ—Ä—Ç–µ–∫ –∂“Ø–∫—Ç–µ–ª–¥—ñ!`;
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    }

// --- 10. –ñ–ê–õ–ü–´ –ñ–ò–´–ù–¢–´“ö –ï–°–ï–ü–¢–Ü “ö“∞–†–£ (–ë–ê–†–õ–´“ö “ö–´–ó–ú–ï–¢–¢–ï–† –ë–Ü–† –ö–ï–°–¢–ï“¢–î–ï) ---

function generateReport() {
    // –ï—Å–µ–ø—Ç—ñ “õ“±—Ä—É –∞–ª–¥—ã–Ω–¥–∞ –±–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É –∂”ô–Ω–µ –µ—Å–µ–ø—Ç–µ—É–¥—ñ –∂–∞“£–∞—Ä—Ç—É
    apartments.forEach(apt => calculateAccumulated(apt));

    const monthlyReport = {}; 
    const totalApts = apartments.length;
    const year = '2025'; 

    // 1. –ê–≥—Ä–µ–≥–∞—Ç—Ç—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂–∏–Ω–∞—É
    for (let i = 0; i < 12; i++) { // 12 –∞–π (0-–¥–µ–Ω 11-–≥–µ –¥–µ–π—ñ–Ω)
        const monthName = MONTHS_KK[i];
        
        // –ë–∞—Å—Ç–∞–ø“õ—ã –Ω”©–ª–¥—ñ–∫ –º”ô–Ω–¥–µ—Ä
        let totalArea = 0;
        let totalCharges = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
        let totalPayments = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 };
        let apartmentsPaid = 0;
        let monthlyTotalCharge = 0;
        let monthlyTotalPayment = 0;


        apartments.forEach(apt => {
            const entry = apt.ledger[i];
            if (!entry) return;

            // –ê) –ü”ô—Ç–µ—Ä –∞—É–¥–∞–Ω—ã
            let currentArea = apt.area;
            if (apt.id === '4' || apt.id === '5') {
                let changedArea = apt.id === '4' ? 22.1 : 23;
                if (i >= 5 && i <= 10) { 
                    currentArea = changedArea; 
                } else if (i >= 0 && i < 5) { 
                    currentArea = apt.area; 
                }
            }
            totalArea += currentArea;

            // ”ò) –ñ–æ—Å–ø–∞—Ä –±–æ–π—ã–Ω—à–∞ –µ—Å–µ–ø—Ç–µ—É–ª–µ—Ä (–î–µ–±–µ—Ç)
            SERVICE_KEYS.forEach(key => {
                totalCharges[key] += entry.charges[key];
            });
            monthlyTotalCharge += entry.totalMonthlyCharge;

            // –ë) –ù–∞“õ—Ç—ã —Ç”©–ª–µ–º–¥–µ—Ä (–ö—Ä–µ–¥–∏—Ç)
            const monthPayments = entry.paymentTransactions;
            if (monthPayments.length > 0) {
                 const paidTxExists = monthPayments.some(tx => 
                     SERVICE_KEYS.some(key => tx.amounts[key] > 0)
                 );
                 if (paidTxExists) {
                     apartmentsPaid++;
                 }

                monthPayments.forEach(tx => {
                    SERVICE_KEYS.forEach(key => {
                        totalPayments[key] += tx.amounts[key];
                    });
                });
                monthlyTotalPayment += monthPayments.reduce((sum, tx) => sum + SERVICE_KEYS.reduce((ts, key) => ts + tx.amounts[key], 0), 0);
            }
        });
        
        // –ê–π–ª—ã“õ –∂–∏—ã–Ω—Ç—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É
        monthlyReport[monthName] = {
            totalArea: roundToTenge(totalArea),
            totalCharges: totalCharges, 
            totalPayments: totalPayments, 
            apartmentsPaid: apartmentsPaid,
            monthlyTotalCharge: roundToTenge(monthlyTotalCharge),
            monthlyTotalPayment: roundToTenge(monthlyTotalPayment),
        };
    }
    
    renderReportTables(monthlyReport, totalApts, year);
    document.getElementById('msg').innerText = "‚úÖ –ñ–∞–ª–ø—ã –µ—Å–µ–ø —Å”ô—Ç—Ç—ñ “õ“±—Ä—ã–ª–¥—ã!";
    setTimeout(() => document.getElementById('msg').innerText = "", 3000);
}

// 2. –ï—Å–µ–ø –ö–µ—Å—Ç–µ—Å—ñ–Ω (–ë–∞—Ä–ª—ã“õ “ö—ã–∑–º–µ—Ç—Ç–µ—Ä –ë—ñ—Ä –ö–µ—Å—Ç–µ–¥–µ) –ö”©—Ä—Å–µ—Ç—É
function renderReportTables(reportData, totalApts, year) {
    const container = document.getElementById('reportContainer');
    const displayValue = (val) => roundToTenge(val).toLocaleString('kk-KZ'); 

    // –ë–∞“ì–∞–Ω–¥–∞—Ä–¥—ã –µ—Å–µ–ø—Ç–µ—É
    const numServices = SERVICE_KEYS.length;
    const colspanServices = numServices * 2; // <-- Syntax Error FIXED here
    
    let html = `
        <h4 style="margin-top: 20px; background: #cce5ff; padding: 5px;">
            –ñ—ã–ª: ${year} | –ë–∞—Ä–ª—ã“õ –ø”ô—Ç–µ—Ä–ª–µ—Ä: ${totalApts} | –ë–∞—Ä–ª—ã“õ “õ—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ –∞–π–ª—ã“õ –∂–∏—ã–Ω—Ç—ã“õ –µ—Å–µ–ø
        </h4>
        <table style="width: 100%; font-size: 10px; table-layout: fixed;">
            <thead>
                <tr>
                    <th rowspan="3" style="width: 5%;">–ê–π</th>
                    <th rowspan="3" style="width: 5%;">–¢”©–ª–µ–≥–µ–Ω –ø”ô—Ç–µ—Ä —Å–∞–Ω—ã</th>
                    <th rowspan="3" style="width: 5%;">–ñ–∞–ª–ø—ã –∞—É–¥–∞–Ω (–º2)</th>
                    <th colspan="${colspanServices}">“ö—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ –ñ–æ—Å–ø–∞—Ä (–ï—Å–µ–ø—Ç–µ–ª–≥–µ–Ω) –∂”ô–Ω–µ –ù–∞“õ—Ç—ã –¢”©–ª–µ–º–¥–µ—Ä (–§–∞–∫—Ç)</th>
                    <th colspan="${numServices + 1}">–ê–π —Å–æ“£—ã–Ω–¥–∞“ì—ã –∂–∏–Ω–∞“õ—Ç–∞–ª“ì–∞–Ω –∂–∞–ª–ø—ã “õ–∞—Ä—ã–∑</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(key => `<th colspan="2" style="background: #e0f7fa;">${SERVICE_NAMES[key]}</th>`).join('')}
                    <th rowspan="2" style="width: 8%; background: #fff3cd;">–ñ–∞–ª–ø—ã –ï—Å–µ–ø.</th>
                    ${SERVICE_KEYS.map(key => `<th style="background: #f8d7da;">${SERVICE_NAMES[key]}</th>`).join('')}
                    <th rowspan="2" style="width: 8%; background: #ffe680;">–ñ–∞–ª–ø—ã “ö–∞—Ä—ã–∑</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(() => `<th style="background:#fff3cd;">–î</th><th style="background:#d4edda;">–ö</th>`).join('')}
                </tr>
            </thead>
            <tbody>
    `;

    let totalChargesYear = 0;
    let totalPaymentsYear = 0;
    
    MONTHS_KK.forEach((month, index) => {
        const data = reportData[month];
        if (!data) return;
        
        totalChargesYear += data.monthlyTotalCharge;
        totalPaymentsYear += data.monthlyTotalPayment;
        
        // –ñ–∏–Ω–∞“õ—Ç–∞–ª“ì–∞–Ω “õ–∞—Ä—ã–∑–¥—ã –µ—Å–µ–ø—Ç–µ—É
        const totalOverallAccumulated = apartments.reduce((sum, apt) => {
            const entry = apt.ledger[index];
            const currentAccumulated = apt.ledger[index] ? apt.ledger[index].accumulated.overall : apt.initialDebt.overall;
            return roundToTenge(sum + currentAccumulated);
        }, 0);

        html += `
            <tr>
                <td style="text-align: left; font-weight: bold;">${month} ${year}</td>
                <td style="text-align: center;">${data.apartmentsPaid} / ${totalApts}</td>
                <td>${displayValue(data.totalArea)}</td>
                
                ${SERVICE_KEYS.map(key => `
                    <td style="background:#fff3cd;">${displayValue(data.totalCharges[key])}</td>
                    <td style="background:#d4edda;">${displayValue(data.totalPayments[key])}</td>
                `).join('')}
                
                <td style="background: #fff3cd; font-weight: bold;">${displayValue(data.monthlyTotalCharge)}</td>
                
                ${SERVICE_KEYS.map(key => {
                    const monthlyAccumulatedDebt = apartments.reduce((sum, apt) => {
                         const accumulated = apt.ledger[index] ? apt.ledger[index].accumulated : apt.initialDebt;
                         return roundToTenge(sum + (accumulated[key] || 0));
                    }, 0);
                    return `<td style="background:#f8d7da; color: ${monthlyAccumulatedDebt > 0 ? 'red' : 'green'};">${displayValue(monthlyAccumulatedDebt)}</td>`;
                }).join('')}
                
                <td style="background: #ffe680; font-weight: bold; color: ${totalOverallAccumulated > 0 ? 'red' : 'green'};">
                    ${displayValue(totalOverallAccumulated)}
                </td>
            </tr>
        `;
    });
    
    // –ñ—ã–ª–¥—ã“õ “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã
    let finalDebtOverall = apartments.reduce((sum, apt) => {
        const lastEntry = apt.ledger[apt.ledger.length - 1];
        return roundToTenge(sum + (lastEntry ? lastEntry.accumulated.overall : apt.initialDebt.overall));
    }, 0);
    
    let finalDebtService = {};
    SERVICE_KEYS.forEach(key => {
        finalDebtService[key] = apartments.reduce((sum, apt) => {
            const lastEntry = apt.ledger[apt.ledger.length - 1];
            return roundToTenge(sum + (lastEntry ? lastEntry.accumulated[key] : apt.initialDebt[key]));
        }, 0);
    });

    html += `
            <tr style="background: #e9ecef; font-weight: bold; font-size: 11px;">
                <td colspan="3" style="text-align: right;">–ñ–´–õ–î–´“ö –ñ–ò–´–ù–¢–´“ö (–ï—Å–µ–ø—Ç–µ–ª–≥–µ–Ω/–¢”©–ª–µ–Ω–≥–µ–Ω):</td>
                
                ${SERVICE_KEYS.map(key => `
                    <td style="background:#ffe0b2;">${displayValue(reportData[MONTHS_KK[10]].totalCharges[key] + reportData[MONTHS_KK[11]].totalCharges[key])}</td>
                    <td style="background:#c8e6c9;">${displayValue(reportData[MONTHS_KK[10]].totalPayments[key] + reportData[MONTHS_KK[11]].totalPayments[key])}</td>
                `).join('')}
                
                <td style="background:#ffe0b2;">${displayValue(totalChargesYear)}</td>
                
                <td colspan="${numServices + 1}" style="background: #f8d7da;"></td>
            </tr>
            <tr style="background: #f8d7da; font-weight: bold; font-size: 11px;">
                <td colspan="${colspanServices + 4}" style="text-align: right;">–ñ–´–õ –°–û“¢–´–ù–î–ê“í–´ –ë–ê–†–õ–´“ö “ö–ê–†–´–ó (“ö—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞):</td>
                
                ${SERVICE_KEYS.map(key => `
                    <td style="color: ${finalDebtService[key] > 0 ? 'red' : 'green'};">${displayValue(finalDebtService[key])}</td>
                `).join('')}
                
                <td style="background: #e0f7fa; color: ${finalDebtOverall > 0 ? 'red' : 'green'};">${displayValue(finalDebtOverall)}</td>
            </tr>
            </tbody>
        </table>
        <p style="margin-top: 10px; font-size: 10px;">–î: –ñ–æ—Å–ø–∞—Ä –±–æ–π—ã–Ω—à–∞ –µ—Å–µ–ø—Ç–µ–ª–≥–µ–Ω (–î–µ–±–µ—Ç) | –ö: –ù–∞“õ—Ç—ã —Ç”©–ª–µ–Ω–≥–µ–Ω (–ö—Ä–µ–¥–∏—Ç)</p>
    `;

    container.innerHTML = html;
}

// --- –ñ–ê“¢–ê –§–£–ù–ö–¶–ò–Ø: –ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø—Ç—ñ –ñ“Ø–∫—Ç–µ—É ---
function downloadGeneralReport() {
    // –ï—Å–µ–ø—Ç—ñ“£ –µ“£ —Å–æ“£“ì—ã –Ω“±—Å“õ–∞—Å—ã–Ω –∞–ª—É “Ø—à—ñ–Ω generateReport —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω —à–∞“õ—ã—Ä—É
    generateReport(); 

    const reportContent = document.getElementById('reportContainer').innerHTML;
    if (!reportContent.includes('<table')) {
        return alert("–ê–ª–¥—ã–º–µ–Ω '–ï—Å–µ–ø—Ç—ñ –ñ–∞“£–∞—Ä—Ç—É/“ö“±—Ä—É' –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã–ø, –µ—Å–µ–ø—Ç—ñ “õ“±—Ä—ã“£—ã–∑!");
    }
    
    const htmlStyle = `
        <style>
            body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
            th, td { border: 1px solid #ddd; padding: 4px; text-align: right; vertical-align: top; }
            th { background: #f8f9fa; }
            /* “ö–æ—Å—ã–º—à–∞ —Å—Ç–∏–ª—å–¥–µ—Ä */
            .total-col { background-color: #e3f2fd; }
            .sub-col-header { background: #e9ecef; }
            .total-acc-row td { background-color: #ffe680; font-weight: bold; }
            .left-align { text-align: left; }
            .right-align { text-align: right; }
        </style>
    `;

    const fullHtml = `
        <!DOCTYPE html>
        <html lang="kk">
        <head>
            <meta charset="UTF-8">
            <title>–ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø</title>
            ${htmlStyle}
        </head>
        <body>
            <h3>üè† –ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø (–ë–∞—Ä–ª—ã“õ “ö—ã–∑–º–µ—Ç—Ç–µ—Ä –ë—ñ—Ä –ö–µ—Å—Ç–µ–¥–µ)</h3>
            ${reportContent}
        </body>
        </html>
    `;

    const blob = new Blob([fullHtml], {type: "text/html"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `kz_general_report_${new Date().toISOString().slice(0, 10)}.html`; 
    link.click();
    
    document.getElementById('msg').innerText = "‚úÖ –ñ–∞–ª–ø—ã –ê–π–ª—ã“õ –ï—Å–µ–ø —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ!";
    setTimeout(() => document.getElementById('msg').innerText = "", 3000);
}

// --- 11. “ö–ê–†–ñ–´–õ–´“ö –û–ü–ï–†–ê–¶–ò–Ø–õ–ê–†–î–´ –ë–ê–°“ö–ê–†–£ (–ö”®–ü –®–û–¢–¢–´ –ñ”ò–ù–ï –´“ö–®–ê–ú) ---

    // ‚ùó “ö–û–°–´–ú–®–ê –§–£–ù–ö–¶–ò–Ø–õ–ê–† (–ù”®–õ–î–ï–†–î–Ü –ë–ê–°“ö–ê–†–£)
    function clearZero(input) {
        if (input.value === '0') {
            input.value = '';
        }
    }
    function fillZero(input) {
        if (input.value === '' || isNaN(parseFloat(input.value))) {
            input.value = '0';
        }
    }

    function addFinanceTransaction() {
        const type = document.getElementById('transactionTypeSelect').value;
        const newTx = {
            type: type,
            date: new Date().toISOString().slice(0, 10),
            description: type === 'income' ? '–ü”ô—Ç–µ—Ä–ª–µ—Ä–¥–µ–Ω —Ç“Ø—Å–∫–µ–Ω –∂–∏—ã–Ω—Ç—ã“õ —Ç”©–ª–µ–º' : '“ö—ã–∑–º–µ—Ç–∫–µ —Ç”©–ª–µ–Ω–≥–µ–Ω —à—ã“ì—ã—Å',
            account: ACCOUNTS[0], 
            amount: 0,
            commission: 0,
            source: type === 'income' ? 'Payment' : 'Service'
        };
        FINANCE_LEDGER.push(newTx);
        FINANCE_LEDGER.sort((a, b) => new Date(a.date) - new Date(b.date));
        updateFinanceLedger(true);
    }

    function removeFinanceTransaction(index) {
        if (FINANCE_LEDGER[index].type === 'balance') {
            alert("–ë–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–¥—ã“õ—Ç—ã ”©—à—ñ—Ä—É–≥–µ –±–æ–ª–º–∞–π–¥—ã!");
            return;
        }
        if (!confirm("“ö–∞—Ä–∂—ã–ª—ã“õ –æ–ø–µ—Ä–∞—Ü–∏—è–Ω—ã ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) return;
        FINANCE_LEDGER.splice(index, 1);
        updateFinanceLedger(true);
    }

    function updateFinanceLedger(render = true) {
        if (render) {
            document.querySelectorAll('.finance-tx-input').forEach(input => {
                const index = parseInt(input.getAttribute('data-index'));
                const field = input.getAttribute('data-field');
                const tx = FINANCE_LEDGER[index];
                
                if (!tx) return;
                
                // –ë–∞—Ä–ª—ã“õ number input-—Ç–∞—Ä–¥—ã“£ –±–æ—Å –º”ô–Ω—ñ–Ω 0-–≥–µ –∞—É—ã—Å—Ç—ã—Ä—É
                if (input.type === 'number' && input.value === '') {
                    input.value = '0';
                }

                if (tx.type === 'balance' && field === 'accounts') {
                    const acc = input.getAttribute('data-account');
                    tx.accounts[acc] = roundToTenge(parseFloat(input.value) || 0);
                }
                else if (field === 'amount' || field === 'commission') {
                    const amountInput = document.querySelector(`[data-index="${index}"][data-field="amount"]:not([readonly])`);
                    if (amountInput) {
                         tx.amount = roundToTenge(parseFloat(amountInput.value) || 0);
                    }
                    if (field === 'commission') {
                         tx.commission = roundToTenge(parseFloat(input.value) || 0);
                    }
                } else if (field === 'account' || field === 'description' || field === 'date' || field === 'source') {
                    tx[field] = input.value;
                }
            });
        }
        
        let balances = {};
        ACCOUNTS.forEach(acc => balances[acc] = 0); 

        FINANCE_LEDGER.forEach(tx => {
            if (tx.type === 'balance') {
                ACCOUNTS.forEach(acc => {
                    balances[acc] = roundToTenge(tx.accounts[acc] || 0);
                });
            } else {
                let netAmount = tx.amount - tx.commission;
                let factor = tx.type === 'income' ? 1 : -1;
                
                if (tx.account && balances.hasOwnProperty(tx.account)) {
                    balances[tx.account] = roundToTenge(balances[tx.account] + netAmount * factor);
                }
            }
            tx.balancesAfter = { ...balances };
        });
        
        if (render) {
            renderFinanceLedgerTable();
            document.getElementById('msg').innerText = "‚úÖ “ö–∞—Ä–∂—ã–ª—ã“õ –ª–µ–¥–∂–µ—Ä –∂–∞“£–∞—Ä—Ç—ã–ª–¥—ã.";
            setTimeout(() => document.getElementById('msg').innerText = "", 3000);
        }
    }

    function renderFinanceLedgerTable() {
        const container = document.getElementById('financeLedgerTable');
        const displayValue = (val) => roundToTenge(val).toLocaleString('kk-KZ'); 

        const lastTx = FINANCE_LEDGER[FINANCE_LEDGER.length - 1];
        const finalBalances = lastTx ? lastTx.balancesAfter : {};
        const totalOverallBalance = ACCOUNTS.reduce((sum, acc) => sum + (finalBalances[acc] || 0), 0);

        let html = `
            <table style="table-layout: auto;">
                <thead>
                    <tr class="finance-header">
                        <th rowspan="2" style="width: 70px;">–ö“Ø–Ω—ñ</th>
                        <th rowspan="2" style="width: 250px;">–¢“Ø—Å—ñ–Ω—ñ–∫—Ç–µ–º–µ (–ù–µ “Ø—à—ñ–Ω)</th>
                        <th rowspan="2" style="width: 90px; background: #d4edda;">–ö—ñ—Ä—ñ—Å —Å–æ–º–∞—Å—ã</th>
                        <th rowspan="2" style="width: 90px; background: #f8d7da;">–®—ã“ì—ã—Å —Å–æ–º–∞—Å—ã</th>
                        <th rowspan="2" style="width: 80px;">–ö–æ–º–∏—Å—Å–∏—è</th>
                        <th rowspan="2" style="width: 90px;">–®–æ—Ç</th>
                        <th colspan="${ACCOUNTS.length}" class="account-balance-cell">–®–æ—Ç—Ç–∞—Ä–¥–∞“ì—ã “ö–∞–ª–¥—ã“õ (–ë–∞–ª–∞–Ω—Å)</th>
                        <th rowspan="2" style="width: 70px;">”ò—Ä–µ–∫–µ—Ç</th>
                    </tr>
                    <tr class="finance-header">
                        ${ACCOUNTS.map(acc => `<th class="account-balance-cell">${acc}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
        `;

        FINANCE_LEDGER.forEach((tx, index) => {
            const isBalance = tx.type === 'balance';
            const isIncome = tx.type === 'income';
            const isExpense = tx.type === 'expense';
            
            const rowClass = isBalance ? 'balance-row' : (isIncome ? 'income-row' : 'expense-row');
            
            const balanceInputStyle = isBalance ? 'readonly' : '';
            
            // –ú”ô–Ω 0 –±–æ–ª—Å–∞, –µ–Ω–≥—ñ–∑—É ”©—Ä—ñ—Å—ñ–Ω–¥–µ –±–æ—Å “õ–∞–ª–¥—ã—Ä—É “Ø—à—ñ–Ω
            const amountValue = isBalance ? '' : (tx.amount === 0 ? '' : roundToTenge(tx.amount));
            const incomeAmount = isIncome ? amountValue : '';
            const expenseAmount = isExpense ? amountValue : '';
            const commissionAmount = tx.commission === 0 ? '' : roundToTenge(tx.commission);

            
            // onfocus/onblur –ª–æ–≥–∏–∫–∞—Å—ã —Ç–µ–∫ –ö—ñ—Ä—ñ—Å, –®—ã“ì—ã—Å –∂”ô–Ω–µ –ö–æ–º–∏—Å—Å–∏—è ”©—Ä—ñ—Å—Ç–µ—Ä—ñ–Ω–µ “õ–æ—Å—ã–ª–∞–¥—ã
            const focusAttr = `onfocus="this.value==='0' && (this.value='')"`;
            const blurAttr = `onblur="this.value==='' && (this.value='0'); updateFinanceLedger(false)"`;

            html += `
                <tr class="${rowClass}">
                    <td class="left-align">
                        <input type="date" class="small-input finance-tx-input" data-index="${index}" data-field="date" value="${tx.date}" style="width: 95%;" ${balanceInputStyle}>
                    </td>
                    <td class="left-align">
                        <input type="text" class="description-input finance-tx-input" data-index="${index}" data-field="description" value="${tx.description}" ${balanceInputStyle}>
                    </td>
                    
                    <td style="background: #d4edda;">
                        <input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="amount" value="${incomeAmount}" ${!isIncome || isBalance ? 'readonly' : focusAttr + blurAttr}>
                    </td>
                    
                    <td style="background: #f8d7da;">
                        <input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="amount" value="${expenseAmount}" ${!isExpense || isBalance ? 'readonly' : focusAttr + blurAttr}>
                    </td>
                    
                    <td>
                        <input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="commission" value="${commissionAmount}" ${isBalance ? 'readonly' : focusAttr + blurAttr}>
                    </td>
                    
                    <td>
                        <select class="finance-input finance-tx-input" data-index="${index}" data-field="account" style="width: 95%;" ${isBalance ? 'readonly' : ''} ${isBalance ? 'disabled' : ''}>
                             ${isBalance ? `<option value="">-</option>` : ''}
                             ${ACCOUNTS.map(acc => `<option value="${acc}" ${tx.account === acc ? 'selected' : ''}>${acc}</option>`).join('')}
                        </select>
                    </td>

                    ${ACCOUNTS.map(acc => {
                        let balance = isBalance ? tx.accounts[acc] : tx.balancesAfter[acc];
                        let content;
                        
                        if (isBalance) {
                            // –ë–∞—Å—Ç–∞–ø“õ—ã “õ–∞–ª–¥—ã“õ—Ç–∞—Ä–¥–∞ –º”ô–Ω –±–æ—Å –±–æ–ª–º–∞–π–¥—ã
                            content = `<input type="number" class="finance-input finance-tx-input" data-index="${index}" data-field="accounts" data-account="${acc}" value="${roundToTenge(tx.accounts[acc] || 0)}" style="width: 95%; font-weight: bold;">`;
                        } else {
                            content = displayValue(balance);
                        }
                        return `<td class="account-balance-cell">${content}</td>`;
                    }).join('')}
                    
                    <td>
                        ${!isBalance ? `<button class="btn btn-red" style="font-size: 10px; padding: 3px;" onclick="removeFinanceTransaction(${index})">‚ùå</button>` : ''}
                    </td>
                </tr>
            `;
        });
        
        // –ñ–∞–ª–ø—ã “õ–æ—Ä—ã—Ç—ã–Ω–¥—ã –∂–æ–ª—ã
        html += `
            <tr class="account-total-balance">
                <td colspan="6" style="text-align: right; font-size: 14px;">
                    –ë–ê–†–õ–´“ö –®–û–¢–¢–ê–†–î–ê“í–´ –ñ–ê–õ–ü–´ “ö–ê–õ–î–´“ö:
                </td>
                <td colspan="${ACCOUNTS.length}" class="account-total-balance" style="text-align: right; font-size: 14px; background: #ffc107;">
                    ${displayValue(totalOverallBalance)}
                </td>
                <td></td>
            </tr>
        `;

        html += `
            </tbody>
        </table>`;
        container.innerHTML = html;
        
        // change –æ“õ–∏“ì–∞–ª–∞—Ä—ã–Ω “õ–∞–π—Ç–∞ “õ–æ—Å—É
        document.querySelectorAll('.finance-tx-input').forEach(input => {
             // onblur-–¥–µ updateFinanceLedger(false) —à–∞“õ—ã—Ä—ã–ª“ì–∞–Ω. “ö–æ—Å—ã–º—à–∞ change —Ç—ã“£–¥–∞—É—à—ã—Å—ã “õ–∞–∂–µ—Ç –µ–º–µ—Å.
        });
    }

    // --- –ñ–ê“¢–ê –§–£–ù–ö–¶–ò–Ø: “ö–∞—Ä–∂—ã –õ–µ–¥–∂–µ—Ä—ñ–Ω –ñ“Ø–∫—Ç–µ—É ---
    function downloadFinanceLedger() {
        // –ï—Å–µ–ø—Ç—ñ“£ –µ“£ —Å–æ“£“ì—ã –Ω“±—Å“õ–∞—Å—ã–Ω –∞–ª—É “Ø—à—ñ–Ω updateFinanceLedger —Ñ—É–Ω–∫—Ü–∏—è—Å—ã–Ω —à–∞“õ—ã—Ä—É
        updateFinanceLedger(true); 

        const ledgerContent = document.getElementById('financeLedgerTable').innerHTML;
        if (!ledgerContent.includes('<table')) {
            return alert("–ê–ª–¥—ã–º–µ–Ω '“ö–∞—Ä–∂—ã–Ω—ã –¢—ñ—Ä–∫–µ—É –∂”ô–Ω–µ –ï—Å–µ–ø—Ç–µ—É' –±–∞—Ç—ã—Ä–º–∞—Å—ã–Ω –±–∞—Å—ã–ø, –ª–µ–¥–∂–µ—Ä–¥—ñ “õ“±—Ä—ã“£—ã–∑!");
        }

        const htmlStyle = `
            <style>
                body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
                table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; }
                th, td { border: 1px solid #ddd; padding: 4px; text-align: right; vertical-align: top; }
                /* “ö–æ—Å—ã–º—à–∞ —Å—Ç–∏–ª—å–¥–µ—Ä */
                .finance-header { background: #cce5ff; font-weight: bold; }
                .income-row { background: #d4edda; } 
                .expense-row { background: #f8d7da; } 
                .balance-row { background: #ffe080; font-weight: bold; } 
                .account-balance-cell { background: #e3f2fd; font-weight: bold; }
                .account-total-balance { background: #ffc107; font-weight: bold; }
                .left-align { text-align: left; }
                input { display:none; } /* –ñ“Ø–∫—Ç–µ–ª–≥–µ–Ω —Ñ–∞–π–ª–¥–∞“ì—ã input ”©—Ä—ñ—Å—Ç–µ—Ä—ñ–Ω –∂–∞—Å—ã—Ä—É */
                select { display: none; }
                button { display: none; }
            </style>
        `;

        const fullHtml = `
            <!DOCTYPE html>
            <html lang="kk">
            <head>
                <meta charset="UTF-8">
                <title>“ö–∞—Ä–∂—ã–ª—ã“õ –õ–µ–¥–∂–µ—Ä (–®–æ—Ç –ë–∞—Å“õ–∞—Ä—É)</title>
                ${htmlStyle}
            </head>
            <body>
                <h3>üí∞ “ö–∞—Ä–∂—ã–ª—ã“õ –õ–µ–¥–∂–µ—Ä (–®–æ—Ç –ë–∞—Å“õ–∞—Ä—É) - ${new Date().toISOString().slice(0, 10)}</h3>
                ${ledgerContent}
            </body>
            </html>
        `;

        const blob = new Blob([fullHtml], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `kz_finance_ledger_${new Date().toISOString().slice(0, 10)}.html`; 
        link.click();
        
        document.getElementById('msg').innerText = "‚úÖ “ö–∞—Ä–∂—ã–ª—ã“õ –õ–µ–¥–∂–µ—Ä —Å”ô—Ç—Ç—ñ –∂“Ø–∫—Ç–µ–ª–¥—ñ!";
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    }
    
</script>
</body>
</html>
