<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <title>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ</title>
    <style>
        /* –ë–ê–°“ö–ê–†–£ –ü–ê–ù–ï–õ–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü */
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .admin-panel { max-width: 1500px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 10px 15px; cursor: pointer; color: white; border: none; border-radius: 4px; font-weight: bold; }
        .btn-green { background: #28a745; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        input[type="number"], input[type="date"], select { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }
        
        /* –õ–ï–î–ñ–ï–† –ö–ï–°–¢–ï–°–Ü–ù–Ü“¢ –°–¢–ò–õ–Ü */
        #ledgerEditor table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 11px; min-width: 1300px; }
        #ledgerEditor th, #ledgerEditor td { border: 1px solid #ddd; padding: 4px; text-align: right; vertical-align: top; }
        #ledgerEditor th { background: #f8f9fa; }
        
        /* –ñ–æ–ª–¥–∞—Ä–¥—ã“£ —Ç“Ø—Å—Ç–µ—Ä—ñ –º–µ–Ω –º”ô—Ç—ñ–Ω—ñ */
        .month-group-header { text-align: left; font-weight: bold; background: #e0f7fa; }
        .payment-row:not(:first-child) { background: #d4edda; } 
        .total-acc-row td { background: #ffe680; font-weight: bold; font-size: 12px; } /* –ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã (–°–∞—Ä—ã) */
        .total-col { background: #e9e9ff; } /* –ñ–∞–ª–ø—ã –±–∞“ì–∞–Ω (–ö”©–∫—à—ñ–ª) */
        
        .sub-col-header { background: #e9ecef; }
        .payment-input { width: 60px; }
        .small-input { width: 90%; }
        .left-align { text-align: left; }
        .center-align { text-align: center; }
        
        /* INPUT/SELECT/–°–û–ú–ê –ë–Ü–† “ö–ê–¢–ê–†–î–ê */
        .payment-details-inline { 
            display: flex; 
            gap: 5px; 
            justify-content: space-between; 
            align-items: center;
            font-size: 9px; 
        }
        .payment-details-input { 
            width: 60px; 
        }
        .payment-total-amount { 
            font-size: 11px; 
            font-weight: bold;
        }
        
        /* ”ò–†–ï–ö–ï–¢ –ë–ê–¢–´–†–ú–ê–õ–ê–†–´–ù–´“¢ –ë–Ü–† “ö–ê–¢–ê–†–î–ê –¢“∞–†–£–´–ù “ö–ê–ú–¢–ê–ú–ê–°–´–ó –ï–¢–£ */
        .action-buttons-inline {
            display: flex;
            flex-direction: column; 
            gap: 3px; 
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 2px 0;
        }
        .action-buttons-inline button {
            width: 100%;
            padding: 3px 5px;
            font-size: 10px;
        }

        /* –ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑ –∂–æ–ª—ã–Ω—ã“£ —Å—Ç–∏–ª—ñ */
        .initial-debt-row .charge-cell { background: #fff3cd; } 
        .initial-debt-row td { font-weight: bold; }
    </style>
</head>
<body onload="init()">

<div class="admin-panel">
    <h2>–¢”©–ª–µ–º –µ—Å–µ–ø—Ç–µ—É –ë–∞—Å“õ–∞—Ä—É –ü–∞–Ω–µ–ª—ñ</h2>
    <div class="controls">
        <label>–ü”ô—Ç–µ—Ä ‚Ññ:</label>
        <input type="number" id="aptInput" value="1" min="1" max="200" style="width: 60px;">
        <button class="btn btn-blue" onclick="loadApartment()">–ö–µ—Å—Ç–µ–Ω—ñ –∂“Ø–∫—Ç–µ—É</button>
        <button class="btn btn-green" onclick="saveData()">üíæ –ë–∞—Ä–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É</button>
        <span id="msg" style="color:green; margin-left:10px;"></span>
    </div>
    
    <hr>

    <div id="editor" style="display:none;">
        <h3 id="aptTitle"></h3>
        
        <div id="ledgerEditor" style="overflow-x: auto;">
            </div>
        
        <br>
        <button class="btn btn-green" onclick="updateLedger()">‚úÖ –õ–µ–¥–∂–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É (–ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã–Ω “õ–∞–π—Ç–∞ –µ—Å–µ–ø—Ç–µ—É)</button>
        <button class="btn btn-blue" onclick="downloadReceipt()">üì• –¢“Ø–±—ñ—Ä—Ç–µ–∫—Ç—ñ –∂“Ø–∫—Ç–µ—É (–°–∫—Ä–∏–Ω—à–æ—Ç “Ø–ª–≥—ñ—Å—ñ)</button>
    </div>
</div>

<script>
    // --- 1. –¢–ê–†–ò–§–¢–ï–† –ñ”ò–ù–ï –ö–û–ù–°–¢–ê–ù–¢–¢–ê–† ---
    // –ù–µ–≥—ñ–∑–≥—ñ —Ç–∞—Ä–∏—Ñ: 40 —Ç–≥/–º2
    const TARIFFS = { maint: 40, clean: 850, sec: 300, heat: 5, cap: 40 };
    const SERVICE_KEYS = ['maint', 'clean', 'sec', 'heat', 'cap'];
    const SERVICE_NAMES = { maint: '“Æ–π –∫“Ø—Ç—ñ–º—ñ', clean: '–¢–∞–∑–∞–ª—ã“õ', sec: '–ë–µ–π–Ω–µ–±–∞“õ—ã–ª–∞—É', heat: '–ñ—ã–ª—É –µ—Å–µ–ø.', cap: '–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥.' };
    const MONTHS_KK = ["“ö–∞“£—Ç–∞—Ä", "–ê“õ–ø–∞–Ω", "–ù–∞—É—Ä—ã–∑", "–°”ô—É—ñ—Ä", "–ú–∞–º—ã—Ä", "–ú–∞—É—Å—ã–º", "–®—ñ–ª–¥–µ", "–¢–∞–º—ã–∑", "“ö—ã—Ä–∫“Ø–π–µ–∫", "“ö–∞–∑–∞–Ω", "“ö–∞—Ä–∞—à–∞", "–ñ–µ–ª—Ç–æ“õ—Å–∞–Ω"];
    const MONTHS_RU = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];

    // üõë –ö–æ–º–º–µ—Ä—Ü–∏—è–ª—ã“õ —Ç–∞—Ä–∏—Ñ “õ–æ–ª–¥–∞–Ω—ã–ª–∞—Ç—ã–Ω –ø”ô—Ç–µ—Ä–ª–µ—Ä–¥—ñ“£ ID-–ª–µ—Ä—ñ
    const COMMERCIAL_APTS = [1, 15, 16]; 
    const COMMERCIAL_MAINT_RATE = 60; // 60 —Ç–≥/–º2

    let apartments = [];
    let currentAptIndex = null;
    
    // =========================================================================
    // üì¢ 2. –ü”ò–¢–ï–† –î–ï–†–ï–ö–¢–ï–†–Ü–ù–Ü“¢ –ê–†–ù–ê–ô–´ –ú–ê–°–°–ò–í–Ü - –û–°–´ –ñ–ï–†–î–Ü ”®–ó–ì–ï–†–¢–Ü“¢–Ü–ó
    // =========================================================================
    const APARTMENT_DATA = [
        // –ï—Å–∫–µ—Ä—Ç—É: overall - “õ—ã–∑–º–µ—Ç—Ç–µ—Ä –±–æ–π—ã–Ω—à–∞ debt —Å–æ–º–∞–ª–∞—Ä—ã–Ω—ã“£ “õ–æ—Å—ã–Ω–¥—ã—Å—ã –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.
        
        // --- –ü”ò–¢–ï–† 1 (–ö–æ–º–º–µ—Ä—Ü–∏—è–ª—ã“õ) ---
        {
            id: 1, 
            account: "0005622", // –î–µ—Ä–±–µ—Å —à–æ—Ç –Ω”©–º—ñ—Ä—ñ
            area: 49.90, 
            debt: { maint: 94909.8, clean: 22600, sec: 11100, heat: 9231.5, cap: 109836.92, overall: 247678.22 }
        },
        
        // --- –ü”ò–¢–ï–† 2 ---
        {
            id: 2, 
            account: 3552225, // –î–µ—Ä–±–µ—Å —à–æ—Ç –Ω”©–º—ñ—Ä—ñ
            area: 44.60, 
            debt: { maint: 8920, clean: 4250, sec: 1500, heat: 1115, cap: 8920, overall: 24705 }
        },
        
        // --- –ü”ò–¢–ï–† 3 ---
        {
            id: 3, 
            account: 3552230, // –î–µ—Ä–±–µ—Å —à–æ—Ç –Ω”©–º—ñ—Ä—ñ
            area: 65.00, 
            debt: { maint: 13000, clean: 4250, sec: 1500, heat: 1625, cap: 13000, overall: 33375 } 
        },
        
        // --- –ü”ò–¢–ï–† 4 ---
        {
            id: 4, 
            account: 3552235, // –î–µ—Ä–±–µ—Å —à–æ—Ç –Ω”©–º—ñ—Ä—ñ
            area: 44.60, 
            debt: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0, overall: 0 } // “ö–∞—Ä—ã–∑—ã –∂–æ“õ
        },
        
        // –ï—Å–∫–µ—Ä—Ç—É: –ö–æ–º–º–µ—Ä—Ü–∏—è–ª—ã“õ –ø”ô—Ç–µ—Ä–ª–µ—Ä 15 –∂”ô–Ω–µ 16 –¥–∞ –æ—Å—ã —Ç—ñ–∑—ñ–º–¥–µ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.
        
    ];
    // =========================================================================
    // üì¢ –ü”ò–¢–ï–† –î–ï–†–ï–ö–¢–ï–†–Ü–ù–Ü“¢ –ê–†–ù–ê–ô–´ –ú–ê–°–°–ò–í–Ü–ù–Ü“¢ –°–û“¢–´
    // =========================================================================


    // --- –ö”®–ú–ï–ö–®–Ü –§–£–ù–ö–¶–ò–Ø: –î”®“¢–ì–ï–õ–ï–ö–¢–ï–£ (2 –æ–Ω–¥—ã“õ –±”©–ª—à–µ–∫–∫–µ –¥–µ–π—ñ–Ω) ---
    function roundToTenge(num) {
        if (typeof num !== 'number' || isNaN(num)) return 0;
        return Math.round(num * 100) / 100;
    }

    // 3. –ê–ô–õ–´“ö –ï–°–ï–ü–¢–ï–£ (–î–ï–ë–ï–¢)
    function calculateAccruals(area, aptId) {
        let maintRate = TARIFFS.maint; 
        
        // üõë –ö–æ–º–º–µ—Ä—Ü–∏—è–ª—ã“õ —Ç–∞—Ä–∏—Ñ—Ç—ñ —Ç–µ–∫—Å–µ—Ä—É –∂”ô–Ω–µ –æ—Ä–Ω–∞—Ç—É
        if (COMMERCIAL_APTS.includes(aptId)) {
            maintRate = COMMERCIAL_MAINT_RATE; 
        }

        return {
            // "“Æ–π–¥—ñ –∫“Ø—Ç—ñ–ø “±—Å—Ç–∞—É" “Ø—à—ñ–Ω –∂–∞“£–∞ —Ç–∞—Ä–∏—Ñ—Ç—ñ “õ–æ–ª–¥–∞–Ω—É (roundToTenge “õ–æ–ª–¥–∞–Ω—É)
            maint: roundToTenge(area * maintRate), 
            clean: TARIFFS.clean, 
            sec: TARIFFS.sec, 
            // ‚ùó ”®–∑–≥–µ—Ä—ñ—Å: Math.round –æ—Ä–Ω—ã–Ω–∞ roundToTenge “õ–æ–ª–¥–∞–Ω—É
            heat: roundToTenge(area * TARIFFS.heat), 
            // ‚ùó ”®–∑–≥–µ—Ä—ñ—Å: Math.round –æ—Ä–Ω—ã–Ω–∞ roundToTenge “õ–æ–ª–¥–∞–Ω—É
            cap: roundToTenge(area * TARIFFS.cap) 
        };
    }
    
    /**
     * –ë–∞—Å—Ç–∞–ø“õ—ã –ª–µ–¥–∂–µ—Ä–¥—ñ “õ“±—Ä–∞–¥—ã.
     */
    function getInitialLedger(area, aptId) {
        // aptId-–Ω—ã calculateAccruals-–∫–µ –±–µ—Ä—É
        const calc = calculateAccruals(area, aptId);
        const zeroCalc = { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 }; 
        const ledger = [];
        
        for (let i = 0; i < 12; i++) {
            
            let currentCharges = { ...calc }; 
            
            // üõë –ñ–ï–õ–¢–û“ö–°–ê–ù (–∏–Ω–¥–µ–∫—Å 11) “Æ–®–Ü–ù –ï—Å–µ–ø—Ç–µ—É–ª–µ—Ä–¥—ñ (–î) –ù”®–õ–ì–ï –¢–ï“¢–ï–£
            if (i === 11) {
                currentCharges = zeroCalc;
            }
            
            ledger.push({
                month: MONTHS_KK[i] + '. ' + MONTHS_RU[i] + ' 2025',
                charges: currentCharges,
                paymentTransactions: [], 
            });
        }
        return ledger;
    }


    // --- 5. –ñ“Æ–ô–ï–ù–Ü –ë–ê–°–¢–ê–£ –ñ”ò–ù–ï –°–ê“ö–¢–ê–£ (LOCALSTORAGE) ---
    function init() {
        const saved = localStorage.getItem('kz_full_ledger_v5'); 
        if (saved) {
            apartments = JSON.parse(saved);
        } else {
            APARTMENT_DATA.forEach(data => {
                // aptId-–Ω—ã getInitialLedger-–≥–µ –±–µ—Ä—É
                const calculatedLedger = getInitialLedger(data.area, data.id);
                
                const overallSum = SERVICE_KEYS.reduce((sum, key) => sum + (data.debt[key] || 0), 0);
                
                const newApt = {
                    id: data.id, 
                    account: data.account, 
                    area: data.area,
                    // ‚ùó –ë–∞—Å—Ç–∞–ø“õ—ã “õ–∞—Ä—ã–∑–¥–∞“ì—ã –æ–Ω–¥—ã“õ –±”©–ª—à–µ–∫—Ç–µ—Ä–¥—ñ —Ä–µ—Ç—Ç–µ—É
                    initialDebt: { ...data.debt, 
                        maint: roundToTenge(data.debt.maint), 
                        clean: roundToTenge(data.debt.clean), 
                        sec: roundToTenge(data.debt.sec), 
                        heat: roundToTenge(data.debt.heat), 
                        cap: roundToTenge(data.debt.cap), 
                        overall: roundToTenge(overallSum) 
                    }, 
                    ledger: calculatedLedger,
                    lastPay: "" 
                };

                calculateAccumulated(newApt); 
                apartments.push(newApt);
            });
            apartments.forEach(apt => calculateAccumulated(apt));
            saveData();
        }
    }
    
    function saveData() {
        localStorage.setItem('kz_full_ledger_v5', JSON.stringify(apartments));
        document.getElementById('msg').innerText = "–î–µ—Ä–µ–∫—Ç–µ—Ä —Å–∞“õ—Ç–∞–ª–¥—ã!";
        setTimeout(() => document.getElementById('msg').innerText = "", 2000);
    }
    
    // --- 6. –ö–£–ú–£–õ–Ø–¢–ò–í–¢–Ü –ï–°–ï–ü–¢–ï–£ –õ–û–ì–ò–ö–ê–°–´ ---
    function calculateAccumulated(apt) {
        let currentBal = { ...apt.initialDebt }; 
        
        apt.ledger.forEach((entry) => {
            let monthTotalCharge = 0;
            
            SERVICE_KEYS.forEach(key => {
                const totalPaymentForService = entry.paymentTransactions.reduce((sum, tx) => sum + (tx.amounts[key] || 0), 0);
                
                // ‚ùó ”ò—Ä “õ–∞–¥–∞–º–¥–∞ –¥”©“£–≥–µ–ª–µ–∫—Ç–µ—É–¥—ñ “õ–æ–ª–¥–∞–Ω—É
                currentBal[key] = roundToTenge(currentBal[key] + entry.charges[key] - totalPaymentForService);
                monthTotalCharge += entry.charges[key];
            });

            currentBal.overall = roundToTenge(currentBal.maint + currentBal.clean + currentBal.sec + currentBal.heat + currentBal.cap);
            
            entry.accumulated = { ...currentBal };
            entry.totalMonthlyCharge = roundToTenge(monthTotalCharge); // –ê–π–ª—ã“õ –µ—Å–µ–ø—Ç–µ—É–¥—ñ“£ –∂–∞–ª–ø—ã —Å–æ–º–∞—Å—ã–Ω –¥–∞ –¥”©“£–≥–µ–ª–µ–∫—Ç–µ—É
        });
        
        return currentBal; 
    }

    // --- 7. –õ–ï–î–ñ–ï–† –†–ï–î–ê–ö–¢–û–†–´–ù –°–´–ó–£ –ñ”ò–ù–ï –ñ“Æ–ö–¢–ï–£ ---
    function loadApartment() {
        const id = parseInt(document.getElementById('aptInput').value);
        if (id < 1 || id > APARTMENT_DATA.length) { // APARTMENT_DATA.length “õ–æ–ª–¥–∞–Ω—É
            alert(`–ü”ô—Ç–µ—Ä ‚Ññ1 –º–µ–Ω ‚Ññ${APARTMENT_DATA.length} –∞—Ä–∞—Å—ã–Ω–¥–∞ –±–æ–ª—É –∫–µ—Ä–µ–∫`); 
            return; 
        }
        
        currentAptIndex = apartments.findIndex(apt => apt.id === id); // id –∞—Ä“õ—ã–ª—ã —Ç–∞–±—É
        if (currentAptIndex === -1) {
             alert(`–ü”ô—Ç–µ—Ä ‚Ññ${id} –¥–µ—Ä–µ–∫—Ç–µ—Ä –±–∞–∑–∞—Å—ã–Ω–¥–∞ —Ç–∞–±—ã–ª–º–∞–¥—ã.`); 
            return;
        }

        const apt = apartments[currentAptIndex];
        
        document.getElementById('editor').style.display = 'block';
        document.getElementById('aptTitle').innerText = `–ü”ô—Ç–µ—Ä ${apt.id} (–®–æ—Ç: ${apt.account}) ${apt.area} –º2`;
        
        calculateAccumulated(apt); 
        renderLedgerTable(apt);
    }
    
    function renderLedgerTable(apt) {
        const editorDiv = document.getElementById('ledgerEditor');
        
        // –ö”©—Ä—Å–µ—Ç—É “Ø—à—ñ–Ω –¥”©“£–≥–µ–ª–µ–∫—Ç–µ—É–¥—ñ “õ–æ–ª–¥–∞–Ω–∞—Ç—ã–Ω –∫”©–º–µ–∫—à—ñ —Ñ—É–Ω–∫—Ü–∏—è
        const displayValue = (val) => roundToTenge(val).toFixed(2); 

        let html = `
            <table>
                <tr>
                    <th rowspan="3" style="width:120px;">–ê–π / –ú–µ—Å—è—Ü</th>
                    <th colspan="10">“ö—ã–∑–º–µ—Ç—Ç–µ—Ä (–¢–µ–Ω–≥–µ)</th>
                    <th colspan="2" class="total-col">–ñ–∞–ª–ø—ã <br> –ñ—ã–π—ã–Ω—ã</th>
                    <th rowspan="3">”ò—Ä–µ–∫–µ—Ç</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(key => `<th colspan="2">${SERVICE_NAMES[key]}</th>`).join('')}
                    <th class="total-col sub-col-header" colspan="2">–î–µ—Ä–µ–∫—Ç–µ—Ä</th>
                </tr>
                <tr>
                    ${SERVICE_KEYS.map(() => `<th class="sub-col-header charge-cell">–î</th><th class="sub-col-header payment-cell">–ö</th>`).join('')}
                    <th class="total-col sub-col-header charge-cell">–î</th>
                    <th class="total-col sub-col-header payment-cell">–ö (–¢”©–ª–µ–º –¥–µ—Ä–µ–≥—ñ)</th>
                </tr>
                
                <tr class="initial-debt-row">
                    <td class="month-group-header left-align">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>
                    
                    ${SERVICE_KEYS.map(key => `
                        <td class="charge-cell">${displayValue(apt.initialDebt[key])}</td><td class="payment-cell"></td>
                    `).join('')}
                    
                    <td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td>
                    <td class="total-col payment-cell"></td>
                    
                    <td></td>
                </tr>

                ${apt.ledger.map((entry, index) => {
                    
                    let monthHtml = ''; 
                    const transactionsExist = entry.paymentTransactions.length > 0;
                    const rowSpanCount = transactionsExist ? entry.paymentTransactions.length : 1;
                    
                    // --- 1. –ï–°–ï–ü–¢–ï–£ –ñ”ò–ù–ï –ë–Ü–†–Ü–ù–®–Ü –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–ù–´ –ë–Ü–†–Ü–ö–¢–Ü–†–£ –ñ–û–õ–´ (–¢—Ä. 1) ---
                    if (transactionsExist) {
                        const tx = entry.paymentTransactions[0];
                        const totalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (tx.amounts[key] || 0), 0);
                        
                        monthHtml += `
                            <tr class="payment-row" data-month-index="${index}" data-tx-index="0" style="background:#f0f0f0;">
                                <td class="month-group-header left-align" rowspan="${rowSpanCount}">${entry.month}</td>
                                ${SERVICE_KEYS.map(key => `
                                    <td class="charge-cell">${displayValue(entry.charges[key])}</td>
                                    <td class="payment-cell">
                                        <input type="number" class="payment-input pay-input" 
                                            data-month-index="${index}" data-tx-index="0" data-key="${key}"
                                            value="${displayValue(tx.amounts[key])}" min="0" step="0.01">
                                    </td>
                                `).join('')}
                                <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td>
                                <td class="total-col payment-cell payment-details-cell">
                                    <div class="payment-details-inline">
                                        <span class="payment-total-amount">
                                            ${displayValue(totalTxAmount)}
                                        </span>
                                        <input type="date" class="payment-details-input" data-month-index="${index}" data-tx-index="0" data-field="date" value="${tx.date || ''}">
                                        <select class="payment-details-input" data-month-index="${index}" data-tx-index="0" data-field="bank">
                                            <option value="${tx.bank || ''}">${tx.bank || '–¢–∞“£–¥–∞—É'}</option>
                                            <option value="Kaspi">Kaspi</option>
                                            <option value="Halyk">Halyk</option>
                                            <option value="Cash">“ö–æ–ª–º–∞-“õ–æ–ª</option>
                                        </select>
                                    </div>
                                </td>
                                <td rowspan="${rowSpanCount}" style="text-align: center;">
                                    <div class="action-buttons-inline">
                                        <button class="btn btn-red" onclick="removeTransaction(${index}, 0)">‚ùå ”®—à—ñ—Ä—É</button>
                                        <button class="btn btn-blue" onclick="addTransaction(${index})">üí∞ –¢”©–ª–µ–º “õ–æ—Å—É</button>
                                    </div>
                                </td>
                            </tr>
                        `;

                        // --- 2. –ï–ö–Ü–ù–®–Ü –ñ”ò–ù–ï –û–î–ê–ù –ö–ï–ô–Ü–ù–ì–Ü –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–õ–ê–† (–¢—Ä. 2...) ---
                        for(let txIndex = 1; txIndex < entry.paymentTransactions.length; txIndex++) {
                            const tx = entry.paymentTransactions[txIndex];
                            const nextTotalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (tx.amounts[key] || 0), 0);
                            
                            monthHtml += `
                                <tr class="payment-row" data-month-index="${index}" data-tx-index="${txIndex}">
                                    <td style="display:none;"></td> 
                                    ${SERVICE_KEYS.map(key => `
                                        <td class="charge-cell"></td>
                                        <td class="payment-cell">
                                            <input type="number" class="payment-input pay-input" 
                                                data-month-index="${index}" data-tx-index="${txIndex}" data-key="${key}"
                                                value="${displayValue(tx.amounts[key])}" min="0" step="0.01">
                                        </td>
                                    `).join('')}
                                    <td class="total-col charge-cell"></td>
                                    <td class="total-col payment-cell payment-details-cell">
                                        <span class="payment-total-amount">
                                            ${displayValue(nextTotalTxAmount)}
                                        </span>
                                    </td>
                                    <td style="display:none;"></td>
                                </tr>
                            `;
                        }

                    } else {
                        // --- 3. –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø –ñ–û“ö (–¢–ï–ö –ï–°–ï–ü–¢–ï–£) –ñ–û–õ–´ ---
                         monthHtml += `
                            <tr class="charge-row" data-month-index="${index}" style="background:${entry.totalMonthlyCharge > 0 ? '#f8d7da' : '#f0f0f0'};">
                                <td class="month-group-header left-align">${entry.month}</td>
                                ${SERVICE_KEYS.map(key => `
                                    <td class="charge-cell">${displayValue(entry.charges[key])}</td>
                                    <td class="charge-cell"></td>
                                `).join('')}
                                <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td>
                                <td class="total-col charge-cell"></td>
                                <td><button class="btn btn-blue" onclick="addTransaction(${index})">üí∞ –¢”©–ª–µ–º “õ–æ—Å—É</button></td>
                            </tr>
                        `;
                    }
                    
                    // –ê–π—ã–ø —Å–æ“£—ã–Ω–¥–∞“ì—ã –∂—ã–π–Ω–∞–ª“ì–∞–Ω—ã –∂–æ–ª—ã
                    const accRow = `
                        <tr class="total-acc-row">
                            <td class="month-group-header left-align">–ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã (–ê–π —Å–æ“£—ã)</td>
                            
                            ${SERVICE_KEYS.map(key => `
                                <td colspan="2">${displayValue(entry.accumulated[key])}</td>
                            `).join('')}
                            
                            <td colspan="2" class="total-col">${displayValue(entry.accumulated.overall)}</td>
                            <td></td>
                        </tr>
                    `;
                    return monthHtml + accRow;
                }).join('')}

            </table>
        `;
        editorDiv.innerHTML = html;
    }
    
    // --- 8. –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø–õ–ê–†–î–´ –ë–ê–°“ö–ê–†–£ ---
    function addTransaction(monthIndex) {
        const apt = apartments[currentAptIndex];
        const newTx = {
            amounts: { maint: 0, clean: 0, sec: 0, heat: 0, cap: 0 },
            date: new Date().toISOString().slice(0, 10), 
            bank: 'Kaspi'
        };
        apt.ledger[monthIndex].paymentTransactions.push(newTx);
        
        saveData();
        loadApartment();
    }
    
    function removeTransaction(monthIndex, txIndex) {
        if(!confirm("–¢”©–ª–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Å—ã–Ω ”©—à—ñ—Ä—É–≥–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) return;
        const apt = apartments[currentAptIndex];
        apt.ledger[monthIndex].paymentTransactions.splice(txIndex, 1);
        
        if (apt.ledger[monthIndex].paymentTransactions.length === 0) {
            saveData();
            loadApartment(); 
            return;
        }
        
        saveData();
        loadApartment();
    }

    function updateLedger() {
        const apt = apartments[currentAptIndex];
        
        // Input-—Ç–∞—Ä–¥–∞–Ω –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂–∏–Ω–∞—É
        document.querySelectorAll('.pay-input').forEach(input => {
            const monthIndex = parseInt(input.getAttribute('data-month-index'));
            const txIndex = parseInt(input.getAttribute('data-tx-index'));
            const key = input.getAttribute('data-key');
            
            // ‚ùó Input –º”ô–Ω—ñ–Ω –∞–ª–∞—Ä –∫–µ–∑–¥–µ –¥–µ –¥”©“£–≥–µ–ª–µ–∫—Ç–µ—É
            apt.ledger[monthIndex].paymentTransactions[txIndex].amounts[key] = roundToTenge(parseFloat(input.value)) || 0;
        });

        // –ë—ñ—Ä—ñ–Ω—à—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è “Ø—à—ñ–Ω “ì–∞–Ω–∞ –±–∞—Å“õ–∞ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ (–∫“Ø–Ω, –±–∞–Ω–∫) –∂–∏–Ω–∞—É
        document.querySelectorAll('tr[data-tx-index="0"]').forEach(row => {
            const monthIndex = parseInt(row.getAttribute('data-month-index'));
            const txIndex = 0; 
            
            if (apt.ledger[monthIndex] && apt.ledger[monthIndex].paymentTransactions[txIndex]) {
                 const dateInput = row.querySelector('input[data-field="date"]');
                const bankSelect = row.querySelector('select[data-field="bank"]');

                if (dateInput && bankSelect) {
                    apt.ledger[monthIndex].paymentTransactions[txIndex].date = dateInput.value;
                    apt.ledger[monthIndex].paymentTransactions[txIndex].bank = bankSelect.value;
                }
            }
        });

        calculateAccumulated(apt);
        saveData();
        renderLedgerTable(apt); 
    }
    
    // --- 9. –¢“Æ–ë–Ü–†–¢–ï–ö –ì–ï–ù–ï–†–ê–¢–û–†–´ ---
    function downloadReceipt() {
        const apt = apartments[currentAptIndex];
        calculateAccumulated(apt);

        const displayValue = (val) => roundToTenge(val).toFixed(2); 

        let historyRows = '';
        
        // 1. 2024 –∂—ã–ª“ì—ã –±–∞—Å—Ç–∞–ø“õ—ã “õ–∞—Ä—ã–∑ –∂–æ–ª—ã
        historyRows += `
            <tr class="charge-row receipt-style">
                <td class="left-align bold">2024 (–ë–∞—Å—Ç–∞–ø“õ—ã “ö–∞—Ä—ã–∑)</td>
                <td class="charge-cell">${displayValue(apt.initialDebt.maint)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.clean)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.sec)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.heat)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.initialDebt.cap)}</td><td></td>
                <td class="total-col charge-cell">${displayValue(apt.initialDebt.overall)}</td><td></td>
            </tr>`;

        // 2. 2025 –∂—ã–ª“ì—ã –∞–π–ª–∞—Ä –∂”ô–Ω–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–ª–∞—Ä
        apt.ledger.forEach(entry => {
            if (entry.paymentTransactions.length > 0) {
                const tx = entry.paymentTransactions[0];
                const totalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (tx.amounts[key] || 0), 0);
                const paymentDetails = totalTxAmount > 0 ? `<div style="font-size: 8px;">${displayValue(totalTxAmount)} K${tx.date.replace(/-/g, '.')} (${tx.bank})</div>` : '';
                
                historyRows += `
                    <tr class="payment-row receipt-style">
                        <td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>
                        ${SERVICE_KEYS.map(key => `
                            <td class="charge-cell">${displayValue(entry.charges[key])}</td>
                            <td class="payment-cell">${displayValue(tx.amounts[key])}</td>
                        `).join('')}
                        <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td>
                        <td class="total-col payment-cell">
                            ${paymentDetails} 
                        </td>
                    </tr>
                `;

                   for(let txIndex = 1; txIndex < entry.paymentTransactions.length; txIndex++) {
                    const nextTx = entry.paymentTransactions[txIndex];
                    const nextTotalTxAmount = SERVICE_KEYS.reduce((sum, key) => sum + (nextTx.amounts[key] || 0), 0);
                    const nextPaymentDetails = nextTotalTxAmount > 0 ? `<div style="font-size: 8px;">${displayValue(nextTotalTxAmount)} K${nextTx.date.replace(/-/g, '.')} (${nextTx.bank})</div>` : '';
                    
                    historyRows += `
                        <tr class="payment-row receipt-style">
                            <td class="left-align"></td> 
                            ${SERVICE_KEYS.map(key => `
                                <td></td><td class="payment-cell">${displayValue(nextTx.amounts[key])}</td>
                            `).join('')}
                            <td></td>
                            <td class="total-col payment-cell">
                                ${nextPaymentDetails}
                            </td>
                        </tr>
                    `;
                    }

            } else {
                 historyRows += `
                    <tr class="charge-row receipt-style">
                        <td class="left-align">${entry.month.split(' ')[0]} ${entry.month.split(' ')[2]}</td>
                        <td class="charge-cell">${displayValue(entry.charges.maint)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.clean)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.sec)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.heat)}</td><td></td>
                        <td class="charge-cell">${displayValue(entry.charges.cap)}</td><td></td>
                        <td class="total-col charge-cell">${displayValue(entry.totalMonthlyCharge)}</td><td></td>
                    </tr>
                `;
            }
        });
        
        // 3. –ï“£ —Å–æ“£“ì—ã "–ñ—ã–π–Ω–∞–ª“ì–∞–Ω—ã" –∂–æ–ª—ã
        const finalAccumulated = apt.ledger[11] ? apt.ledger[11].accumulated : apt.initialDebt; 
        
        // --- –¢–û–õ–´“ö HTML “ö“∞–†–´–õ–´–ú–´–ù “ö“∞–†–£ ---
        const htmlContent = `
        <!DOCTYPE html>
        <html lang="kk">
        <head>
            <meta charset="UTF-8">
            <title>–¢”©–ª–µ–º –¢“Ø–±—ñ—Ä—Ç–µ–≥—ñ: –ü”ô—Ç–µ—Ä ${apt.id}</title>
            <style>
                body { font-family: Arial, serif; font-size: 11px; margin: 20px; }
                table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                th, td { border: 1px solid black; padding: 4px 6px; text-align: right; vertical-align: top; }
                .header-cell { vertical-align: top; text-align: center; font-weight: bold; padding: 6px 4px; }
                .month-header { text-align: left; font-size: 14px; font-weight: bold; }
                .acc-info { text-align: left; font-size: 10px; }
                .charge-cell { background-color: #f8f8f8; } 
                .payment-cell { background-color: #e8f5e9; }
                .total-acc-row td { background-color: #ffe082; font-weight: bold; font-size: 12px; }
                .total-col { background-color: #e3f2fd; }
                .left-align { text-align: left; }
                .center-align { text-align: center; }
                .bold { font-weight: bold; }
            </style>
        </head>
        <body>

        <table>
            <tr>
                <td class="acc-info" style="width: 25%">
                    <span class="month-header">“ö–∞—Ä–∞—à–∞ / –ù–æ—è–±—Ä—å 2025</span><br>
                    –¥–µ—Ä–±–µ—Å —à–æ—Ç. –ª–∏—Ü–µ–≤–æ–π —Å—á–µ—Ç ${apt.account}<br>
                    Aqsai-3, 10a, <strong>${apt.id}</strong> - ${apt.area} m2<br> </td>
                
                <td colspan="2" class="header-cell">“Æ–π–¥—ñ –∫“Ø—Ç—ñ–ø “±—Å—Ç–∞—É.<br>${COMMERCIAL_APTS.includes(apt.id) ? '60' : '40'} —Ç“£–≥,–º2</td>
                <td colspan="2" class="header-cell">“Æ–π —ñ—à—ñ —Ç–∞–∑–∞–ª—ã“ì—ã.<br>850 —Ç“£–≥,–ø—Ç.–∫–≤.</td>
                <td colspan="2" class="header-cell">–ö—ñ—Ä–µ–±–µ—Ä—ñ—Å –µ—Å—ñ–∫–∫–µ...<br>300 —Ç“£–≥,–ø—Ç.–∫–≤.</td>
                <td colspan="2" class="header-cell">–ñ—ã–ª—ã—É –µ—Å–µ–ø—Ç–µ—É...<br>5 —Ç“£–≥,–º2</td>
                <td colspan="2" class="header-cell">–ö“Ø—Ä–¥–µ–ª—ñ –∂”©–Ω–¥–µ—É.<br>40 —Ç“£–≥,–º2</td>
                
                <td colspan="2" class="header-cell total-col">–ñ—ã–π—ã–Ω—ã.<br>–ò—Ç–æ–≥–æ</td>
            </tr>

            <tr>
                <td class="left-align">–ê–π—ã–Ω–∞ –µ—Å–µ–ø—Ç–µ—É. –†–∞—Å—á–µ—Ç –≤ –º–µ—Å—è—Ü</td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.maint)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.clean)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.sec)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.heat)}</td><td></td>
                <td class="charge-cell">${displayValue(apt.ledger[0].charges.cap)}</td><td></td>
                <td class="total-col charge-cell">${displayValue(apt.ledger[0].totalMonthlyCharge)}</td><td></td>
            </tr>

            <tr class="total-acc-row">
                <td class="left-align">–∂—ã–π–Ω–∞–ª“ì–∞–Ω—ã, –Ω–∞–∫–æ–ø–∏–≤—à–µ–µ—Å—è</td>
                
                <td colspan="2">${displayValue(finalAccumulated.maint)}</td>
                <td colspan="2">${displayValue(finalAccumulated.clean)}</td>
                <td colspan="2">${displayValue(finalAccumulated.sec)}</td>
                <td colspan="2">${displayValue(finalAccumulated.heat)}</td>
                <td colspan="2">${displayValue(finalAccumulated.cap)}</td>
                
                <td class="total-col charge-cell">${displayValue(finalAccumulated.overall)}</td>
                
                <td class="total-col payment-cell" style="text-align: center; background: #fff3cd; padding: 4px;">
                    –¢”©–ª–µ–º–≥–µ - –ö –æ–ø–ª–∞—Ç–µ
                </td>
            </tr>

            ${historyRows}

        </table>
        
        <p style="margin-top: 30px; font-size: 10px;">–ë“±–ª —Ç“Ø–±—ñ—Ä—Ç–µ–∫ –∞–≤—Ç–æ–º–∞—Ç—Ç–∞–Ω–¥—ã—Ä—ã–ª“ì–∞–Ω –∂“Ø–π–µ –∞—Ä“õ—ã–ª—ã “õ“±—Ä—ã–ª“ì–∞–Ω.</p>
        </body>
        </html>
        `;

        const blob = new Blob([htmlContent], {type: "text/html"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `kvartira-${apt.id}-full-ledger.html`;
        link.click();
        
        document.getElementById('msg').innerText = `–ü”ô—Ç–µ—Ä ‚Ññ${apt.id} “Ø—à—ñ–Ω —Ç“Ø–±—ñ—Ä—Ç–µ–∫ –∂“Ø–∫—Ç–µ–ª–¥—ñ!`;
        setTimeout(() => document.getElementById('msg').innerText = "", 3000);
    }
</script>
</body>
</html>