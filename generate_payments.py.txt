import json
import datetime
import os

# --- Файлдарға жол ---
CONFIG_FILE = 'apartments_config.json'
RATES_FILE = 'rates_config.json'
PAYMENTS_FILE = 'payments.json'

def calculate_monthly_payment(config, rates):
    """ODT файлындағы логикаға сәйкес бір пәтердің толық төлемін есептейді."""
    
    area = config['area_sqm']
    
    # --- 1. Алаңға байланысты есептеулер (Тариф * Алаң) ---
    maintenance_cost = area * rates['monthly_rates']['maintenance_sqm']
    capital_repair_cost = area * rates['monthly_rates']['capital_repair_sqm']
    heat_meter_cost = area * rates['monthly_rates']['heat_meter_service_sqm']
    
    # --- 2. Тұрақты есептеулер (Пәтер санына байланысты) ---
    cleaning_cost = rates['fixed_rates']['cleaning_unit']
    
    # --- 3. Шартты есептеулер (Егер бар болса) ---
    video_service_cost = rates['fixed_rates']['video_service_unit'] if config.get('has_video', False) else 0

    # --- Жалпы сома ---
    total_cost = (maintenance_cost + capital_repair_cost + heat_meter_cost + 
                  cleaning_cost + video_service_cost)
    
    # Бұл қарапайым мысал, егер сіздің ODT-тегідей әр элементті жеке көрсету керек болса, 
    # логиканы күрделендіруге болады. Қазір тек ЖИЫНТЫҚ соманы есептейміз.

    return round(total_cost, 0) # Бөлшек сандарсыз дөңгелектеу

def generate_new_month_data(current_payments, apartment_configs, rates):
    """Жаңа айға арналған төлемдерді генерациялайды."""

    # Келесі айды анықтау
    today = datetime.date.today()
    if today.month == 12:
        next_month = 1
        next_year = today.year + 1
    else:
        next_month = today.month + 1
        next_year = today.year
        
    next_month_str = datetime.date(next_year, next_month, 1).strftime('%Y-%m') 

    new_payments_to_add = []
    
    # Жаңа төлемдерді есептеу
    for config in apartment_configs:
        apartment_num = config['apartment']
        
        # Бұл пәтерге төлем бұрыннан бар ма, тексеру
        existing_payment = next((p for p in current_payments if p['apartment'] == apartment_num and p['month'] == next_month_str), None)

        if existing_payment:
            continue # Бұрыннан бар болса, өткізіп жібереміз
            
        # Жаңа төлемді есептеу
        amount = calculate_monthly_payment(config, rates)
        
        new_entry = {
            "apartment": apartment_num,
            "month": next_month_str,
            "amount": int(amount), 
            "status": "Күтуде", # Жаңа айда әрдайым "Күтуде"
            "receipt_link": ""
        }
        new_payments_to_add.append(new_entry)
        
    # Ескі және жаңа деректерді біріктіру (бұрынғы төлемдерді сақтай отырып)
    final_data = current_payments + new_payments_to_add
    
    return final_data

def main():
    
    # 1. Файлдарды жүктеу
    if not os.path.exists(RATES_FILE) or not os.path.exists(CONFIG_FILE):
        print("Қате: Конфигурация файлдары (rates_config.json немесе apartments_config.json) табылмады.")
        return

    with open(RATES_FILE, 'r', encoding='utf-8') as f:
        rates = json.load(f)
        
    with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
        apartment_configs = json.load(f)

    if os.path.exists(PAYMENTS_FILE) and os.path.getsize(PAYMENTS_FILE) > 0:
        with open(PAYMENTS_FILE, 'r', encoding='utf-8') as f:
            current_payments = json.load(f)
    else:
        current_payments = []

    # 2. Жаңа деректерді генерациялау
    final_data = generate_new_month_data(current_payments, apartment_configs, rates)
    
    # 3. Жаңартылған деректерді payments.json-ға сақтау
    with open(PAYMENTS_FILE, 'w', encoding='utf-8') as f:
        json.dump(final_data, f, indent=2, ensure_ascii=False)
        
    print(f"--- {len(final_data)} жазбасы бар {PAYMENTS_FILE} сәтті жаңартылды. ---")

if __name__ == "__main__":
    main()