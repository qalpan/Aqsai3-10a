<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† –ú–ò–ë/–û–°–ò –¢”©–ª–µ–º –ñ“Ø–π–µ—Å—ñ (–ê–≤—Ç–æ–Ω–æ–º–¥—ã)</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üè† –ú–ò–ë/–û–°–ò –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ –ë–∞—Å“õ–∞—Ä—É –ñ“Ø–π–µ—Å—ñ</h1>
    </header>

    <main>
        <section class="controls">
            <h2>–ï—Å–µ–ø—Ç–µ—É–¥—ñ –ë–∞—Å—Ç–∞—É</h2>
            <div class="input-group">
                <label for="calc-month">–ê–π:</label>
                <select id="calc-month">
                    </select>
                <label for="calc-year">–ñ—ã–ª:</label>
                <input type="number" id="calc-year" value="2025" min="2020" max="2030">
                <button id="calculate-btn">–ê–π–ª—ã“õ –¢”©–ª–µ–º–¥—ñ –ï—Å–µ–ø—Ç–µ—É</button>
            </div>
            <p id="message" class="status-message"></p>

            <hr style="margin: 20px 0;">
            
            <h2>–ñ—ã–ª–¥—ã“õ –ï—Å–µ–ø –ë–µ—Ä—É</h2>
            <div class="input-group">
                <label for="report-flat-number">–ü”ô—Ç–µ—Ä ‚Ññ:</label>
                <input type="number" id="report-flat-number" value="1" min="1">
                <label for="report-year">–ñ—ã–ª:</label>
                <input type="number" id="report-year" value="2025" min="2020">
                <button id="generate-report-btn">–ñ—ã–ª–¥—ã“õ –ï—Å–µ–ø –ë–µ—Ä—É</button>
            </div>
        </section>

        <section class="results">
            <h2>–ü”ô—Ç–µ—Ä–ª–µ—Ä –±–æ–π—ã–Ω—à–∞ –ï—Å–µ–ø—Ç–µ—Ä</h2>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                        <th>–ê–ª–∞“£—ã (–º¬≤)</th>
                        <th>“Æ–π–¥—ñ –∫“Ø—Ç—É (—Ç–≥)</th>
                        <th>–¢–∞–∑–∞–ª—ã“õ (—Ç–≥)</th>
                        <th>–ë–µ–π–Ω–µ–±. (—Ç–≥)</th>
                        <th>–ñ–∏—ã–Ω—Ç—ã“õ (—Ç–≥)</th>
                        <th>–ê–ª–¥—ã“£“ì—ã “õ–∞—Ä—ã–∑ (—Ç–≥)</th>
                        <th>–¢”©–ª–µ—É–≥–µ (—Ç–≥)</th>
                        <th>”ò—Ä–µ–∫–µ—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>
        
        <section class="data-io">
            <h2>üíæ –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –ò–º–ø–æ—Ä—Ç—Ç–∞—É/–≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É</h2>
            
            <div class="input-group">
                <label for="apartment-csv-file">–ü”ô—Ç–µ—Ä–ª–µ—Ä (apartments) CSV –ò–º–ø–æ—Ä—Ç:</label>
                <input type="file" id="apartment-csv-file" accept=".csv">
                <button id="import-apartments-btn">–ò–º–ø–æ—Ä—Ç—Ç–∞—É</button>
            </div>
            
            <p id="io-message" class="status-message"></p>
            
            <div class="input-group">
                <button id="export-apartments-btn">–ü”ô—Ç–µ—Ä –î–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É (CSV)</button>
                <button id="export-payments-btn">–¢”©–ª–µ–º –¢–∞—Ä–∏—Ö—ã–Ω –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É (CSV)</button>
            </div>
        </section>
        
        <div id="receipt-output"></div>
    </main> 
    
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>–¢”©–ª–µ–º–¥—ñ –¢—ñ—Ä–∫–µ—É</h3>
            <p>–ü”ô—Ç–µ—Ä ‚Ññ: <strong id="modal-flat-number"></strong></p>
            <p>–¢”©–ª–µ—É–≥–µ –∂–∞—Ç–∞—Ç—ã–Ω —Å–æ–º–∞: <strong id="modal-amount-due"></strong></p>
            
            <label for="paid-amount">–¢”©–ª–µ–Ω–≥–µ–Ω —Å–æ–º–∞ (—Ç–≥):</label>
            <input type="number" id="paid-amount" step="0.01" value="0">
            
            <label for="payment-date">–¢”©–ª–µ–º –∫“Ø–Ω—ñ:</label>
            <input type="date" id="payment-date" value="">
            
            <button id="save-payment-btn">–¢”©–ª–µ–º–¥—ñ –°–∞“õ—Ç–∞—É</button>
            <p id="modal-message" class="status-message"></p>
        </div>
    </div>
    
    <script type="module">
        // –ú–æ–¥—É–ª—å–¥–µ—Ä–¥—ñ –∂–∞“£–∞ –∞—Ç–∞—É–ª–∞—Ä–º–µ–Ω –∏–º–ø–æ—Ä—Ç—Ç–∞—É (–∫—ç—à—Ç—ñ –±“±–∑—É “Ø—à—ñ–Ω)
        import { openDB, recordPayment, STORE_APARTMENTS, STORE_PAYMENTS } from './db-v2.js';
        import { calculateMonthlyCharges } from './calculator-v2.js';
        import './receipt-generator-v2.js'; 
        import './yearly-report-v2.js';     
        import { importApartments, exportData } from './data-io-v2.js'; 
        
        // –¢“±—Ä–∞“õ—Ç—ã–ª–∞—Ä –º–µ–Ω –ö”©–º–µ–∫—à—ñ —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä
        const MONTHS = ["“ö–∞“£—Ç–∞—Ä", "–ê“õ–ø–∞–Ω", "–ù–∞—É—Ä—ã–∑", "–°”ô—É—ñ—Ä", "–ú–∞–º—ã—Ä", "–ú–∞—É—Å—ã–º", "–®—ñ–ª–¥–µ", "–¢–∞–º—ã–∑", "“ö—ã—Ä–∫“Ø–π–µ–∫", "“ö–∞–∑–∞–Ω", "“ö–∞—Ä–∞—à–∞", "–ñ–µ–ª—Ç–æ“õ—Å–∞–Ω"];
        const formatCurrency = (amount) => new Intl.NumberFormat('kk-KZ').format(amount);

        // UI —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä—ñ
        const monthSelect = document.getElementById('calc-month');
        const yearInput = document.getElementById('calc-year');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsTableBody = document.querySelector('#results-table tbody');
        const messageElement = document.getElementById('message');
        
        // –ú–æ–¥–∞–ª—å–¥—ã —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä
        const paymentModal = document.getElementById('payment-modal');
        const closeBtn = document.querySelector('.close-btn');
        const savePaymentBtn = document.getElementById('save-payment-btn');
        const paidAmountInput = document.getElementById('paid-amount');
        const modalMessage = document.getElementById('modal-message');

        // Data IO —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä—ñ
        const ioMessage = document.getElementById('io-message');
        const apartFile = document.getElementById('apartment-csv-file');
        const importApartmentsBtn = document.getElementById('import-apartments-btn');
        const exportApartmentsBtn = document.getElementById('export-apartments-btn');
        const exportPaymentsBtn = document.getElementById('export-payments-btn');
        
        let currentCalculation = []; 
        let selectedFlatData = null; 
        
        document.getElementById('payment-date').valueAsDate = new Date();


        /**
         * –ë–∞—Å—Ç–∞–ø“õ—ã –æ—Ä–Ω–∞—Ç—É: DB –∞—à—É, –∞–π–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—ã—Ä—É, Listener-–ª–µ—Ä–¥—ñ “õ–æ—Å—É
         */
        async function initialize() {
            try {
                messageElement.textContent = "–î–µ—Ä–µ–∫—Ç–µ—Ä “õ–æ—Ä—ã–Ω–∞ “õ–æ—Å—ã–ª—É...";
                await openDB();
                messageElement.textContent = "–î–∞–π—ã–Ω. –ï—Å–µ–ø—Ç–µ—É–¥—ñ –±–∞—Å—Ç–∞“£—ã–∑ –Ω–µ–º–µ—Å–µ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∏–º–ø–æ—Ä—Ç—Ç–∞“£—ã–∑.";
                
                // --- –ê–ô–õ–ê–†–î–´ –¢–û–õ–¢–´–†–£ ---
                MONTHS.forEach((name, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = name;
                    monthSelect.appendChild(option);
                });
                // –ê“ì—ã–º–¥–∞“ì—ã –∞–π–¥—ã —Ç–∞“£–¥–∞—É
                monthSelect.value = new Date().getMonth() + 1; 

                // --- EVENT LISTENER-–õ–ï–† ---
                calculateBtn.addEventListener('click', handleCalculation);
                
                // –ñ—ã–ª–¥—ã“õ –µ—Å–µ–ø –±–µ—Ä—É
                document.getElementById('generate-report-btn').addEventListener('click', () => {
                    const flat = parseInt(document.getElementById('report-flat-number').value);
                    const year = parseInt(document.getElementById('report-year').value);
                    if (flat > 0 && year > 0) {
                        window.generateYearlyReport(flat, year);
                    } else {
                        alert("–ü”ô—Ç–µ—Ä –Ω”©–º—ñ—Ä—ñ –º–µ–Ω –∂—ã–ª–¥—ã –¥“±—Ä—ã—Å –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
                    }
                });
                
                // –¢”©–ª–µ–º–¥—ñ —Å–∞“õ—Ç–∞—É
                savePaymentBtn.addEventListener('click', handleRecordPayment);
                
                // –ú–æ–¥–∞–ª—å–¥—ã –∂–∞–±—É
                closeBtn.addEventListener('click', () => paymentModal.style.display = 'none');
                window.addEventListener('click', (event) => {
                    if (event.target === paymentModal) {
                        paymentModal.style.display = 'none';
                    }
                });
                
                // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –ò–º–ø–æ—Ä—Ç—Ç–∞—É/–≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É
                importApartmentsBtn.addEventListener('click', handleImportApartments);
                exportApartmentsBtn.addEventListener('click', () => {
                    ioMessage.textContent = "–ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞–ª—É–¥–∞...";
                    exportData(STORE_APARTMENTS);
                    ioMessage.textContent = "–ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Å”ô—Ç—Ç—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞–ª–¥—ã.";
                });
                exportPaymentsBtn.addEventListener('click', () => {
                    ioMessage.textContent = "–¢”©–ª–µ–º —Ç–∞—Ä–∏—Ö—ã —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞–ª—É–¥–∞...";
                    exportData(STORE_PAYMENTS);
                    ioMessage.textContent = "–¢”©–ª–µ–º —Ç–∞—Ä–∏—Ö—ã —Å”ô—Ç—Ç—ñ —ç–∫—Å–ø–æ—Ä—Ç—Ç–∞–ª–¥—ã.";
                });


            } catch (error) {
                messageElement.textContent = `–ë–∞—Å—Ç–∞–ø“õ—ã –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }

        async function handleCalculation() {
            const month = parseInt(monthSelect.value);
            const year = parseInt(yearInput.value);
            
            messageElement.textContent = `${MONTHS[month - 1]} ${year} “Ø—à—ñ–Ω –µ—Å–µ–ø—Ç–µ—É –±–∞—Å—Ç–∞–ª—É–¥–∞...`;
            resultsTableBody.innerHTML = ''; 

            try {
                const results = await calculateMonthlyCharges(month, year);
                renderResults(results);
                messageElement.textContent = `${MONTHS[month - 1]} ${year} “Ø—à—ñ–Ω –µ—Å–µ–ø—Ç–µ—É —Å”ô—Ç—Ç—ñ –∞—è“õ—Ç–∞–ª–¥—ã.`;
            } catch (error) {
                messageElement.textContent = `–ï—Å–µ–ø—Ç–µ—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }

        function renderResults(results) {
            currentCalculation = results; 
            resultsTableBody.innerHTML = ''; 
            
            results.forEach(item => {
                const row = resultsTableBody.insertRow();
                const currentBalanceDisplay = parseFloat(item.previousBalance) || 0; 
                
                row.innerHTML = `
                    <td>${item.flatNumber}</td>
                    <td>${item.area}</td>
                    <td>${formatCurrency(item.breakdown['SD'] || 0)}</td>
                    <td>${formatCurrency(item.breakdown['UB'] || 0)}</td>
                    <td>${formatCurrency(item.breakdown['VN'] || 0)}</td>
                    <td><strong>${formatCurrency(item.totalCharge)}</strong></td>
                    <td>${formatCurrency(currentBalanceDisplay)}</td>
                    <td><strong>${formatCurrency(item.amountDue)}</strong></td>
                    <td>
                        <button onclick="window.generateReceipt(${item.flatNumber}, ${item.month}, ${item.year})">–¢“Ø–±—ñ—Ä—Ç–µ–∫</button>
                        <button onclick="window.openPaymentModal(${item.flatNumber})">–¢”©–ª–µ–º</button>
                    </td>
                `;
            });
        }
        
        window.openPaymentModal = (flatNumber) => {
            selectedFlatData = currentCalculation.find(item => item.flatNumber === flatNumber);
            
            if (!selectedFlatData) {
                alert("–ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–∞–±—ã–ª–º–∞–¥—ã. –ê–ª–¥—ã–º–µ–Ω –∞–π–ª—ã“õ –µ—Å–µ–ø—Ç–µ—É–¥—ñ —ñ—Å–∫–µ “õ–æ—Å—ã“£—ã–∑.");
                return;
            }

            document.getElementById('modal-flat-number').textContent = flatNumber;
            document.getElementById('modal-amount-due').textContent = formatCurrency(selectedFlatData.amountDue);
            paidAmountInput.value = selectedFlatData.amountDue.toFixed(2); 
            modalMessage.textContent = '';
            paymentModal.style.display = 'block';
        };

        async function handleRecordPayment() {
            if (!selectedFlatData) return;
            
            const paidAmount = parseFloat(paidAmountInput.value);
            const paymentDate = document.getElementById('payment-date').value;
            const balanceChange = selectedFlatData.amountDue - paidAmount; 

            if (isNaN(paidAmount) || paidAmount < 0) {
                modalMessage.textContent = "–¢”©–ª–µ–Ω–≥–µ–Ω —Å–æ–º–∞ –¥“±—Ä—ã—Å –µ–Ω–≥—ñ–∑—ñ–ª–º–µ–≥–µ–Ω.";
                return;
            }

            const paymentRecord = {
                flatId: selectedFlatData.flatId,
                flatNumber: selectedFlatData.flatNumber,
                month: selectedFlatData.month,
                year: selectedFlatData.year,
                amountBilled: selectedFlatData.totalCharge,
                previousBalance: selectedFlatData.previousBalance, 
                amountDue: selectedFlatData.amountDue, 
                paidAmount: paidAmount,                   
                datePaid: paymentDate,
                balanceAfter: balanceChange 
            };

            try {
                const newBalance = await recordPayment(paymentRecord, balanceChange); 
                modalMessage.textContent = `–¢”©–ª–µ–º —Å”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ–ª–¥—ñ. –ñ–∞“£–∞ –±–∞–ª–∞–Ω—Å: ${formatCurrency(newBalance)}.`;
                
                await handleCalculation(); 
                setTimeout(() => paymentModal.style.display = 'none', 2000);
                
            } catch (error) {
                modalMessage.textContent = `–¢”©–ª–µ–º–¥—ñ —Å–∞“õ—Ç–∞—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }
        
        async function handleImportApartments() {
            const file = apartFile.files[0];
            if (!file) {
                ioMessage.textContent = "–ò–º–ø–æ—Ä—Ç—Ç–∞—É “Ø—à—ñ–Ω CSV —Ñ–∞–π–ª—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑.";
                return;
            }
            
            ioMessage.textContent = "–ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –∏–º–ø–æ—Ä—Ç—Ç–∞–ª—É–¥–∞...";
            try {
                const count = await importApartments(file);
                ioMessage.textContent = `–°”ô—Ç—Ç—ñ –∏–º–ø–æ—Ä—Ç—Ç–∞–ª–¥—ã: ${count} –∂–∞–∑–±–∞.`;
                await handleCalculation(); 
            } catch (error) {
                ioMessage.textContent = `–ò–º–ø–æ—Ä—Ç—Ç–∞—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }
        
        initialize();
    </script>
</body>
</html>
