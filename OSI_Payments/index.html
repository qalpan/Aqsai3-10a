<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–ò–ë/–û–°–ò –¢”©–ª–µ–º –ñ“Ø–π–µ—Å—ñ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üè† –ú–ò–ë/–û–°–ò –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ –ë–∞—Å“õ–∞—Ä—É –ñ“Ø–π–µ—Å—ñ (–ê–≤—Ç–æ–Ω–æ–º–¥—ã)</h1>
    </header>

    <main>
        <section class="controls">
            <h2>–ï—Å–µ–ø—Ç–µ—É–¥—ñ –ë–∞—Å—Ç–∞—É</h2>
            <div class="input-group">
                <label for="calc-month">–ê–π:</label>
                <select id="calc-month"></select>
                <label for="calc-year">–ñ—ã–ª:</label>
                <input type="number" id="calc-year" value="2025" min="2020" max="2030">
                <button id="calculate-btn">–ê–π–ª—ã“õ –¢”©–ª–µ–º–¥—ñ –ï—Å–µ–ø—Ç–µ—É</button>
            </div>
            <p id="message" class="status-message"></p>

            <hr style="margin: 20px 0;">
            
            <h2>–ñ—ã–ª–¥—ã“õ –ï—Å–µ–ø –ë–µ—Ä—É</h2>
            <div class="input-group">
                <label for="report-flat-number">–ü”ô—Ç–µ—Ä ‚Ññ:</label>
                <input type="number" id="report-flat-number" min="1">
                <label for="report-year">–ñ—ã–ª:</label>
                <input type="number" id="report-year" value="2025" min="2020" max="2030">
                <button id="generate-report-btn">–ï—Å–µ–ø –ë–µ—Ä—É</button>
            </div>

            <hr style="margin: 20px 0;">

            <h2>–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –ë–∞—Å“õ–∞—Ä—É (CSV)</h2>
            <div class="io-controls">
                <div class="input-group">
                    <label for="apart-file">–ü”ô—Ç–µ—Ä–ª–µ—Ä (CSV) –ò–º–ø–æ—Ä—Ç—Ç–∞—É:</label>
                    <input type="file" id="apart-file" accept=".csv">
                    <button id="import-apart-btn">–ò–º–ø–æ—Ä—Ç—Ç–∞—É</button>
                </div>
                <div class="input-group">
                    <button id="export-apart-btn">–ü”ô—Ç–µ—Ä–ª–µ—Ä–¥—ñ –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É</button>
                    <button id="export-payments-btn">–¢”©–ª–µ–º–¥–µ—Ä–¥—ñ –≠–∫—Å–ø–æ—Ä—Ç—Ç–∞—É</button>
                </div>
                <p id="io-message" class="status-message"></p>
            </div>
        </section>

        <section class="results">
            <h2>–ï—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –¢”©–ª–µ–º–¥–µ—Ä</h2>
            <table id="payments-table">
                <thead>
                    <tr>
                        <th>–ü”ô—Ç–µ—Ä ‚Ññ</th>
                        <th>–ê–ª–∞“£—ã (–º¬≤)</th>
                        <th>–ê–π–ª—ã“õ –°–æ–º–∞</th>
                        <th>–ê–ª–¥—ã“£“ì—ã “ö–∞—Ä—ã–∑/–ê—Ä—Ç—ã“õ —Ç”©–ª–µ–º</th>
                        <th>–¢”©–ª–µ—É–≥–µ –ñ–∞—Ç–∞—Ç—ã–Ω –°–æ–º–∞</th>
                        <th>”ò—Ä–µ–∫–µ—Ç</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </section>
        
        <div id="receipt-output" class="print-only"></div>

    </main>

    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>–¢”©–ª–µ–º–¥—ñ –¢—ñ—Ä–∫–µ—É</h3>
            <p><strong>–ü”ô—Ç–µ—Ä:</strong> <span id="modal-flat-number"></span></p>
            <p><strong>–ú–µ—Ä–∑—ñ–º:</strong> <span id="modal-month-year"></span></p>
            <p><strong>–¢”©–ª–µ—É–≥–µ –∂–∞—Ç–∞—Ç—ã–Ω —Å–æ–º–∞:</strong> <span id="modal-amount-due"></span></p>
            
            <label for="paid-amount">–¢”©–ª–µ–Ω–≥–µ–Ω —Å–æ–º–∞:</label>
            <input type="number" id="paid-amount" step="0.01">
            
            <button id="record-payment-btn">–¢”©–ª–µ–º–¥—ñ –°–∞“õ—Ç–∞—É</button>
            <p id="modal-message" class="status-message"></p>
        </div>
    </div>

    <script type="module">
        // “ö–∞–∂–µ—Ç—Ç—ñ —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä–¥—ã ”ô—Ä —Ñ–∞–π–ª–¥–∞–Ω –∏–º–ø–æ—Ä—Ç—Ç–∞—É
        import { openDB, initializeTariffs, recordPayment, getApartmentByNumber, STORE_APARTMENTS, STORE_PAYMENTS, STORE_TARIFFS } from './js/db.js';
        import { calculateMonthlyCharges } from './js/calculator.js';
        import { importApartments, exportData } from './js/data-io.js';
        import { generateReceipt } from './js/receipt-generator.js';
        import { generateYearlyReport } from './js/yearly-report.js';

        // –≠–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä–¥—ñ —Ç–∞“£–¥–∞—É
        const calcMonth = document.getElementById('calc-month');
        const calcYear = document.getElementById('calc-year');
        const calculateBtn = document.getElementById('calculate-btn');
        const messageElement = document.getElementById('message');
        const paymentsTableBody = document.querySelector('#payments-table tbody');
        
        const reportFlatNumber = document.getElementById('report-flat-number');
        const reportYear = document.getElementById('report-year');
        const generateReportBtn = document.getElementById('generate-report-btn');
        
        const apartFile = document.getElementById('apart-file');
        const importApartBtn = document.getElementById('import-apart-btn');
        const exportApartBtn = document.getElementById('export-apart-btn');
        const exportPaymentsBtn = document.getElementById('export-payments-btn');
        const ioMessage = document.getElementById('io-message');

        const paymentModal = document.getElementById('payment-modal');
        const closeBtn = paymentModal.querySelector('.close-btn');
        const recordPaymentBtn = document.getElementById('record-payment-btn');
        const paidAmountInput = document.getElementById('paid-amount');
        const modalFlatNumber = document.getElementById('modal-flat-number');
        const modalMonthYear = document.getElementById('modal-month-year');
        const modalAmountDue = document.getElementById('modal-amount-due');
        const modalMessage = document.getElementById('modal-message');

        const MONTHS_NAMES = ["“ö–∞“£—Ç–∞—Ä", "–ê“õ–ø–∞–Ω", "–ù–∞—É—Ä—ã–∑", "–°”ô—É—ñ—Ä", "–ú–∞–º—ã—Ä", "–ú–∞—É—Å—ã–º", "–®—ñ–ª–¥–µ", "–¢–∞–º—ã–∑", "“ö—ã—Ä–∫“Ø–π–µ–∫", "“ö–∞–∑–∞–Ω", "“ö–∞—Ä–∞—à–∞", "–ñ–µ–ª—Ç–æ“õ—Å–∞–Ω"];
        let currentCharges = []; 

        const formatCurrency = (amount) => new Intl.NumberFormat('kk-KZ', {
            style: 'currency',
            currency: 'KZT',
            minimumFractionDigits: 2
        }).format(amount);

        // ******************************************************
        // –Ü–°–ö–ï “ö–û–°–£ –ñ”ò–ù–ï UI –§–£–ù–ö–¶–ò–Ø–õ–ê–†–´
        // ******************************************************

        /**
         * –ê–π–ª–∞—Ä —Ç—ñ–∑—ñ–º—ñ–Ω —Ç–æ–ª—Ç—ã—Ä–∞–¥—ã
         */
        function populateMonthSelect(selectElement) {
            if (!selectElement) return;
            
            MONTHS_NAMES.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                selectElement.appendChild(option);
            });
            const currentMonth = new Date().getMonth() + 1;
            selectElement.value = currentMonth;
        }

        /**
         * –¢”©–ª–µ–º–¥–µ—Ä–¥—ñ –µ—Å–µ–ø—Ç–µ—É–¥—ñ —ñ—Å–∫–µ “õ–æ—Å–∞–¥—ã
         */
        async function handleCalculation() {
            const month = parseInt(calcMonth.value);
            const year = parseInt(calcYear.value);
            
            messageElement.textContent = `–ü”ô—Ç–µ—Ä–ª–µ—Ä “Ø—à—ñ–Ω ${MONTHS_NAMES[month - 1]} ${year} –∂—ã–ª—ã–Ω–∞ —Ç”©–ª–µ–º–¥–µ—Ä –µ—Å–µ–ø—Ç–µ–ª—É–¥–µ...`;

            try {
                currentCharges = await calculateMonthlyCharges(month, year);
                renderPaymentsTable(currentCharges);
                messageElement.textContent = `–¢”©–ª–µ–º–¥–µ—Ä ${MONTHS_NAMES[month - 1]} ${year} –∂—ã–ª—ã–Ω–∞ —Å”ô—Ç—Ç—ñ –µ—Å–µ–ø—Ç–µ–ª–¥—ñ.`;
                messageElement.style.display = 'block';
            } catch (error) {
                messageElement.textContent = `–ï—Å–µ–ø—Ç–µ—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                messageElement.style.display = 'block';
                console.error("–ï—Å–µ–ø—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", error);
            }
        }

        /**
         * –¢”©–ª–µ–º–¥–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ–Ω DOM-–¥–∞ –∫”©—Ä—Å–µ—Ç–µ–¥—ñ
         */
        function renderPaymentsTable(charges) {
            paymentsTableBody.innerHTML = '';
            charges.forEach(charge => {
                const row = paymentsTableBody.insertRow();
                const apartment = { sqm: 0 }; // –ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ–Ω–µ “õ–æ–ª –∂–µ—Ç–∫—ñ–∑—É –ª–æ–≥–∏–∫–∞—Å—ã–Ω “õ–æ—Å—É “õ–∞–∂–µ—Ç
                
                // “ö–∞—Ä–∞–ø–∞–π—ã–º: –ü”ô—Ç–µ—Ä –∞–ª–∞“£—ã–Ω –¥“±—Ä—ã—Å –∫”©—Ä—Å–µ—Ç—É “Ø—à—ñ–Ω DB-–¥–µ–Ω —Ç–æ–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∞–ª—É –∫–µ—Ä–µ–∫ –Ω–µ–º–µ—Å–µ charge –æ–±—ä–µ–∫—Ç—ñ—Å—ñ–Ω–µ “õ–æ—Å—É –∫–µ—Ä–µ–∫
                // “ö–∞–∑—ñ—Ä—à–µ '–ê–ª–∞“£—ã (–º¬≤)' –±–∞“ì–∞–Ω—ã–Ω –∞–ª—ã–ø —Ç–∞—Å—Ç–∞—É“ì–∞ –±–æ–ª–∞–¥—ã –Ω–µ–º–µ—Å–µ –º”ô–Ω–¥—ñ '-' –¥–µ–ø –∫”©—Ä—Å–µ—Ç—É–≥–µ –±–æ–ª–∞–¥—ã.
                
                row.innerHTML = `
                    <td>${charge.flatNumber}</td>
                    <td>-</td>
                    <td>${formatCurrency(charge.totalCharge)}</td>
                    <td style="color: ${charge.previousBalance < 0 ? 'green' : 'red'};">${formatCurrency(charge.previousBalance)}</td>
                    <td style="font-weight: bold;">${formatCurrency(charge.amountDue)}</td>
                    <td>
                        <button class="receipt-btn" data-flat="${charge.flatNumber}" data-month="${charge.month}" data-year="${charge.year}">–¢“Ø–±—ñ—Ä—Ç–µ–∫</button>
                        <button class="pay-btn" data-flat="${charge.flatNumber}">–¢”©–ª–µ–º</button>
                    </td>
                `;
            });
        }
        
        /**
         * –¢”©–ª–µ–º –º–æ–¥–∞–ª—å–¥—ã —Ç–µ—Ä–µ–∑–µ—Å—ñ–Ω –∞—à–∞–¥—ã
         */
        function openPaymentModal(flatNumber) {
            const charge = currentCharges.find(c => c.flatNumber === flatNumber);
            if (!charge) return;
            
            paymentModal.dataset.flatNumber = flatNumber;
            paymentModal.dataset.month = charge.month;
            paymentModal.dataset.year = charge.year;
            
            modalFlatNumber.textContent = flatNumber;
            modalMonthYear.textContent = `${MONTHS_NAMES[charge.month - 1]} ${charge.year}`;
            modalAmountDue.textContent = formatCurrency(charge.amountDue);
            paidAmountInput.value = charge.amountDue.toFixed(2);
            modalMessage.textContent = '';
            
            paymentModal.style.display = 'block';
        }

        /**
         * –¢”©–ª–µ–º–¥—ñ —Å–∞“õ—Ç–∞—É–¥—ã –±–∞—Å“õ–∞—Ä–∞–¥—ã
         */
        async function handleRecordPayment() {
            const flatNumber = parseInt(paymentModal.dataset.flatNumber);
            const month = parseInt(paymentModal.dataset.month);
            const year = parseInt(paymentModal.dataset.year);
            const paidAmount = parseFloat(paidAmountInput.value);

            if (isNaN(paidAmount) || paidAmount < 0) {
                modalMessage.textContent = "–î“±—Ä—ã—Å —Å–æ–º–∞–Ω—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.";
                return;
            }

            modalMessage.textContent = "–¢”©–ª–µ–º —Ç—ñ—Ä–∫–µ–ª—É–¥–µ...";

            try {
                const charge = currentCharges.find(c => c.flatNumber === flatNumber);
                if (!charge) throw new Error("–ï—Å–µ–ø—Ç–µ—É –∂–∞–∑–±–∞—Å—ã —Ç–∞–±—ã–ª–º–∞–¥—ã.");

                const paymentRecord = {
                    flatNumber: flatNumber,
                    month: month,
                    year: year,
                    paidAmount: paidAmount,
                    datePaid: new Date().toISOString(),
                    totalCharge: charge.totalCharge,
                    amountDue: charge.amountDue
                };
                
                // –ë–∞–ª–∞–Ω—Å—Ç—ã“£ ”©–∑–≥–µ—Ä—É—ñ: (–¢”©–ª–µ–Ω–≥–µ–Ω —Å–æ–º–∞) - (–¢”©–ª–µ—É–≥–µ –∂–∞—Ç–∞—Ç—ã–Ω —Å–æ–º–∞)
                const balanceChange = paidAmount - charge.amountDue;

                const newBalance = await recordPayment(paymentRecord, balanceChange); 
                modalMessage.textContent = `–¢”©–ª–µ–º —Å”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ–ª–¥—ñ. –ñ–∞“£–∞ –±–∞–ª–∞–Ω—Å: ${formatCurrency(newBalance)}.`;
                
                await handleCalculation();
                setTimeout(() => paymentModal.style.display = 'none', 2000);
                
            } catch (error) {
                modalMessage.textContent = `–¢”©–ª–µ–º–¥—ñ —Å–∞“õ—Ç–∞—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }
        
        /**
         * –ò–º–ø–æ—Ä—Ç—Ç—ã –±–∞—Å“õ–∞—Ä—É
         */
        async function handleImportApartments() {
            const file = apartFile.files[0];
            if (!file) {
                ioMessage.textContent = "–ò–º–ø–æ—Ä—Ç—Ç–∞—É “Ø—à—ñ–Ω CSV —Ñ–∞–π–ª—ã–Ω —Ç–∞“£–¥–∞“£—ã–∑.";
                return;
            }
            
            ioMessage.textContent = "–ü”ô—Ç–µ—Ä –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –∏–º–ø–æ—Ä—Ç—Ç–∞–ª—É–¥–∞...";
            try {
                const count = await importApartments(file);
                ioMessage.textContent = `–°”ô—Ç—Ç—ñ –∏–º–ø–æ—Ä—Ç—Ç–∞–ª–¥—ã: ${count} –∂–∞–∑–±–∞.`;
                await handleCalculation(); 
            } catch (error) {
                ioMessage.textContent = `–ò–º–ø–æ—Ä—Ç—Ç–∞—É “õ–∞—Ç–µ—Å—ñ: ${error.message}`;
                console.error(error);
            }
        }

        // ******************************************************
        // –û“ö–ò“í–ê –¢–´“¢–î–ê–£–®–´–õ–ê–†–´ –ñ”ò–ù–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ******************************************************
        
        document.addEventListener('DOMContentLoaded', async () => {
            // ‚úÖ 1. –ê–π–ª–∞—Ä–¥—ã —Ç–æ–ª—Ç—ã—Ä—É - –ë“±–ª –∞–π–ª–∞—Ä —Ç—ñ–∑—ñ–º—ñ–Ω –º—ñ–Ω–¥–µ—Ç—Ç—ñ —Ç“Ø—Ä–¥–µ —à—ã“ì–∞—Ä—É—ã –∫–µ—Ä–µ–∫.
            populateMonthSelect(calcMonth);
            
            // 2. –î–ë –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è—Å—ã–Ω –±–∞—Å—Ç–∞—É
            try {
                await openDB(); 
                await initializeTariffs();
                // 3. ”ò–¥–µ–ø–∫—ñ –µ—Å–µ–ø—Ç–µ—É–¥—ñ —ñ—Å–∫–µ “õ–æ—Å—É
                await handleCalculation(); 
            } catch (error) {
                 console.error("–ñ“Ø–π–µ–Ω—ñ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è–ª–∞—É “õ–∞—Ç–µ—Å—ñ:", error);
                 messageElement.textContent = `–ñ“Ø–π–µ —ñ—Å–∫–µ “õ–æ—Å—ã–ª–º–∞–¥—ã. –ö–æ–Ω—Å–æ–ª—å–¥—ñ —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.`;
            }
        });

        // –ë–∞—Ç—ã—Ä–º–∞ –æ“õ–∏“ì–∞–ª–∞—Ä—ã
        calculateBtn.addEventListener('click', handleCalculation);
        importApartBtn.addEventListener('click', handleImportApartments);
        exportApartBtn.addEventListener('click', () => exportData(STORE_APARTMENTS));
        exportPaymentsBtn.addEventListener('click', () => exportData(STORE_PAYMENTS));
        recordPaymentBtn.addEventListener('click', handleRecordPayment);
        
        // –ú–æ–¥–∞–ª—å–¥—ã –∂–∞–±—É
        closeBtn.addEventListener('click', () => paymentModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target === paymentModal) {
                paymentModal.style.display = 'none';
            }
        });
        
        // –ö–µ—Å—Ç–µ–¥–µ–≥—ñ ”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä
        paymentsTableBody.addEventListener('click', (e) => {
            const flatNumber = parseInt(e.target.dataset.flat);
            const month = parseInt(e.target.dataset.month);
            const year = parseInt(e.target.dataset.year);

            if (e.target.classList.contains('pay-btn')) {
                openPaymentModal(flatNumber);
            } else if (e.target.classList.contains('receipt-btn')) {
                generateReceipt(flatNumber, month, year);
            }
        });
        
        // –ñ—ã–ª–¥—ã“õ –µ—Å–µ–ø –±–µ—Ä—É
        generateReportBtn.addEventListener('click', () => {
            const flat = parseInt(reportFlatNumber.value);
            const year = parseInt(reportYear.value);
            if (isNaN(flat) || isNaN(year)) {
                alert("–ü”ô—Ç–µ—Ä –Ω”©–º—ñ—Ä—ñ–Ω –∂”ô–Ω–µ –∂—ã–ª–¥—ã –¥“±—Ä—ã—Å –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑.");
                return;
            }
            generateYearlyReport(flat, year);
        });
    </script>
</body>
</html>
